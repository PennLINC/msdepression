---
title: "MS Regressions"
author: "Erica Baller"
date: "11/18/2021"
output:
  html_document: default
  pdf_document: default
---



## Dac summary

Welcome to the MS project! This is a really exciting project dedicated to understanding psychopathology, particular depression in patients with MS. It is unqiue in a variety of ways, primarily that it uses clinical images that are research grade.

The team so far is big.
PIs- Ted Satterthwaite and Taki Shinohara
Senior Scientists - Azeez Adebimpe and Matt Cieslak
Research Specialist- Timothy Robert-Fitzgerald
Graduate students - Melissa Martin
Data Analysist - Sidney Covitz
Collaborators - Aaron Alexander-Bloch and Jenna Young
DAC Pull done by - Victoria Rautman(2020/2021) and Sunil Thomas (2018)

Date of FINAL Pull: 1/19/2021
Spreadsheet: /Users/eballer/BBL/msdepression/data/dac/investigatingdepressioninmspatients_dates_right_format.csv 
Summary of request to Victoria @ DAC:
---
9/2/2020

DAC Request
Non-funded IRB Approved Research  (enter IRB number): 843669
Criteria	Display?	Description / Exclusions / Limitations / Filters
MRN	Y	Unique identifier requested, but can be masked MRN
Visit ID	Y	
Patient Class(es)
Please select only which class(es) you will need.		x  Inpatient
 X   Outpatient
x  Emergency
Age or DOB ranges	Y	
Gender	Y	
Race	Y	
Department(s)
Provide department numbers not just names.	N	
Provider(s)
Provide ID’s not just names.	N	
Date(s)
Include in the specific range and date types (eg, admit, order, result)	1/1/2010-
12/31/20	All scans based on date of first treatment with glatiramer acetate
Procedure
Please include the specific procedure codes.  (ICD9/ICD10 is preferred for inpatient)	Y	88.91 (Magnetic Resonance Imaging of Brain)

Diagnosis
Please include the specific ICD-9/ICD-10 codes including all decimal points. Do not simply include ranges or wildcards.	Y	Multiple sclerosis (ICD-9: 340; ICD-10: G35), Depressive disorders (ICD-9: 296.99, 296.21, 296.22, 296.23, 296.24, 296.25, 296.26, 296.20, 296.31, 296.32, 296.33, 296.34, 296.35, 296.26, 296.30, 300.4, 293.83, 311, ICD-10: F32.0, F32.1, F32.2, F32.3, F32.4, F32.5, F32.6, F33.0, F33.1, F33.2, F33.41, F33.42, F33.9, F34.1, F06.31, F06.32, F06.34, F32.8, F32.9, major depressive disorder, persistent depressive disorder, depressive disorder due to another medical condition, other specified depressive disorder, unspecified depressive disorder)
Orders	N	
Medication
Please list as it is ordered within the UPHS EMR’s – medication id’s preferred	Y	Glatiramer Acetate (Copaxone)
Lab Result
Please list the lab as it is ordered within the UPHS EMR’s.	Y	
Other	Y	EDSS scores (if present)
Other	Y	All medications patients are receiving
Other	Y	All PACS accession numbers available
Other	Y	PHQ-2 and PHQ-9 if present
---
9/16/2020:
Per her note to me: We also specified that we wanted to pull images with ORIG_CPT values of 70551, 70552, 70553, MHDI, IMGMR0128, and we wanted scans with department ID 361, 547, 6004, or 6013. And I may have mentioned this before but the ICD9 and ICD10 codes for MS patients are 340 and G35, respectively
 
*For us, we are additionally interested in ALL ICD9/10 codes, ALL medications they are on at the time of scan, specific labs (as indicated), EDSS , PHQ-9 and 2 scores. The particular reason for this is that we are going to be looking at the relationship of brain imaging to depression in the MS group.

Mock columns: DE_PAT_ID	PAT_ID	EMPI	HUP_MRN	PAT_NM_WMRN	SEX	RACE	ETHNIC_GROUP	ORDER_ID	ORDERING_DTTM	BEGIN_EXAM_DTTM	END_EXAM_DTTM	TECH_USER_ID	TECHNOLOGIST	ACCESSION_NUM	PROC_ID	PROC_NAME	PROC_CODE	ORIG_CPT	PERFORMING_CSN_ID	COVERAGE_ID	FIN_CLASS_NAME	VISIT_EPM_ID	PERFORMING_DEP_ID	DEPARTMENT_NAME	MODALITY	ASSOCIATED_ICD9	ASSOCIATED_ICD10	PAT_AGE_AT_EXAM	MRI_ENC_AGE	CURRENT_AGE	All ICD-9 or 10 codes	All medication codes	wbc	rbc	hemoglobin	csf studies…	phq-9 score (and date)	phq-2 score (and date)	b12	folate 	TSH	RPR Vit D



---
 1/8/2021 email update (me to Victoria Rautman):
 What we realized is that the best way to define inclusion for the MS group is to focus on people who were seen at some point in neurology clinic.
 
If you’d be so kind, I’d be grateful for *hopefully the last pull. We would use the previous one, but instead of using the ICD 9/10 codes associated with the actual scan, we would use the location of clinic visits, and pull ALL scans, before or after diagnosis.

New updates:
 -Pull all the scans for patients who have ever been seen by “NEUROLOGY SOUTH PAVILLION” and “NEUROLOGY HUP” departments for clinic. 
 
-Please include provider name associated with these department visits. 
 
-Don’t worry about doing exclusions based on ICD9/10 codes for the scans themselves, please include all and we will sort through it ourselves
 
***Please also include vitamin D levels in addition to other labs***
 
The rest of the query would be the same as the most recent query you sent back.
---

Radiology sent images to Taki and group 4/2021

This script goes through data that has been returned from the DAC on 1/19 and summarizes it
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(visreg)
library(lme4)
library(lmerTest)
library(ggplot2)
library(reshape2)
#functions
source("~/BBL/msdepression/scripts/msdepression_functions.R")
```

```{r depression_vs_healthy_melissa_qc_group}

homedir <- "/Users/eballer/BBL/msdepression/"



##########################################################
####                   Prepare the date               ####
##########################################################
#load our df

#from Jan 2021 pull
data <- read.csv(paste0(homedir,"/data/dac/investigatingdepressioninmspatients_dates_right_format.csv"), header = TRUE, stringsAsFactors = FALSE, na.strings = c("NULL"), sep =",")

ms_providers <- c("MARKOWITZ, CLYDE E.", "JACOBS, DINA A.", "WILLIAMSON, ERIC MICHAEL-LEE", "BERGER, JOSEPH ROBERT", "BERGER DO, JOSEPH", "PRUITT, AMY A.", "KOLSON, DENNIS L.", "CHAHIN, SALIM", "NARULA, SONA", "BAR-OR, AMIT")

columns_to_make_integer <- c("ACCESSION_NUM", "PAT_AGE_AT_EXAM","MRI_ENC_AGE","CURRENT_AGE","hemoglobin", "WBC","RBC","B12","FOLATE", "TSH", "RPR","CSFAPPEAR1","CSFAPPEAR4","CSFCOLOR1",       "CSFCOLOR4","CSFTUBE","CSFTUBE4","VitD","PHQ.2","PHQ.9")

##########################
### some preprocessing ###
##########################
#we need to keep scans from people seen by an MS provider (n = 17067) who have an MS diagnostic code (n=16,830)
#we make a bunch of columns from character to integer, binarize sex and race, and put date into a nice format YYYYMMDD, the %m%d%y indicates what it started out as

#goal is to keep people who were seen by 
 data_empi_acc_f_phq <- data %>% 
   filter(Provider %in% ms_providers) %>%       #n=17,067
   filter(grepl("G35", ICD10)) %>%              #n=16830
   mutate(across(.cols = columns_to_make_integer, .fns = as.integer)) %>%
   mutate(sex_binarized = ifelse(SEX == "MALE", 1, 2)) %>%
   mutate(osex = ordered(sex_binarized,levels = c(1,2), labels = c("Male","Female"))) %>%
   mutate(race_binarized = ifelse(RACE == "WHITE", 1, 2)) %>%
   mutate(orace = ordered(race_binarized,levels = c(1,2), labels = c("White","Non-white"))) %>%
   mutate(EXAM_DATE = as.Date(BEGIN_EXAM_DTTM, format = "%m/%d/%y")) %>% 
   mutate(EXAM_DATE = gsub(EXAM_DATE, pattern = "-", replacement = "")) %>%
   mutate(EMPI = as.factor(EMPI))

##########################################################
#### Step 1- make F3* depressed and healthy groups* ######
##########################################################
  ### This is identical to up above, but repeated so I can run this chunk separately

########
### separate out depressed group
########
print("separate out depressed group")
dep_df <- data_empi_acc_f_phq %>% filter(grepl("F3", ICD10)) #n = 2123
num_depression <- dim(dep_df)[1]
num_unique_EMPI_and_dep <- length(unique(dep_df$EMPI)) #n = 493
print(paste0("N with ICD 9/10 codes for depression = ", num_depression))
print(paste0("N with ICD 9/10 codes for depression and unique EMPI in whole depression group = ", num_unique_EMPI_and_dep, " out of ", num_depression))

#find number of participants who meet criteria for depression in the PHQ2/9 symptom rating
print(paste0("N with ICD 9/10 codes for depression, PHQ2 >= 3, unique = ", length(!is.na(unique(dep_df$EMPI[dep_df$PHQ.2 >= 3]))))) #n=23
print(paste0("N with ICD 9/10 codes for depression, PHQ9 >= 10, unique = ", length(!is.na(unique(dep_df$EMPI[dep_df$PHQ.9 >= 10])))))#n=26


#######
### separate out healthy group
#######
print("separate out healthy group")
healthy_df <- data_empi_acc_f_phq %>% filter(!grepl("F3", ICD10)) #n = 14707
num_healthy <- dim(healthy_df)[1] 
num_unique_EMPI_and_healthy <- length(unique(healthy_df$EMPI)) #n = 3244
print(paste0("N with WITHOUT depression ICD 9/10 codes (i.e. \"healthy\"): ", num_healthy))
print(paste0("N with WITHOUT ICD 9/10 depression codes for depression and unique EMPI = ", num_unique_EMPI_and_healthy, " out of ", num_healthy))

##########################################################
#### Step 2- Identify PHQ2 >=3 in healthy group     ######
##########################################################

print("Get people in healthy group with phq2s for dep/healthy")
# num in healthy group with PHQ2
phq2_subset <- healthy_df %>% filter(!is.na(PHQ.2)) #n=3646, unique 698
depressed_phq2_subset <- phq2_subset %>% filter(PHQ.2 >= 3) #n = 47 
depressed_unique_phq2_empis <- unique(depressed_phq2_subset$EMPI) #n=10
healthy_phq2_subset <- phq2_subset %>% filter(PHQ.2 == 0) #n = 3326
healthy_unique_phq2_empis <- unique(healthy_phq2_subset$EMPI) #n = 631

print(paste0("PHQ2 breakdown in healthy group (total n with score = ", dim(phq2_subset)[1], "[unique = ", length(unique(phq2_subset$EMPI)),"]): PHQ2 >= 3 :", dim(depressed_phq2_subset)[1], "[unique = ", length(depressed_unique_phq2_empis), "]; PHQ2 == 0 : ", dim(healthy_phq2_subset)[1], "[unique = ", length(healthy_unique_phq2_empis),"]")) #PHQ2 breakdown in healthy group (total n with score = 3646[unique = 698]): PHQ2 >= 3 :47[unique = 10]; PHQ2 == 0 : 3326[unique = 631]


##########################################################
#### Step 3- Identify PHQ9 >=10 in healthy group    ######
##########################################################

print("Get people in healthy group with phq9s for dep/healthy")
# num in healthy group with PHQ9
phq9_subset <- healthy_df %>% filter(!is.na(PHQ.9)) #n=121 (unique 5)
depressed_phq9_subset <- phq9_subset %>% filter(PHQ.9 >= 10) #n = 32 
depressed_unique_phq9_empis <- unique(depressed_phq9_subset$EMPI) #n=9
healthy_phq9_subset <- phq9_subset %>% filter(PHQ.9 == 0) #n = 21
healthy_unique_phq9_empis <- unique(healthy_phq9_subset$EMPI) #n = 4

print(paste0("PHQ9 breakdown in healthy group (total n with score = ", dim(phq9_subset)[1], "[unique = ", length(unique(phq9_subset$EMPI)),"]): PHQ9 >= 10 :", dim(depressed_phq9_subset)[1], "[unique = ", length(depressed_unique_phq9_empis), "]; PHQ9 == 0 : ", dim(healthy_phq9_subset)[1], "[unique = ", length(unique(healthy_phq9_subset$EMPI)),"]"))


##########################################################
#Step 4 - Combine for depressed group and healthy groups #
##########################################################

print("Combine groups for new cohort")
gain_in_dep_group <- length(depressed_unique_phq2_empis) + length(depressed_unique_phq9_empis)
dep_num_icd10_plus_phq2_and_phq9 <- num_unique_EMPI_and_dep + gain_in_dep_group # we can do this because we know they are each exclusive - num_unique_empi_and_dep from icd10 group, and no overlap in phq2 and 9 group
print(paste0("number of UNIQUE people with an icd10 code for Depression OR scored positive on PHQ2(>=3) or PHQ9(>=10) : ", dep_num_icd10_plus_phq2_and_phq9, ", for a gain of n = ", gain_in_dep_group))

healthy_num_no_icd10_plus_phq2_and_phq9 <- num_unique_EMPI_and_healthy - gain_in_dep_group #take number of people who don't have depression diagnosis and don't have a depression phq2/9

print(paste0("number of people with NO icd10 code for Depression and NEVER had a PHQ2(>=3) or PHQ9(>=10) : ", healthy_num_no_icd10_plus_phq2_and_phq9, ", for a loss of n = ", gain_in_dep_group))

healthy_num_no_icd10_plus_phq2_and_phq9_MUST_HAVE_PHQ2_OR_9 <- length(healthy_unique_phq2_empis) + length(healthy_unique_phq9_empis)
print(paste0("number of UNIQUE people with NO icd10 code for Depression and HAS HAD AT LEAST 1 PHQ2 or 9 that was 0) : ", healthy_num_no_icd10_plus_phq2_and_phq9_MUST_HAVE_PHQ2_OR_9))


print(paste0("Cleanest cohort (depressed in icd9/10 or Phq2/9; healthy by at least one phq2/9 and never depression dx UNIQUE ---->>>>  Depressed: ", dep_num_icd10_plus_phq2_and_phq9, "; Healthy: ", healthy_num_no_icd10_plus_phq2_and_phq9_MUST_HAVE_PHQ2_OR_9))


##### THESE ARE THE DATAFRAMES I WANT TO USE GOING FORWARD ###
#all empis for depressed group include people with depresssion dx, and people who got in for phq2 or phq9
empis_for_depressed_group <- append(
  append(unique(dep_df$EMPI), depressed_unique_phq2_empis), depressed_unique_phq9_empis)

final_depressed_group_withICD_AND_depressed_phq2_or_9 <- 
  data_empi_acc_f_phq %>%
filter(EMPI %in% empis_for_depressed_group)

#------
empis_for_healthy_group <- append(healthy_unique_phq2_empis, healthy_unique_phq9_empis)

final_healthy_group_withNOICD_AND_phq2_or_9_0<- 
  data_empi_acc_f_phq %>%
filter(EMPI %in% empis_for_healthy_group)

#------
### add a column to the original dataframe with a 0 if not in any group, -1 if healthy, and 1 if depressed
data_empi_acc_f_phq$depGroupVar = 0
data_empi_acc_f_phq$depGroupVar[which(data_empi_acc_f_phq$EMPI %in% empis_for_depressed_group)] = 1
data_empi_acc_f_phq$depGroupVar[which(data_empi_acc_f_phq$EMPI %in% empis_for_healthy_group)] = -1
data_empi_acc_f_phq$depGroupVar = as.factor(data_empi_acc_f_phq$depGroupVar)

#------ Group for Tim to check quality issues ----------
write.csv(data_empi_acc_f_phq, "/Users/eballer/BBL/msdepression/data/dac/data_empi_acc_f_q.csv", col.names = T, sep = ",")

subset <- subset(data_empi_acc_f_phq, select = c("ACCESSION_NUM","EMPI","EXAM_DATE","depGroupVar"))

melissa_qc_data <- read.csv("/Users/eballer/BBL/msdepression/data/dac/just_empi_date_rating", sep = ",", header = F) #n = 2841
names(melissa_qc_data) <- c("EMPI", "EXAM_DATE", "rating")

bad_flairs <- read.csv("/Users/eballer/BBL/msdepression/data/dac/missing_flair.csv", sep = ",", header = T) #n = 1561
bad_flairs$EXAM_DATE <- gsub(pattern = "-", replacement = "", x = bad_flairs$date)

subset_with_qc <- merge(subset, melissa_qc_data, by = c("EMPI", "EXAM_DATE"))
subset_excluded <- merge(subset, bad_flairs, by = c("EMPI", "EXAM_DATE")) #n = 1973;  healthy = 457, uncategorized = 1284, depressed = 232 

unique <- subset_excluded %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()  #n (total) = 458, healthy = 114, uncat = 282. dep = 62

write.csv(subset_with_qc, "/Users/eballer/BBL/msdepression/data/dac/subset_with_qc_for_tim_20211117.csv", col.names = T)
write.csv(subset_with_qc, "/Users/eballer/BBL/msdepression/data/dac/subset_bad_flairs_for_tim_20211117.csv", col.names = T)

##########################################################
#             Step 5 - Read in Fascicle info             #
##########################################################

fascicle_proportions <- read.csv(paste0(homedir, "/results/fascicle_volumes_all_subjects_roi_n2336.csv"), header = T, sep = ",") #n = 2336

#fascicle names are contained in all but the first 2 columns of the fascicle_proportions df
fascicle_names <- names(fascicle_proportions[3:dim(fascicle_proportions)[2]])

write.table(fascicle_names,"/Users/eballer/BBL/msdepression/templates/dti/HCP_YA1065_tractography/fascicle_names.csv", row.names = F, quote = F, col.names = F)



########
#fascicle volumes in depression network
########
fascicle_volumes_dep <- read.csv(paste0(homedir, "results/streamline_volume_within_dep_network.csv"), header = T, sep = ",")

#add column to indicate whether does not meet criteria for inclusion in dep mask (0), any overlapping voxels (1), or >10% overlapping voxels (2)
fascicle_volumes_dep_network <- fascicle_volumes_dep_network %>%
  replace(is.na(.), 0) %>%
  mutate(inDepMask=case_when(prop_in_mask == 0 ~ 0, (prop_in_mask > 0 & prop_in_mask < 0.1) ~ 1, prop_in_mask >= 0.1 ~ 2))

write.table(fascicle_volumes_dep_network, paste0(homedir,  "/templates/dti/HCP_YA1065_tractography/fascicle_names_dep_network_grouping.csv"), sep = ",", col.names=T)#, row.names = F, quote = F, col.names = T)

fascicle_names_nondep_network<- fascicle_volumes_dep_network$fascicle[which(fascicle_volumes_dep_network$inDepMask == 0)]

fascicle_names_dep_network_all <- fascicle_volumes_dep_network$fascicle[which(fascicle_volumes_dep_network$inDepMask == 1)]
#write.table(fascicle_names_dep_network_all,"/Users/eballer/BBL/msdepression/templates/dti/HCP_YA1065_tractography/fascicle_names_dep_network_all.csv", row.names = F, quote = F, col.names = F)

fascicle_names_dep_network_10_percent <- fascicle_volumes_dep_network$fascicle[which(fascicle_volumes_dep_network$inDepMask == 2)]
#write.table(fascicle_names_dep_network_10_percent,"/Users/eballer/BBL/msdepression/templates/dti/HCP_YA1065_tractography/fascicle_names_dep_network_10_percent.csv", row.names = F, quote = F, col.names = F)
 
#fascicle_mapping, returns numerical mapping as well as names of tracts, and whether in or out of dep network
fascicle_bundle_mapping <- get_fascicle_bundle_mapping()

##########################################################
#             Step 6 - Merge with data_empi              #
##########################################################
df_demo_and_fascicles <- merge(data_empi_acc_f_phq, fascicle_proportions, by = c("EMPI", "EXAM_DATE")) #n = 2962

##########################################################
#                 Step 7 - Histos                        #
##########################################################
##### Histograms for PHQ2/9 healthy and depressed

hist(df_demo_and_fascicles$PHQ.2[which(!is.na(df_demo_and_fascicles$PHQ.2))], main = paste0("PHQ-2 In Good Mimosa Group : n = ", length(which(!is.na(df_demo_and_fascicles$PHQ.2)))), xlab = "PHQ-2", breaks = 8)

hist(df_demo_and_fascicles$PHQ.9[which(!is.na(df_demo_and_fascicles$PHQ.9))], main = paste0("PHQ-9 In Good Mimosa Group : n = ", length(which(!is.na(df_demo_and_fascicles$PHQ.9)))), xlab = "PHQ-9", breaks = 8) 

hist(df_demo_and_fascicles$PHQ.2[which(!is.na(df_demo_and_fascicles$PHQ.2) & (df_demo_and_fascicles$depGroupVar == 1))], main = paste0("PHQ-2/Depressed In Good Mimosa Group : n = ", length(which(!is.na(df_demo_and_fascicles$PHQ.2) & df_demo_and_fascicles$depGroupVar == 1))), xlab = "PHQ-2", breaks = 8)

hist(df_demo_and_fascicles$PHQ.9[which(!is.na(df_demo_and_fascicles$PHQ.9) & (df_demo_and_fascicles$depGroupVar == 1))], main = paste0("PHQ-9/Depressed In Good Mimosa Group : n = ", length(which(!is.na(df_demo_and_fascicles$PHQ.9) & df_demo_and_fascicles$depGroupVar == 1))), xlab = "PHQ-9", breaks = 8)

hist(df_demo_and_fascicles$PHQ.2[which(!is.na(df_demo_and_fascicles$PHQ.2) & (df_demo_and_fascicles$depGroupVar == -1))], main = paste0("PHQ-2/Healthy In Good Mimosa Group : n = ", length(which(!is.na(df_demo_and_fascicles$PHQ.2) & df_demo_and_fascicles$depGroupVar == -1))), xlab = "PHQ-2", breaks = 8)

hist(df_demo_and_fascicles$PHQ.9[which(!is.na(df_demo_and_fascicles$PHQ.9) & (df_demo_and_fascicles$depGroupVar == -1))], main = paste0("PHQ-9/Healthy In Good Mimosa Group : n = ", length(which(!is.na(df_demo_and_fascicles$PHQ.9) & df_demo_and_fascicles$depGroupVar == -1))), xlab = "PHQ-9", breaks = 8)

```

##########################################################
#          Step 8 - Visualize all Tracts                 #
##########################################################

```{r visualize_tracts}
##########################################################
#          Step 8 - Visualize all Tracts                 #
##########################################################
just_dep_and_empi <- subset(data_empi_acc_f_phq, select = c("EMPI", "depGroupVar"))
added_dep_to_fascicles <- merge(just_dep_and_empi, fascicle_proportions, by = c("EMPI"))
melted_df <- melt(added_dep_to_fascicles, id.vars = c("EMPI", "EXAM_DATE", "depGroupVar"))
lesioned <- subset(melted_df, value > 0)
lesioned_dx <- subset(lesioned, depGroupVar != 0)
healthy <- subset(lesioned, depGroupVar == -1)
depressed <- subset(lesioned, depGroupVar == 1)

q<-ggplot(lesioned, aes(x=value, fill=depGroupVar)) + geom_histogram() + facet_wrap(~variable)
r<-ggplot(lesioned_dx, aes(x=value, fill=depGroupVar)) + geom_histogram() + facet_wrap(~variable)
x<-ggplot(lesioned, aes(x=value)) + geom_histogram() + facet_wrap(~variable)
y<-ggplot(healthy, aes(x=value)) + geom_histogram() + facet_wrap(~variable)
z<-ggplot(depressed, aes(x=value)) + geom_histogram() + facet_wrap(~variable)
print(q)
print(r)
print(x)
print(y)
print(z)



```

##########################################################
#                Step 9 - Regressions                    #
##########################################################

```{r dep_vs_healthy_regressions}
##########################################################
#                Step 9 - Regressions                    #
##########################################################

#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles[df_demo_and_fascicles$depGroupVar != 0,] #n depressed = 393, healthy = 713, total n = 1106

#lm
fascicle_lm <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ depGroupVar, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_lm) <- fascicle_names

#anova
fascicle_anova <- lapply(fascicle_lm, anova)

#fdr corrected
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova, 1)
print(fascicle_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$inDepNetwork_vector > 0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep 10% mask
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$inDepNetwork_vector == 2)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#visreg
#sapply(fascicle_lm, visreg)
```


```{r phq2_correlation_fascicles}
#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles[df_demo_and_fascicles$depGroupVar != 0,] #n depressed = 393, healthy = 713, total n = 1106

#filter those with phq2
with_phq2 <- dep_and_healthy_groups_for_ICD_analysis %>% filter(!is.na(PHQ.2))

#lm
fascicle_lm <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ PHQ.2, list(i = as.name(x))), data = with_phq2)
})
names(fascicle_lm) <- fascicle_names

#anova
fascicle_anova <- lapply(fascicle_lm, anova)

#fdr corrected
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova, 1)
print(fascicle_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)


#fdr corrected only dep 10% mask
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$inDepNetwork_vector == 2)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_anova_p <- sapply(fascicle_anova, function(v) v$"Pr(>F)"[1])
fascicle_anova_p05_unc <- as.data.frame(fascicle_anova_p[fascicle_anova_p < 0.05])
print(fascicle_anova_p05_unc)

#visreg
#sapply(fascicle_lm, visreg)
```
```{r phq2_correlation_fascicles_dep}
#isolate out only the depressed group and healthy group
dep_groups_for_ICD_analysis <- df_demo_and_fascicles[df_demo_and_fascicles$depGroupVar == 1,] #n depressed = 393, healthy = 713, total n = 1106

#filter those with phq2
with_phq2_dep <- dep_groups_for_ICD_analysis %>% filter(!is.na(PHQ.2) & PHQ.2 != 0) %>% filter(depGroupVar == 1)

#lm
fascicle_lm <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ PHQ.2, list(i = as.name(x))), data = with_phq2_dep)
})
names(fascicle_lm) <- fascicle_names

#anova
fascicle_anova <- lapply(fascicle_lm, anova)

#fdr corrected
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova, 1)
print(fascicle_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)
#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)


#fdr corrected only dep 10% mask
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$inDepNetwork_vector == 2)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_anova_p <- sapply(fascicle_anova, function(v) v$"Pr(>F)"[1])
fascicle_anova_p05_unc <- as.data.frame(fascicle_anova_p[fascicle_anova_p < 0.05])
print(fascicle_anova_p05_unc)

#visreg
#sapply(fascicle_lm, visreg)
```

```{r phq9_correlation_fascicles}
#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles[df_demo_and_fascicles$depGroupVar != 0,] #n depressed = 393, healthy = 713, total n = 1106

#filter those with phq2
with_phq9 <- dep_and_healthy_groups_for_ICD_analysis %>% filter(!is.na(PHQ.9))

#lm
fascicle_lm <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ PHQ.9, list(i = as.name(x))), data = with_phq9)
})
names(fascicle_lm) <- fascicle_names

#anova
fascicle_anova <- lapply(fascicle_lm, anova)

#fdr corrected
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova, 1)
print(fascicle_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)


#fdr corrected only dep 10% mask
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$inDepNetwork_vector == 2)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_anova_p <- sapply(fascicle_anova, function(v) v$"Pr(>F)"[1])
fascicle_anova_p05_unc <- as.data.frame(fascicle_anova_p[fascicle_anova_p < 0.05])
print(fascicle_anova_p05_unc)

#visreg
#sapply(fascicle_lm, visreg)
```
```{r phq9_correlation_fascicles_dep}
#isolate out only the depressed group and healthy group
dep_groups_for_ICD_analysis <- df_demo_and_fascicles[df_demo_and_fascicles$depGroupVar == 1,] #n depressed = 393, healthy = 713, total n = 1106

#filter those with phq2
with_phq9_dep <- dep_groups_for_ICD_analysis %>% filter(!is.na(PHQ.9) & PHQ.9 != 0) 

#lm
fascicle_lm <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ PHQ.9, list(i = as.name(x))), data = with_phq9_dep)
})
names(fascicle_lm) <- fascicle_names

#anova
fascicle_anova <- lapply(fascicle_lm, anova)

#fdr corrected
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova, 1)
print(fascicle_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)


#fdr corrected only dep 10% mask
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$inDepNetwork_vector == 2)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)


#uncorrected
fascicle_anova_p <- sapply(fascicle_anova, function(v) v$"Pr(>F)"[1])
fascicle_anova_p05_unc <- as.data.frame(fascicle_anova_p[fascicle_anova_p < 0.05])
print(fascicle_anova_p05_unc)

#visreg
#sapply(fascicle_lm, visreg)
```

```{r depression_main_effect_unique_subjects}
##### repeat above analysis but use only the first instance of each EMPI, sorted by date
df_unique_empi <- dep_and_healthy_groups_for_ICD_analysis %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup() #n = 300, 115 depressed, 185 healthy

#lm
fascicle_lm_unique <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ depGroupVar, list(i = as.name(x))), data = df_unique_empi)
})
names(fascicle_lm_unique) <- fascicle_names

#anova
fascicle_anova_unique <- lapply(fascicle_lm_unique, anova)

#fdr corrected
fascicle_anova_unique_fdr <- fdr_anova_generic(fascicle_anova_unique, 1)
print(fascicle_anova_unique_fdr)#anova values < 0.05, uncorrected

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_anova_unique[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)


#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_anova_unique[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep 10% mask
fascicle_anova_w_fiber_mapping <- fascicle_anova_unique[which(fascicle_bundle_mapping$inDepNetwork_vector ==2)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)


#uncorrected
fascicle_anova_unique_p <- sapply(fascicle_anova_unique, function(v) v$"Pr(>F)"[1])
fascicle_anova_unique_p05_unc <- as.data.frame(fascicle_anova_unique_p[fascicle_anova_unique_p < 0.05])
print(fascicle_anova_unique_p05_unc)

```


```{r depression_main_effect_mixed_model}
##### repeat above analysis but use only the first instance of each EMPI, sorted by date
df_mm <- df_demo_and_fascicles[df_demo_and_fascicles$depGroupVar != 0,]

#lm
fascicle_lm_mm <- lapply(fascicle_names, function(x) 
{
  lmerTest::lmer(substitute(i ~ depGroupVar + (1 | EMPI), list(i = as.name(x))), data = df_mm)
})
names(fascicle_lm_mm) <- fascicle_names

#anova
fascicle_anova_mm <- lapply(fascicle_lm_mm, anova)

#fdr corrected
fascicle_anova_mm_fdr <- fdr_anova_generic(fascicle_anova_mm, 1)
print(fascicle_anova_mm_fdr)#anova values < 0.05, uncorrected

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_anova_mm[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_anova_mm[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network 10%
fascicle_anova_w_fiber_mapping <- fascicle_anova_mm[which(fascicle_bundle_mapping$inDepNetwork_vector == 2)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_anova_mm_p <- sapply(fascicle_anova_mm, function(v) v$"Pr(>F)"[1])
fascicle_anova_mm_p05_unc <- as.data.frame(fascicle_anova_mm_p[fascicle_anova_mm_p < 0.05])
print(fascicle_anova_mm_p05_unc)

```

```{r age_effects_fascicles}
########### age effect whole group

#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles[df_demo_and_fascicles$depGroupVar != 0,] #n depressed = 393, healthy = 713, total n = 1106

#### age histo ###
hist(dep_and_healthy_groups_for_ICD_analysis$PAT_AGE_AT_EXAM,
main = paste0("Age In Good Mimosa Group : n = ", dim(dep_and_healthy_groups_for_ICD_analysis)[1]), xlab = "Age", breaks = 10)

#lm
fascicle_age_lm <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ PAT_AGE_AT_EXAM, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_age_lm) <- fascicle_names

#anova
fascicle_age_anova <- lapply(fascicle_age_lm, anova)

#fdr corrected
fascicle_age_anova_fdr <- fdr_anova_generic(fascicle_age_anova, 1)
print(fascicle_age_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_age_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#visreg
#sapply(fascicle_age_lm,visreg)
```

```{r age_effects_fascicles_unique}
########### age effect whole group

#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles[df_demo_and_fascicles$depGroupVar != 0,]  %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()


#### age histo ###
hist(dep_and_healthy_groups_for_ICD_analysis$PAT_AGE_AT_EXAM,
main = paste0("Age In Good Mimosa Group : n = ", dim(dep_and_healthy_groups_for_ICD_analysis)[1]), xlab = "Age", breaks = 10)

#lm
fascicle_age_lm <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ PAT_AGE_AT_EXAM, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_age_lm) <- fascicle_names

#anova
fascicle_age_anova <- lapply(fascicle_age_lm, anova)

#fdr corrected
fascicle_age_anova_fdr <- fdr_anova_generic(fascicle_age_anova, 1)
print(fascicle_age_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_age_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#visreg
#sapply(fascicle_age_lm,visreg)
```

```{r age_effects_fascicles_mm}
########### age effect whole group

#isolate out only the depressed group and healthy group

dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles[df_demo_and_fascicles$depGroupVar != 0,] #n depressed = 393, healthy = 713, total n = 1106


#### age histo ###
hist(dep_and_healthy_groups_for_ICD_analysis$PAT_AGE_AT_EXAM,
main = paste0("Age In Good Mimosa Group : n = ", dim(dep_and_healthy_groups_for_ICD_analysis)[1]), xlab = "Age", breaks = 10)

#lm
fascicle_age_lm <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ PAT_AGE_AT_EXAM, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_age_lm) <- fascicle_names

#anova
fascicle_age_anova <- lapply(fascicle_age_lm, anova)

#fdr corrected
fascicle_age_anova_fdr <- fdr_anova_generic(fascicle_age_anova, 1)
print(fascicle_age_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_age_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#visreg
#sapply(fascicle_age_lm,visreg)
```

```{r sex_effects_fascicles}
########### sex effect whole group

#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles[df_demo_and_fascicles$depGroupVar != 0,] #n depressed = 393, healthhy = 713, total n = 1106

#### sex histo ###
hist(dep_and_healthy_groups_for_ICD_analysis$sex_binarized,
main = paste0("Sex In Good Mimosa Group : n (M/F)= ", sum(dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1), "/", sum(dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)),  xlab = "Sex", breaks = 2)

#lm
fascicle_sex_lm <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ osex, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_sex_lm) <- fascicle_names

#anova
fascicle_sex_anova <- lapply(fascicle_sex_lm, anova)

#fdr corrected
fascicle_sex_anova_fdr <- fdr_anova_generic(fascicle_sex_anova, 1)
print(fascicle_sex_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sex_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#visreg
#sapply(fascicle_sex_lm,visreg)
```

```{r sex_effects_fascicles_unique}
########### sex effect whole group

#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles[df_demo_and_fascicles$depGroupVar != 0,]  %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()

#### sex histo ###
hist(dep_and_healthy_groups_for_ICD_analysis$sex_binarized,
main = paste0("Sex In Good Mimosa Group : n (M/F)= ", sum(dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1), "/", sum(dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)),  xlab = "Sex", breaks = 2)

#lm
fascicle_sex_lm <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ osex, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_sex_lm) <- fascicle_names

#anova
fascicle_sex_anova <- lapply(fascicle_sex_lm, anova)

#fdr corrected
fascicle_sex_anova_fdr <- fdr_anova_generic(fascicle_sex_anova, 1)
print(fascicle_sex_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sex_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#visreg
#sapply(fascicle_sex_lm,visreg)
```

```{r sex_effects_fascicles_mm}
########### sex effect whole group

#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles[df_demo_and_fascicles$depGroupVar != 0,] #n depressed = 393, healthhy = 713, total n = 1106

#### sex histo ###
hist(dep_and_healthy_groups_for_ICD_analysis$sex_binarized,
main = paste0("Sex In Good Mimosa Group : n (M/F)= ", sum(dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1), "/", sum(dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)),  xlab = "Sex", breaks = 2)

#lm
fascicle_sex_lm <- lapply(fascicle_names, function(x) 
{
  lmerTest::lmer(substitute(i ~ osex + (1|EMPI), list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_sex_lm) <- fascicle_names

#anova
fascicle_sex_anova <- lapply(fascicle_sex_lm, anova)

#fdr corrected
fascicle_sex_anova_fdr <- fdr_anova_generic(fascicle_sex_anova, 1)
print(fascicle_sex_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sex_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#visreg
#sapply(fascicle_sex_lm,visreg)
```

```{r sex_by_depression_fascicles}
#sex by depression
#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles[df_demo_and_fascicles$depGroupVar != 0,] #n depressed = 393, healthhy = 713, total n = 1106

#lm
fascicle_sexdep_lm <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ osex*depGroupVar, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_sexdep_lm) <- fascicle_names

#anova
fascicle_sexdep_anova <- lapply(fascicle_sexdep_lm, anova)

#fdr corrected
fascicle_sexdep_anova_fdr <- fdr_anova_generic(fascicle_sexdep_anova, 3)
print(fascicle_sexdep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,3)
print(fascicle_anova_fdr_association)

```

```{r age_by_depression_fascicles}
#sex by depression
#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles[df_demo_and_fascicles$depGroupVar != 0,] #n depressed = 393, healthhy = 713, total n = 1106

#lm
fascicle_agedep_lm <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ PAT_AGE_AT_EXAM*depGroupVar, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_agedep_lm) <- fascicle_names

#anova
fascicle_agedep_anova <- lapply(fascicle_agedep_lm, anova)


#fdr corrected - depression alone
fascicle_agedep_anova_fdr <- fdr_anova_generic(fascicle_agedep_anova, 2)
print(fascicle_agedep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_agedep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,2)
print(fascicle_anova_fdr_association)


#fdr corrected - interaction
fascicle_agedep_anova_fdr <- fdr_anova_generic(fascicle_agedep_anova, 3)
print(fascicle_agedep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_agedep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,3)
print(fascicle_anova_fdr_association)

```

```{r age_by_depression_unique}

#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles[df_demo_and_fascicles$depGroupVar != 0,]  %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()

#lm
fascicle_agedep_lm <- lapply(fascicle_names, function(x) 
{
   lm(substitute(i ~ PAT_AGE_AT_EXAM*depGroupVar, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
# lm(substitute(i ~ depGroupVar + PAT_AGE_AT_EXAM + osex, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_agedep_lm) <- fascicle_names

#anova
fascicle_agedep_anova <- lapply(fascicle_agedep_lm, anova)


#fdr corrected - depression alone
fascicle_agedep_anova_fdr <- fdr_anova_generic(fascicle_agedep_anova, 2)
print(fascicle_agedep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_agedep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,2)
print(fascicle_anova_fdr_association)


#fdr corrected - interaction
fascicle_agedep_anova_fdr <- fdr_anova_generic(fascicle_agedep_anova, 3)
print(fascicle_agedep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_agedep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,3)
print(fascicle_anova_fdr_association)
```
```{r depression_unique_all_fascicles_together}

#isolate out only the depressed group and healthy group, make a column that sums up the total prop lost)
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles[df_demo_and_fascicles$depGroupVar != 0,]  %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  mutate(total_fascicle_prop_lost = rowMeans(across(fascicle_names))) %>%
  ungroup()
##

dep_vs_healthy <- lm(total_fascicle_prop_lost ~ depGroupVar + PAT_AGE_AT_EXAM, data = dep_and_healthy_groups_for_ICD_analysis)

ggplot(data = dep_and_healthy_groups_for_ICD_analysis, aes(x=PAT_AGE_AT_EXAM,y=total_fascicle_prop_lost, color = EMPI, group = EMPI)) + 
  geom_point(position = "jitter", show.legend = F) + 
  geom_line(show.legend = F) + 
  facet_wrap(~EMPI)


#lm
fascicle_agedep_lm <- lapply(fascicle_names, function(x) 
{
   lm(substitute(i ~ PAT_AGE_AT_EXAM*depGroupVar, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
# lm(substitute(i ~ depGroupVar + PAT_AGE_AT_EXAM + osex, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_agedep_lm) <- fascicle_names

#anova
fascicle_agedep_anova <- lapply(fascicle_agedep_lm, anova)


#fdr corrected - depression alone
fascicle_agedep_anova_fdr <- fdr_anova_generic(fascicle_agedep_anova, 2)
print(fascicle_agedep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_agedep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,2)
print(fascicle_anova_fdr_association)


#fdr corrected - interaction
fascicle_agedep_anova_fdr <- fdr_anova_generic(fascicle_agedep_anova, 3)
print(fascicle_agedep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_agedep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,3)
print(fascicle_anova_fdr_association)
```


```{r depression_mm_all_fascicles_together}

#isolate out only the depressed group and healthy group, make a column that sums up the total prop lost)
#also make columns for the mean across the full depression network, and the 10% cutoff depression network
#remove rows where the total_fascicle_prop_lost is 0 - this was usually a failure of normalization
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles[df_demo_and_fascicles$depGroupVar != 0,]  %>% 
  mutate(total_fascicle_prop_lost = rowMeans(across(fascicle_names))) %>%
  mutate(total_fascicle_prop_lost_indepnet = rowMeans(across(fascicle_names_dep_network_all))) %>%
  mutate(total_fascicle_prop_lost_indepnet_10_percent =
           rowMeans(across(fascicle_names_dep_network_10_percent))) %>%
  filter(total_fascicle_prop_lost > 0) %>%
  ungroup()


### thank you Bart! 11/30/2021
ggplot(data = dep_and_healthy_groups_for_ICD_analysis, aes(x=PAT_AGE_AT_EXAM,y=total_fascicle_prop_lost, color = EMPI, group = EMPI)) + 
  geom_point(position = "jitter", show.legend = F) + 
  geom_line(show.legend = F) + 
  facet_wrap(~depGroupVar)

ggplot(data = dep_and_healthy_groups_for_ICD_analysis, aes(x=PAT_AGE_AT_EXAM,y=total_fascicle_prop_lost, color = EMPI, group = EMPI)) + 
  geom_point(position = "jitter", show.legend = F) + 
  geom_line(show.legend = F) + 
  facet_wrap(~EMPI)

dep_vs_healthy <- lmerTest::lmer(total_fascicle_prop_lost ~ depGroupVar + (1 | EMPI) + PAT_AGE_AT_EXAM, data = dep_and_healthy_groups_for_ICD_analysis)

dep_easy <- lm(total_fascicle_prop_lost ~ depGroupVar + PAT_AGE_AT_EXAM, data = dep_and_healthy_groups_for_ICD_analysis)

dep_vs_healthy_net <- lmerTest::lmer(total_fascicle_prop_lost_indepnet ~ depGroupVar + (1 | EMPI) + PAT_AGE_AT_EXAM, data = dep_and_healthy_groups_for_ICD_analysis)

dep_easy_dep_net <- lm(total_fascicle_prop_lost_indepnet ~ depGroupVar + PAT_AGE_AT_EXAM, data = dep_and_healthy_groups_for_ICD_analysis)

dep_vs_healthy_net_10_percent <- lmerTest::lmer(total_fascicle_prop_lost_indepnet_10_percent ~ depGroupVar + (1 | EMPI) + PAT_AGE_AT_EXAM, data = dep_and_healthy_groups_for_ICD_analysis)

dep_easy_dep_net_10_percent <- lm(total_fascicle_prop_lost_indepnet_10_percent ~ depGroupVar + PAT_AGE_AT_EXAM, data = dep_and_healthy_groups_for_ICD_analysis)

ggplot(data = dep_and_healthy_groups_for_ICD_analysis2, aes(x=`(Intercept)`, y=total_fascicle_prop_lost, color = EMPI, group = EMPI)) + 
  geom_point(position = "jitter", show.legend = F) + 
  geom_line(show.legend = F) + 
  facet_wrap(~EMPI)

#lm
fascicle_agedep_lm <- lapply(fascicle_names, function(x) 
{
   lmerTest::lmer(substitute(i ~ depGroupVar + (1|EMPI) + PAT_AGE_AT_EXAM , list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
# lm(substitute(i ~ depGroupVar + PAT_AGE_AT_EXAM + osex, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_agedep_lm) <- fascicle_names

#anova
fascicle_agedep_anova <- lapply(fascicle_agedep_lm, anova)


#fdr corrected - depression alone
fascicle_agedep_anova_fdr <- fdr_anova_generic(fascicle_agedep_anova, 2)
print(fascicle_agedep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_agedep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,2)
print(fascicle_anova_fdr_association)

#fdr corrected nondep, number of fascicles is total, 40, 5 correct - C_PHP_L, SLF1_L, UF_L, R, DRTT_L
fascicle_anova_w_fiber_mapping <- fascicle_agedep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector == 0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,2)
print(fascicle_anova_fdr_association)

#fdr corrected dep, number of fascicles is total = 47, num correct =30
#take home - areas of worsening disease over age much more likely to be in depression network
fascicle_anova_w_fiber_mapping <- fascicle_agedep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector > 0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,2)
print(fascicle_anova_fdr_association)




#fdr corrected - interaction
fascicle_agedep_lm <- lapply(fascicle_names, function(x) 
{
   lmerTest::lmer(substitute(i ~ depGroupVar*PAT_AGE_AT_EXAM + (1|EMPI) , list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
# lm(substitute(i ~ depGroupVar + PAT_AGE_AT_EXAM + osex, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_agedep_lm) <- fascicle_names

#anova
fascicle_agedep_anova <- lapply(fascicle_agedep_lm, anova)

fascicle_agedep_anova_fdr <- fdr_anova_generic(fascicle_agedep_anova, 3)
print(fascicle_agedep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_agedep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,3)
print(fascicle_anova_fdr_association)

#fdr corrected only dep
fascicle_anova_w_fiber_mapping <- fascicle_agedep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector > 0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,3)
print(fascicle_anova_fdr_association)

#fdr corrected only dep 10%
fascicle_anova_w_fiber_mapping <- fascicle_agedep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector == 2)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,3)
print(fascicle_anova_fdr_association)

#fdr corrected nondep, number of fascicles is total, 40, 4 correct - C_PHP_L, UF_L, R, DRTT_L
fascicle_anova_w_fiber_mapping <- fascicle_agedep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector == 0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,2)
print(fascicle_anova_fdr_association)

#fdr corrected dep, number of fascicles is total = 47, num correct = 29
#take home - areas of worsening disease over age much more likely to be in depression network
fascicle_anova_w_fiber_mapping <- fascicle_agedep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector > 0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,2)
print(fascicle_anova_fdr_association)
```

```{r testing_whether_ms_disease_more_likely_in_depression_mask}
### tests whether there is higher proportion of vertices lost in depression network versus not
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles[df_demo_and_fascicles$depGroupVar != 0,]  %>% 
  mutate(total_fascicle_prop_lost = rowMeans(across(fascicle_names))) %>%
  mutate(total_fascicle_prop_lost_indepnet = rowMeans(across(fascicle_names_dep_network_all))) %>%
  mutate(total_fascicle_prop_lost_indepnet_10_percent =
           rowMeans(across(fascicle_names_dep_network_10_percent))) %>%
  mutate(total_fascicle_prop_lost_nondep_network =
           rowMeans(across(fascicle_names_nondep_network))) %>%
  filter(total_fascicle_prop_lost > 0) %>%
  #group_by(EMPI) %>% 
  #arrange(EXAM_DATE) %>% 
  #slice(1) %>% 
  ungroup()

volume_lost_dep_vs_nondep_network <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet, dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network)

volume_lost_dep10_vs_nondep_network <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_10_percent,
dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network)

#unique
### tests whether there is higher proportion of vertices lost in depression network versus not, ends up being n=298; healthy = 184, depressed = 114 
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles[df_demo_and_fascicles$depGroupVar != 0,]  %>% 
  mutate(total_fascicle_prop_lost = rowMeans(across(fascicle_names))) %>%
  mutate(total_fascicle_prop_lost_indepnet = rowMeans(across(fascicle_names_dep_network_all))) %>%
  mutate(total_fascicle_prop_lost_indepnet_10_percent =
           rowMeans(across(fascicle_names_dep_network_10_percent))) %>%
  mutate(total_fascicle_prop_lost_nondep_network =
           rowMeans(across(fascicle_names_nondep_network))) %>%
  filter(total_fascicle_prop_lost > 0) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()

volume_lost_dep_vs_nondep_network_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet, dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network)

volume_lost_dep10_vs_nondep_network_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_10_percent,
dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network)


###### Depression network x depression group interaction - not quite there. 
#I want to ask whether depressed MS patients are more likely to have more damage in depression networks than none. So I know MS preferentially affects depression networks. Maybe I answered this already
depression_network_and_dx_subgroup <- data.frame(subset(dep_and_healthy_groups_for_ICD_analysis, select = c("EMPI", "EXAM_DATE", "depGroupVar","total_fascicle_prop_lost_nondep_network", "total_fascicle_prop_lost_indepnet","total_fascicle_prop_lost_indepnet_10_percent")))
#melted_df <- melt(depression_network_and_dx_subgroup, id.vars = c("EMPI", "EXAM_DATE", "depGroupVar"))
 
#loss doesn't seem to be different between those with depression and those without
loss_in_dep_network <- lm(total_fascicle_prop_lost_indepnet~depGroupVar, data = depression_network_and_dx_subgroup) #non sig
loss_in_dep_network_10_percent <- lm(total_fascicle_prop_lost_indepnet_10_percent~depGroupVar, data = depression_network_and_dx_subgroup) #non sig
loss_in_nondep_network <- lm(total_fascicle_prop_lost_nondep_network~depGroupVar, data = depression_network_and_dx_subgroup) #non sig
```


```{r visreg_models}

#visreg
#sapply(fascicle_lm, visreg)
#sapply(fascicle_age_lm, visreg)
#sapply(fascicle_sex_lm, visreg)
#sapply(fascicle_sexdep_lm, visreg)
#sapply(fascicle_lm_unique, visreg)

```




