---
title: "R Notebook for MSDepression Project"
output:
  html_notebook
---

#### 20201008

First, need to summarize data

1) Got data into csv format
  - Opened /Users/eballer/Documents/Penn T32/MS_Depression_Ted_Taki/Documents/*xls in excel and saved as csv
2)
```{move_data bash}
cd /Users/eballer/BBL/msdepression/data/
mkdir dac
cp /Users/eballer/Documents/Penn T32/MS_Depression_Ted_Taki/Documents/*csv .
```

3) In R, started /Users/eballer/BBL/msdepression/dac_summary.Rmd to summarize data

** during the last iteration of de-identifying the DAC, the PHQ-9 scores all vanished. Will need to ask for them to be re-added.
** also, number of people dropped by 50% (from 36277 to 16383)

#### 20201012

Continued with descriptives

  - Read in Melissa's data sheet.
  - subsetted EMPI and Accession # (since our EMPI's are deidentified)
  - Merged with my datasheet on Accession #
  - "PatientID == EMPI"

Merged Melissa's data with mine to get empis.

#### 20201013

[x] Figure out how many people with repeat mrns - to remove doubles. Will need to remove duplicates.

#### 20201027

Going back and forth a lot with DAC people, should have a new update soon. Big thing will be to parse PHQ2/9. We will get all of them but have to tie them to their appropriate scans


#### 20201117

Lots of back and forth with DAC, significantly less people in my pull that limited its pull to people who had G35 codes only. Went back to emails with Sunil (Taki involved). See email below.

---

I think my focus was more on the images and using the challenging radiology data.
So I took a quick look at the codes and files that I might have sent or used. Unfortunately, I can’t remember what the last file I sent was and I don’t have access to the lothal drive anymore.
 
Criteria:
Don’t see any dates used. Guessing data probably was up to 7/2018(around the time I ran the report)
I looked for patients with order associated diagnosis (%340% or %G35%)  which we mentioned that it is something that is not always populated.
And specific proc codes or cpt codes:
-          '70551','70552','70553','MHDI', 'IMGMR0128','IMGMR0047','IMGMR0061','IMGMR0054','70551','70552','70553','MHDI', 'IMGMR0128','IMGMR0047','IMGMR0061','IMGMR0054'
Performing Depts: 361, 547, 6004, 6013
 
--If I remember correctly, we added additional proc code and cpt codes in because the data output was very low and associated diagnosis was not always populated. Also, Taki, Melissa and I talked about some of the possible discrepancies. Which was really helpful.
 
Recommendation: I recommend taking a couple patients and looking at their records.
 
For ex: I reviewed a patient: Zylstra, Whitney
I don’t see any ms diagnosis on the main snapshot problem list on the chart and started assuming she doesn’t have MS.
I looked further and found that there was a procedure encounter diag on 9/11/2017 with diag of “G35”.

 
But if you look at the orders, I found a couple orders with the procode listed above but the associated diagnosis was not 340 or G35. I’m not clinical and I could be wrong but I would think this patient would be on your report.
 
Thanks
Sunil
 
cid:image001.gif@01D291AA.9A09B140
Sunil Thomas
Senior Clinical Information Analyst
(: 215-662-4784
📧: Sunil.Thomas@pennmedicine.upenn.edu
 
“Be water, my friend.”
 
This is the best I have for now guys. I hope this helps!

---

#### 20210126

A lot of success. Went back and forth with DAC, decided to ask for basically everyone, and we would post sort for providers that were associated with MS clinic, assuming that patients who received a diagnosis of MS from one of these people actually had it. 

Updates dac_summary to include not only a summary of the returned DAC pull, but also of the subset of people with MS providers. dac_summary.Rmd can be found on github, and summary table on: https://docs.google.com/presentation/d/1pDWXYUmq6sq7Xe08HaWdxLELa-qtQtABCw8RIIZ_7to/edit#slide=id.gb446eacf6a_0_0

#### 20210129

[x] figure out who has unique icd9/10 and phq2/9
[x] figure out what the overlap in # of scans between Melissa and my new group are

#### 20210208
[x] check logic of unique EMPIs, looks like something wonky is going on - less unique empis in my group than in the overlap group. Obviously they should be the same if not better
   - fixed, using accession #s and not empis to look for unique empis. Now that I look for unique EMPIs, we are all good!
   
#### 20210209
[x] post to channel tomorrow

#### 20210223
[x] Melissa caught that one of our MS providers was in incorrectly. This added a bunch of scans. JACOBS, DINA A. is the right person, not JACOBS, LINDA. Reran my stuff and updated my ms google doc.

Mellisa also realized that our group should include those with a visit with an MS provider AND ICD9/10 MS code.

Today:
3737 patients
28348 total accession numbers
17038 accession numbers we don’t already have and will be requesting
3737 unique empis from the new pull who have seen an MS attending with a corresponding MS diagnosis


#### The future
-at some point, will have to make sure to clarify we used ms diagnoses and the ms provider for our final #s

#### 20210421

- Have been summarizing MS data and some interesting findings are coming about: 
1] "Number of unique procedure names (ie. MRI Head w/out contrast; MRI Source Images): 10"
[1] "Number of unique department names (ie. RAD HUP PCAM Ground): 3"
[1] "Number of unique modalities (ie. HUP PCAM GR MR4 3T; MR6 3T): 11"
[1] "Number of unique accession #s n= 16830"
[1] "Number of unique EMPIS n = 3737"
[1] "N PHQ-2 = 4606; n = 130 meeting criteria for depression (PHQ2) >= 3"
[1] "N PHQ-9 = 261; noDep/mild/mod/mod-severe/severe = 77/73/65/21/25"
[1] "num people with both phq2 and 9 = 0"
[1] "N with phq2 (Unique EMPI) n = 899 out of 4606; n - 32 meeting criteria for depression (PHQ2) >= 3"
[1] "N with phq9 (Unique EMPI) n = 68 out of 261; noDep/mild/mod/mod-severe/severe = 18/16/18/8/8"
[1] "N with ICD 9/10 codes for depression = 2123"
[1] "N with ICD 9/10 codes for depression and unique EMPI = 493 out of 16830"
[1] "N with ICD 9/10 codes for depression and phq2 (ALL SCANS) = 960 out of 2123"
[1] "N with ICD 9/10 codes for depression and phq9 (ALL SCANS) = 140 out of 2123"
[1] "N dep + PHQ-2 = 960; n = 83 meeting criteria for depression (PHQ2) >= 3"
[1] "N dep + PHQ-9 = 140; noDep/mild/mod/mod-severe/severe = 22/39/44/20/15"
[1] "N with ICD 9/10 codes for depression and phq2 (unique) = 201 out of 2123"
[1] "N with ICD 9/10 codes for depression and phq9 (unique) = 43 out of 2123"
[1] "N without Depression/ICD 9/10 codes for healthy = 14707"
[1] "N without Depression/ ICD 9/10 codes for healthy and unique EMPI = 3244 out of 14707"
[1] "N without Depression/ ICD 9/10 codes for healthy and phq2 (ALL SCANS) = 3646 out of 14707"
[1] "N healthy w/PHQ-2 = 3646; n = 47 meeting criteria for depression (PHQ2) >= 3"
[1] "N without Depression/ ICD 9/10 codes for healthy and phq9 (ALL SCANS) = 121 out of 14707"
[1] "N healthy w/PHQ-9 = 121; noDep/mild/mod/mod-severe/severe = 55/34/21/1/10"
[1] "N without Depression/ ICD 9/10 codes for healthy and phq2 (unique) = 698 out of 14707"
[1] "N without Depression/ ICD 9/10 codes for healthy and phq9 (unique) = 25 out of 14707"

- Starting to look at statistical relationships as well

- takeaways. ~12% of people have a chart dx of MS, even though the literature says much more
   - PHQ2 and phq9s characterize MS differently. On average, people are not depressed (PHQ2 ~ 0.5), but are mildly depressed with (PHQ9 ~9). What does this mean?
   - PHQ9s include 7 more qs than 2s, including a lot of somatic symptoms (fatigue, appetite, psychomotor agitation/retardation)
   
- To dos:
  [] Chi sq comparing frequency of depression dx by phq2s vs phq9s
  [] Finding out if there is some sort of a time where some people got phq2s at some point, and some got phq9s -> is there a reason? Same population, different results
  [] literature review of ms depression, understand how depression was previously dx/described; n's, any explanation for somatic sxs?
      - does depression get better with MS tx? Suggesting that MS depression dx could have a lot to do with somatic stuff
      - Another thought - if PHQ9 is pos, but 2 is negative, even though we don't have indiv measures, it is actually splitting out anhedonia from other depressive sxs, which is interesting
  [x] lit search on evidence behind phq2 and 9
  [x] matt schindler meeting
    - to prepare 10 minute summary of the research I've reviewed
       - what has been done
       - what is the state of the field?
    - summary of our sample so far
    - prelim analyses and qs
    - Ask: are there markers of progression in the literature or that you use? Could we extract from EMR? Or would we need NLP?
    - What do you all notice? ANy differences in depression in pts you start on certain txs versus other than we can test in real world?
  
- also, we do have longitudinal data in a subset, could compare phq2/9 for brains within same subject with more/less MS.


[x] meeting with everyone

#### 20210527

- We are getting really into our collab with harvard and neurology!
- on 5/28, I'll present my work so far. For visualization purposes, I've used a combo of afni (for masking) and fslview (for visualizing), and dsi studio (for making the WM tracts)

- First, we got a "depression network" from harvard, based on a paper from Shan Siddiqui. It is from a preprint:
https://www.dropbox.com/sh/lj5mbfdsig5e4xa/AABfln6Ma_2ialx_KXNHR0oQa?dl=0

- Next, Matt took this into dsi studio, made his mask, and then ran the fibertracking and got some beautiful pictures

- Then, I took the depression network, masked it with our MNI mask, and did visualization in fslview

- Making the masks (had to do this for my figures because the mask from harvard didn't quite line up with our MNI, so I had to make sure I masked the harvard one with the mni template so it looked pretty)

    3dcalc -a MNI152_T1_2mm_brain.nii.gz -expr 'ispositive(a)' -prefix mni_positive_mask.nii
    3dcalc -a mni_positive_mask.nii -b AllFX_wmean.nii -expr 'a*b' -prefix mni_x_AllFx_mean.nii

- visualizing the overlaps 
  - fslview_deprecated
  - open each of the masks. Make sure the eye is clicked to keep it "on"
  - the info button allows you to change the scale from grey to hot (red)
  - the threshold is at the top. When changing it, make sure you are clicking on the image you want to use

- dsistudio to make the fiber tracks
  - open dsistudio
  - click 3
  - open the image /Users/eballer/BBL/msdepression/templates/dti/1904002815.src.gz.odf8.f5.gqi.1.25.fib.gz
  - Step t3d, click "enable autotrack"
  - click "fibertracking"
  - so pretty!
  - To do special fibers, unhighlight the full brain
    -   Step t3d, select the fiber you want to use
    -   click "fibertracking"
  - To do a region of avoidance, go to step T3a
    -   click the white piece of paper
    - click ROA
    - in t3b, make a box, circle, or whatever on the brain
    - in T3d, click the same fiber tracking button, and now you have only the fibers that were not hit by your cutting!
    - click on and off the two fiber tracts to see what you gain/lose!
    - if you don't like what you have, delete it
    
#### 20210806

- Going to work on algorithm with Matt as Tim reprocesses all of the scans
- Doing this by taking a good, qc'd sample of mimosa, finding a way to register it to T1, and how to register T1 to MNI space (to piggyback lesion maps)
- can do the same with probability maps, though starting with lesion maps (as if they are just rois) could be a good way to start
- Tasks

[x] I need datalad on pmacs
   - so we can put our data here
   - steps:
```{bash}
ssh -Y eballer@sciget.pmacs.upenn.edu
cd ~
source pmacs-setup-project-user.sh # this was copied from the cubic-setup-project-user.sh script per Azeez
```

[x] I need to download hcp data into datalad
 
   
[x] connectomedb account
[x] dsistudio is local
   - use it to test reconstruction
[x] download 3 or 4 hcp scans
- things were going okay and then my dsi studio had a bug. Now I basically need to wait for my new computer to come in.

20210826
  [x] Chi sq comparing frequency of depression dx by phq2s vs phq9s
  [x] Finding out if there is some sort of a time where some people got phq2s at some point, and some got phq9s -> is there a reason? Same population, different results - not really
  [] literature review of ms depression, understand how depression was previously dx/described; n's, any explanation for somatic sxs?
      - does depression get better with MS tx? Suggesting that MS depression dx could have a lot to do with somatic stuff
      - Another thought - if PHQ9 is pos, but 2 is negative, even though we don't have indiv measures, it is actually splitting out anhedonia from other depressive sxs, which is interesting
[x] figure out how to register lesions to hcp scans
[x] ask Phil cook for how he registers older brains (with some WM lesions that can interfere with registration) onto MNI

20211007 
[x] made a script to take lesions (these are hand drawn) and use dsi studio to make subtraction maps. Now all I need are real files!

script: "/Users/eballer/BBL/msdepression/scripts/dsi_studio_bash.sh

```{bash dsi_studio_bash}
#!/bin/bash

#### Welcome to the Region_making party #########
### Pre: Must have a file with full paths to the lesioned data 
### Post: Within each directory specified by the lesioned data, will have a directory that has all tractography (ROA, ROI, Full)
### Uses: For use in MS depression - take a subject's mimosa lesions and generate the fiber tracts (individual fascicles) that run through it
#dependencies: Using dsi studio downloaded 9/2021

export PATH=${PATH}:/Applications/dsi_studio.app/Contents/MacOS/
template='/Users/eballer/BBL/msdepression/templates/dti/HCP1065.1mm.fib.gz'
default='/Users/eballer/BBL/msdepression/data/mimosa_file_paths'
fascicle_directory='/Users/eballer/BBL/msdepression/templates/dti/HCP_YA1065_tractography/'

if [ $# == 0 ]
then
    echo "We will use the default mimosa path file" $default
    lesion_file=$default
else  
    lesion_file=$1
fi
echo "File being read is "$lesion_file
echo "... Starting to make lesions ..."

lesion_paths=$(cat $lesion_file)

for lesion in ${lesion_paths}; do
    echo "Working on file" $lesion
    # make directory within parent directory for tracts
    parent_dir=$(echo $lesion | perl -pe s'/(.*)\/.*/$1/g')
    mask_prefix=$(echo $lesion | perl -pe s'/(.*)\/(.*).nii.gz/$2/g')
    if [ ! -d $parent_dir/fiber_tracking_maps ] 
    then
        mkdir $parent_dir/fiber_tracking_maps
    fi

    fiber_bundle_type_list=(
        "association"
        "cerebellum"
        "cranial_nerve"
        "projection"
        "commissural")
    for fiber_bundle_type in "${fiber_bundle_type_list[@]}"; do
        echo "Fiber bundle type is " $fiber_bundle_type
        echo "making directory" $parent_dir/fiber_tracking_maps/$fiber_bundle_type
        mkdir $parent_dir/fiber_tracking_maps/$fiber_bundle_type
        fascicles=$(ls ${fascicle_directory}/${fiber_bundle_type}/*.tt.gz)
        for fascicle in ${fascicles}; do
            echo "Fascicle is  " $fascicle
            fascicle_root_name=$(echo $fascicle | perl -pe s'/(.*)\/(.*).tt.gz/$2/g') 
            dsi_studio --action=ana --source=$template --tract=$fascicle --roa=$lesion --output=$parent_dir/fiber_tracking_maps/${fiber_bundle_type}/${fascicle_root_name}_${mask_prefix}_lesioned_ROA.tt.gz
            dsi_studio --action=ana --source=$template --tract=$fascicle --roi=$lesion --output=$parent_dir/fiber_tracking_maps/${fiber_bundle_type}/${fascicle_root_name}_${mask_prefix}_lesioned_ROI.tt.gz
            dsi_studio --action=ana --source=$template --tract=$fascicle --output=$parent_dir/fiber_tracking_maps/${fiber_bundle_type}/${fascicle_root_name}_${mask_prefix}_full.tt.gz
        done
        # $path/dsi_studio --action=ana --source=/Users/eballer/BBL/msdepression/templates/dti/HCP1065.1mm.fib.gz --tract=/Users/eballer/BBL/msdepression/templates/dti/HCP_YA1065_tractography/association/SLF2_R.tt.gz --roa=/Users/eballer/BBL/msdepression/templates/perfect_ms_subject/run-001/mimosa_binary_mask_0.25.nii.gz --output=/Users/eballer/BBL/msdepression/templates/roi_files_for_testing/SLF2R_lesioned_ROA.nii.gz
        # $path/dsi_studio --action=ana --source=/Users/eballer/BBL/msdepression/templates/dti/HCP1065.1mm.fib.gz --tract=/Users/eballer/BBL/msdepression/templates/dti/HCP_YA1065_tractography/association/SLF2_R.tt.gz --roi=/Users/eballer/BBL/msdepression/templates/perfect_ms_subject/run-001/mimosa_binary_mask_0.25.nii.gz --output=/Users/eballer/BBL/msdepression/templates/roi_files_for_testing/SLF2R_lesioned_ROI.nii.gz
        # $path/dsi_studio --action=ana --source=/Users/eballer/BBL/msdepression/templates/dti/HCP1065.1mm.fib.gz --tract=/Users/eballer/BBL/msdepression/templates/dti/HCP_YA1065_tractography/association/SLF2_R.tt.gz --output=/Users/eballer/BBL/msdepression/templates/roi_files_for_testing/SLF2R_full_ROI.nii.gz
    done
done

```


20211012
 [x] Working on getting a sample MS mimosa output into HCP space
 
    - Perfect subject in MS group
        - T1w: 
        ** with skull
        /Users/eballer/BBL/msdepression/templates/perfect_ms_subject/run-001/t1_n4.nii.gz
        ** skull stripped
        /Users/eballer/BBL/msdepression/templates/perfect_ms_subject/run-001/t1_n4_brain.nii.gz
        ** brainmask
        /Users/eballer/BBL/msdepression/templates/perfect_ms_subject/run-001/t1_n4_brainmask.nii.gz
        - mimosa file: /Users/eballer/BBL/msdepression/templates/perfect_ms_subject/run-001/mimosa_binary_mask_0.25.nii.gz
    - HCP T1 : /Users/eballer/BBL/msdepression/templates/dti/mni_icbm152_nlin_asym_09a/mni_icbm152_t1_tal_nlin_asym_09a.nii
  
  - recommended script from Phil Cook: 
    * antsRegistrationSyN.sh

### ---------- Narrative from Phil and Matt ------    
    If you have raw data, I would do antsBrainExtraction.sh, N4BiasFieldCorrection, then antsRegistrationSyN.sh (brain <-> brain)

Matt Cieslak  10:06 AM
would you do anything differently if you had a mask of small MS lesions?

Phil Cook  10:08 AM
You can mask them out by inverting and then passing mask with -x
10:08
So basically -x (brain_mask - lesions)

Matt Cieslak  10:09 AM
for the masks, we should use the skull-on, n4 image and -x’ed mask from antsBrainExtraction minus the lesions? as input to antsRegistrationSyN.sh (edited) 

Phil Cook  10:10 AM
If the lesions are small, masking them out should be sufficient
10:12
For larger lesions, you can try to impute "normal" tissue in various ways, then do the registration
10:17
There's different strategies for skull on vs off.
Some people use the skull-on image with a tight brain mask in fixed and moving space, to compensate for areas where the brain mask was not expansive enough.
I usually take the skull off, so that bits of skull don't get pulled inside the mask during nonlinear registration, and use a mask that is dilated a bit so that the edge of the brain is not the edge of the mask. Reasoning being that I want small misalignments at the edge of the brain to feature in the metric and its gradients

Matt Cieslak  10:19 AM
ok that’s what I thought
10:19
Sounds good @Erica Baller?
10:19
thanks as always @Phil Cook!

Erica Baller  10:20 AM
Mostly yes!
10:25
In theory it makes sense - practically a little more challenging. Is there any documentation or script that actually does this kind of thing step by step that I could use to get the more technical pieces?

Phil Cook  10:36 AM
https://github.com/ntustison/antsBrainExtractionExample
https://github.com/stnava/ANTsTutorial
The scripts are not too hard to use. An example N4 call:
N4BiasFieldCorrection -d 3 -i <input> -x <brain mask> -w <brain_mask minus lesions> -s 2 -c  [ 50x50x50x50,0.0000000001 ] -b [ 180 ] -o <output> --verbose 1
ntustison/antsBrainExtractionExample
Stars
4
Language
R
Added by GitHub
stnava/ANTsTutorial
Stars
27
Language
HTML
Added by GitHub
10:37
The trick with -x and -w for N4 is that you can include them in the mask (-x) but exclude them from the bias computation (-w is zero in lesions). This way they won't mess up bias correction but will get corrected. If you exclude voxels from -x, they do not get corrected
10:41
The shrink factor "-s" controls how to downsample the image. This makes the computation faster. For 1mm data I use 2, for sub-1mm data 4. The other parameter of interest is the initial spline spacing 180mm. Every level doubles resolution, so 180x90x45x22.5 . For a more detailed bias field, reduce this number or add an extra level. The default in ANTs scripts is 200 for adult human data, but I have found that bias fields have gotten worse over time, so I typically use 160-180
### --------- Done with excerpted text --------

Making my mask (for brain_mask minus lesions)

```{bash make_substraction_mask}
cd /Users/eballer/BBL/msdepression/templates/erica_created_for_hcp_reg
3dcalc -a t1_n4_brainmask.nii.gz -b mimosa_binary_mask_0.25.nii.gz -expr 'a-b' -prefix t1_n4_brain_minus_mimosa_binary_mask.nii.gz
```

Now Matt is asking if we need to dilate the mask more. 

So I did
```{bash}
3dmask_tool -input t1_n4_brainmask.nii.gz -prefix t1_n4_brainmask_d3.nii.gz -dilate_input 3

3dcalc -a t1_n4_brainmask.nii.gz -b mimosa_binary_mask_0.25.nii.gz -expr 'a-b' -prefix t1_n4_brain_minus_mimosa_binary_mask.nii.gz

3dcalc -a mni_icbm152_t1_tal_nlin_asym_09a.nii -b mni_icbm152_t1_tal_nlin_asym_09a_mask.nii -expr 'a*b' -prefix mni_icbm152_t1_tal_nlin_asym_09axbrainmask.nii
```
 The input going in will be:
 T1w: /Users/eballer/BBL/msdepression/templates/erica_created_for_hcp_reg/t1_n4_brain.nii.gz  
 Mask:/Users/eballer/BBL/msdepression/templates/erica_created_for_hcp_reg/t1_n4_brainmask_d3.nii.gz
 MNI HCP template: /Users/eballer/BBL/msdepression/templates/erica_created_for_hcp_reg/mni_icbm152_t1_tal_nlin_asym_09axbrainmask.nii  
 
 Transferred my directory onto pmacs, where ants should theoretically be
```{bash}
scp -r erica_created_for_hcp_reg/ eballer@transfer.pmacs.upenn.edu:/project/msdepression

ssh -Y eballer@scisub.pmacs.upenn.edu
cd /project/ms
xbash

sh ants_registration_code.sh  

```
 
Current code in ants_registration_code.sh
```{bash}
#!/bin/bash
### ANTS registration for MS Depression
##pre- requires ms patient T1, (eventually their mimosa), mni brain: mni_icbm152_t1_tal_nlin_asym_09a.
nii, mask (currently using the one that was dilated in afni, d3
## 3dmask_tool -input t1_n4_brainmask.nii.gz -prefix t1_n4_brainmask_d3.nii.gz -dilate_input 3
##Post - ms participant T1w registered to icbm_template space (and later mimosa as well)
##Uses - We have all of these great ms depression scans but they are in native space. This will get th
em into mni space so they can be used with HCP templates, both structural and diffusion
##Dependencies: Using ANTs/2.3.5

# Set up paths
#export ANTSPATH=/home/eballer/
#export PATH=${ANTSPATH}:$PATH

#### Run registration

#default T1: t1_n4_brain.nii.gz 
t1=t1_n4_brain.nii.gz 
#default brain mask: t1_n4_brainmask_d3.nii.gz
brain_mask=t1_n4_brainmask_d3.nii.gz
#default target/template hcp brain" mni_icbm152_t1_tal_nlin_asym_09axbrainmask.nii
mni_target_t1=mni_icbm152_t1_tal_nlin_asym_09axbrainmask.nii

#output
outfile_prefix=ms_t1_to_mni_icbm152
antsRegistrationSyN.sh -d 3 -f ${mni_target_t1} -m ${t1} -o ${outfile_prefix} -x ${brain_mask}

#now actually do the transform
mimosa_path=mimosa_binary_mask_0.25.nii.gz #this is from mimosa output
mimosa_mni_hcp_path=mimosa_binary_mask_0.25_mni_hcp.nii.gz #output file prefix
mni_hcp_path=mni_icbm152_t1_tal_nlin_asym_09axbrainmask.nii #template
affine_mat=ms_t1_to_mni_icbm1520GenericAffine.mat #affine output from last step
ms2mni_warp=ms_t1_to_mni_icbm1521Warp.nii.gz #warp from last step. There are a few, Warp, Warped Inver
seWarp, InverseWarped. I picked the one that matched my pnc output the closes

antsApplyTransforms -e 3 -d 3 -i ${mimosa_path} -o ${mimosa_mni_hcp_path} -r ${mni_hcp_path} -t ${ms2mni_warp} -t ${affine_mat} -n GenericLabel
```

20211013
  [x] made a copy of the pmacs stuff and put it locally for ease of making pictures
 [x] take the new lesion file, put it in dsi studio, and run the tractography to get the track loss. 
 [x] please please please git this
 [x] can also try to run with script from command line WORKS!
 [x] checked R/L orientation - cooking with gas

[x] there is a weird line in my pictures, so am going to try with different interpolation (Multilabel and Nearest Neighbor)
  - made new script: /project/msdepression/erica_created_for_hcp_reg/ants_transform_code.sh
  - to run:
  - ssh -Y eballer@scisub.pmacs.upenn.edu
  - module load ANTs/2.3.5
  - xbash
  - sh ants_transform_code.sh
  - if this doesn't work, type "export PATH=${ANTSPATH}:$PATH" at the command line
  
```{bash ants_transform_code.sh}
export PATH=${ANTSPATH}:$PATH
mimosa_path=mimosa_binary_mask_0.25.nii.gz #this is from mimosa output
mimosa_mni_hcp_path=mimosa_binary_mask_0.25_mni_hcp_gl.nii.gz #output file prefix
mni_hcp_path=mni_icbm152_t1_tal_nlin_asym_09axbrainmask.nii #template
affine_mat=ms_t1_to_mni_icbm1520GenericAffine.mat #affine output from last step
ms2mni_warp=ms_t1_to_mni_icbm1521Warp.nii.gz #warp from last step. There are a few, Warp, Warped Inver
seWarp, InverseWarped. I picked the one that matched my pnc output the closes

antsApplyTransforms -e 3 -d 3 -i ${mimosa_path} -o ${mimosa_mni_hcp_path} -r ${mni_hcp_path} -t ${ms2m
ni_warp} -t ${affine_mat} -n GenericLabel

mimosa_path=mimosa_binary_mask_0.25.nii.gz #this is from mimosa output
mimosa_mni_hcp_path=mimosa_binary_mask_0.25_mni_hcp_ml.nii.gz #output file prefix
mni_hcp_path=mni_icbm152_t1_tal_nlin_asym_09axbrainmask.nii #template
affine_mat=ms_t1_to_mni_icbm1520GenericAffine.mat #affine output from last step
ms2mni_warp=ms_t1_to_mni_icbm1521Warp.nii.gz #warp from last step. There are a few, Warp, Warped Inver
seWarp, InverseWarped. I picked the one that matched my pnc output the closes

antsApplyTransforms -e 3 -d 3 -i ${mimosa_path} -o ${mimosa_mni_hcp_path} -r ${mni_hcp_path} -t ${ms2m
ni_warp} -t ${affine_mat} -n MultiLabel

mimosa_path=mimosa_binary_mask_0.25.nii.gz #this is from mimosa output
mimosa_mni_hcp_path=mimosa_binary_mask_0.25_mni_hcp_nn.nii.gz #output file prefix
mni_hcp_path=mni_icbm152_t1_tal_nlin_asym_09axbrainmask.nii #template
affine_mat=ms_t1_to_mni_icbm1520GenericAffine.mat #affine output from last step
ms2mni_warp=ms_t1_to_mni_icbm1521Warp.nii.gz #warp from last step. There are a few, Warp, Warped Inver
seWarp, InverseWarped. I picked the one that matched my pnc output the closes

antsApplyTransforms -e 3 -d 3 -i ${mimosa_path} -o ${mimosa_mni_hcp_path} -r ${mni_hcp_path} -t ${ms2m
ni_warp} -t ${affine_mat} -n NearestNeighbor
```
  
  
  20211014
  
  [] Docker dsi studio
    - Tim downloaded 10/13
    
  [] Start making mimosa registrations for melissa's group
    - Melissa's QC'ed people 
  /project/pennsive_pacs2/repos/insurance/1yr_report_address.csv
  
  - first, filter the group to keep the people who have good mimosas (assumes that their T1s are also good, and pull out directory paths
  - make a file that contains people whose mimosas have quality 75, 100, and then combine
  
```{bash parse_mimosa_file.sh}

#n = 2336, corresponding to  958 subjects
more 1yr_report_address.csv | grep "mimosa" | grep ",,75.0" | perl -pe 's/(.*)\/mimosa.*/$1/' > mimosa_75_paths
more 1yr_report_address.csv | grep "mimosa" | grep ",,100.0" | perl -pe 's/(.*)\/mimosa.*/$1/' > mimosa_100_paths
cat mimosa_100_paths mimosa_75_paths > mimosa_100_and_75_paths
```
   New script for /project/msdepression/scripts/ants_registration_code.sh on pmacs. too nervous to git it
   
```{bash ants_registration_code.sh}


#read in directories
directories=$(cat $qc_file_path)

#extract name of directory and create shadow directory in my own data directory, with appropriate file names
for directory in $directories; do
        sub_sess_run=$(echo ${directory} | perl -pe 's/.*(sub.*)/$1/') #grab sub/sess/run
        echo $sub_sess_run
        echo "making dir" ${new_data_path}/${sub_sess_run}
        mkdir -p ${new_data_path}/${sub_sess_run}
        ln -s ${directory}/* ${new_data_path}/${sub_sess_run}
        cp ${mni_t1_path} ${new_data_path}/${sub_sess_run}

        #go into directory for afni stuff
        cd ${new_data_path}/${sub_sess_run}

        #make the dilated mask
        3dmask_tool -input ${brain_mask} -prefix ${brain_mask_dilated} -dilate_input ${mask_dilation}

        #multiply with mni t1 to get appropriate coverage
        3dcalc -a ${brain_mask_dilated} -b ${mni_t1_root}.nii -expr 'a*b' -prefix ${mni_t1_target}

        # a typical file 
#### Run registration

        antsRegistrationSyN.sh -d 3 -f ${mni_t1_target} -m ${t1} -o ${outfile_prefix} -x ${brain_mask_dilated}

        #now actually do the transform${brain
        mimosa_path=mimosa_binary_mask_0.25.nii.gz #this is from mimosa output
        mimosa_mni_hcp_path=mimosa_binary_mask_0.25_mni_hcp.nii.gz #output file prefix
        affine_mat=ms_t1_to_mni_icbm1520GenericAffine.mat #affine output from last step
        ms2mni_warp=ms_t1_to_mni_icbm1521Warp.nii.gz #warp from last step. There are a few, Warp, Warped InverseWarp, InverseWarped. I picked the one that matched my pnc output the closes

        antsApplyTransforms -e 3 -d 3 -i ${mimosa_path} -o ${mimosa_mni_hcp_path} -r ${mni_t1_target} -t ${ms2mni_warp} -t ${affine_mat} -n MultiLabel
        cd ${base_dir}
done

```
   
   20211015
   [x] Need to test ants registration code. If all goes well, hope to run this over the weekend
   [x]just need to add ants to my home directory somehow. But everything up to that seems to work
   
 
   
   Last update 20211015
   
   /project/msdepression/scripts/ants_registration_code.sh
```{bash ants_registration_code}

#!/bin/bash
### ANTS registration for MS Depression
##pre- requires ms mimosa file that contains the directory, mni brain: mni_icbm152_t1_tal_nlin_asym_09a.nii
##Post - ms participant T1w and mimosa registered to icbm_template space
##Uses - We have all of these great ms depression scans but they are in native space. This will get them into mni space so t
hey can be used with HCP templates, both structural and diffusion
#Steps
## 1 - take all file paths to data with good qc, extract file paths, and make shadow directories with linksin my local data 
directory
## 2 - make the dilated mask
     #####mask (currently using the one that was dilated in afni, d3
     ## 3dmask_tool -input t1_n4_brainmask.nii.gz -prefix t1_n4_brainmask_d3.nii.gz -dilate_input 3
## 3 - for each subject, run the registration, and then apply the transpforms
##Dependencies: Using ANTs/2.3.5
# Set up paths
module load ANTs/2.3.5
#export ANTSPATH="/appl/ANTs/2.3.5"
#export PATH=${ANTSPATH}:$PATH
export ANTSPATH=/appl/ANTs-2.3.5/bin

#######if it doesn't work, fix this ###
#export PATH=${ANTSPATH}:$PATH




#set default templatesfiles/paths

base_dir="/project/msdepression/scripts"

#Primary directorie - CHANGE THESE IF ANYTHING EVER CHANGES, IT WILL UPDATE FILE NAMES BELOW

qc_file_path='/project/msdepression/data/melissa_martin_files/csv/minimelissa_list_for_testing_n3'
mni_t1_root='mni_icbm152_t1_tal_nlin_asym_09a'
mask_dilation=3
brain_mask_root="t1_n4_brainmask"
t1="t1_n4_reg_brain_ws.nii.gz"
mimosa_root="mimosa_binary_mask_0.25"
new_data_path='/project/msdepression/data/subj_directories/'
mni_t1_direc="/project/msdepression/templates/mni_icbm152_nlin_asym_09a/"

#set outfile prefix
outfile_prefix=ms_t1_to_mni_icbm152

#for transform
mimosa_path=${mimosa_root}.nii.gz #this is from mimosa output
mimosa_mni_hcp_path=${mimosa_root}_mni_hcp.nii.gz #output file prefix
affine_mat=${outfile_prefix}0GenericAffine.mat #affine output from last step
ms2mni_warp=${outfile_prefix}1Warp.nii.gz #warp from last step. There are a few, Warp, Warped InverseWarp, InverseWarped. I 
picked the one that matched my pnc output the closes


#making some secondary files
mni_t1_path="${mni_t1_direc}/${mni_t1_root}.nii"
mni_t1_target="${mni_t1_root}xbrainmask.nii"
brain_mask="${brain_mask_root}.nii.gz"
brain_mask_dilated="${brain_mask_root}_d${mask_dilation}.nii.gz"

#read in directories
directories=$(cat $qc_file_path)

#extract name of directory and create shadow directory in my own data directory, with appropriate file names
for directory in $directories; do
        sub_sess_run=$(echo ${directory} | perl -pe 's/.*(sub.*)/$1/') #grab sub/sess/run
        echo $sub_sess_run
        echo "making dir" ${new_data_path}/${sub_sess_run}
        mkdir -p ${new_data_path}/${sub_sess_run}
        ln -s ${directory}/* ${new_data_path}/${sub_sess_run}
        cp ${mni_t1_direc}/${mni_t1_root}* ${new_data_path}/${sub_sess_run}

        #go into directory for afni stuff
        cd ${new_data_path}/${sub_sess_run}

        	#make the dilated mask
        	3dmask_tool -input ${brain_mask} -prefix ${brain_mask_dilated} -dilate_input ${mask_dilation}

        	#multiply with mni t1 to get appropriate coverage - this is the problem!!! 
        	3dcalc -a ${mni_t1_root}.nii -b ${mni_t1_root}_mask.nii -expr 'a*b' -prefix ${mni_t1_target}

         
		#### Run registration

        	antsRegistrationSyN.sh -d 3 -f ${mni_t1_target} -m ${t1} -o ${outfile_prefix} -x ${brain_mask_dilated}

        	#now actually do the transform${brain
       
       	 	antsApplyTransforms -e 3 -d 3 -i ${mimosa_path} -o ${mimosa_mni_hcp_path} -r ${mni_t1_target} -t ${ms2mni_wa
rp} -t ${affine_mat} -n GenericLabel
        
	cd ${base_dir}
done

```

20211019
Still having issues with transform, running slow, realizing that I had multilable instead of generic label. Will try that. Still worried I will have trouble getting it to work.

Got it to run by putting a bsub inside the script!

20211026
- Now trying to get dsi studio to run on pmacs. 
- scp -r /Users/eballer/msdepression/templates/dti to /project/msdepression/templates

Made a list of the paths to all the mimosa masks
ls /project/msdepression/data/subj_directories/*/*//*/mimosa*mn* > mimosa_binary_masks_hcp_space_20211026_n2336

Then moved to melissa's data directory
cp mimosa_binary_masks_hcp_space_20211026_n2336 ../melissa_martin_files/csv/.

20211027
 - fixing dsi studio. Goal today is to figure out how to bsub it because it takes a long time. steps
 
```{bash}
ssh -Y eballer@scisub.pmacs.upenn.edu
cd /project/msdepression/scripts
xbash

```
 
 
 Also needed to generate a list of niftis (i.e. tracts is voxel space). Did this locally and scp'ed to templates/dti
 
```{bash}
#!/bin/bash

#### Welcome to the Region_making party #########
### Pre: Must have a file with full paths to the lesioned data 
### Post: Within each directory specified by the lesioned data, will have a directory that has all tractography (ROA, ROI, Full)
### Uses: For use in MS depression - take a subject's mimosa lesions and generate the fiber tracts (individual fascicles) that run through it
#dependencies: Using dsi studio downloaded 9/2021

export PATH=${PATH}:/Applications/dsi_studio.app/Contents/MacOS/
template='/Users/eballer/BBL/msdepression/templates/dti/HCP1065.1mm.fib.gz'
default='/Users/eballer/BBL/msdepression/data/mimosa_file_paths'
fascicle_directory='/Users/eballer/BBL/msdepression/templates/dti/HCP_YA1065_tractography/'

if [ $# == 0 ]
then
    echo "We will use the default mimosa path file" $default
    lesion_file=$default
else  
    lesion_file=$1
fi
echo "File being read is "$lesion_file
echo "... Starting to make lesions ..."

lesion_paths=$(cat $lesion_file)

for lesion in ${lesion_paths}; do
    echo "Working on file" $lesion
    # make directory within parent directory for tracts
    #parent_dir=$(echo $lesion | perl -pe s'/(.*)\/.*/$1/g')
    mask_prefix=$(echo $lesion | perl -pe s'/(.*)\/(.*).nii.gz/$2/g')
    if [ ! -d $parent_dir/fiber_tracking_maps ] 
    then
        mkdir $parent_dir/fiber_tracking_maps
    fi

    fiber_bundle_type_list=(
        "association"
        "cerebellum"
        "cranial_nerve"
        "projection"
        "commissural")
    for fiber_bundle_type in "${fiber_bundle_type_list[@]}"; do
        echo "Fiber bundle type is " $fiber_bundle_type
        echo "making directory" $parent_dir/fiber_tracking_maps/$fiber_bundle_type
        #mkdir $parent_dir/fiber_tracking_maps/$fiber_bundle_type
        fascicles=$(ls ${fascicle_directory}/${fiber_bundle_type}/*.tt.gz)
        for fascicle in ${fascicles}; do
            echo "Fascicle is  " $fascicle
            fascicle_root_name=$(echo $fascicle | perl -pe s'/(.*)\/(.*).tt.gz/$2/g') 
          #  dsi_studio --action=ana --source=$template --tract=$fascicle --roa=$lesion --output=$parent_dir/fiber_tracking_maps/${fiber_bundle_type}/${fascicle_root_name}_${mask_prefix}_lesioned_ROA.tt.gz
          #  dsi_studio --action=ana --source=$template --tract=$fascicle --roi=$lesion --output=$parent_dir/fiber_tracking_maps/${fiber_bundle_type}/${fascicle_root_name}_${mask_prefix}_lesioned_ROI.tt.gz
           # dsi_studio --action=ana --source=$template --tract=$fascicle --output=${fascicle_directory}/${fiber_bundle_type}/${fascicle_root_name}_${mask_prefix}_full.tt.gz
            dsi_studio --action=ana --source=$template --tract=$fascicle --output=${fascicle_directory}/${fiber_bundle_type}/${fascicle_root_name}.nii.gz
        done
        # $path/dsi_studio --action=ana --source=/Users/eballer/BBL/msdepression/templates/dti/HCP1065.1mm.fib.gz --tract=/Users/eballer/BBL/msdepression/templates/dti/HCP_YA1065_tractography/association/SLF2_R.tt.gz --roa=/Users/eballer/BBL/msdepression/templates/perfect_ms_subject/run-001/mimosa_binary_mask_0.25.nii.gz --output=/Users/eballer/BBL/msdepression/templates/roi_files_for_testing/SLF2R_lesioned_ROA.nii.gz
        # $path/dsi_studio --action=ana --source=/Users/eballer/BBL/msdepression/templates/dti/HCP1065.1mm.fib.gz --tract=/Users/eballer/BBL/msdepression/templates/dti/HCP_YA1065_tractography/association/SLF2_R.tt.gz --roi=/Users/eballer/BBL/msdepression/templates/perfect_ms_subject/run-001/mimosa_binary_mask_0.25.nii.gz --output=/Users/eballer/BBL/msdepression/templates/roi_files_for_testing/SLF2R_lesioned_ROI.nii.gz
        # $path/dsi_studio --action=ana --source=/Users/eballer/BBL/msdepression/templates/dti/HCP1065.1mm.fib.gz --tract=/Users/eballer/BBL/msdepression/templates/dti/HCP_YA1065_tractography/association/SLF2_R.tt.gz --output=/Users/eballer/BBL/msdepression/templates/roi_files_for_testing/SLF2R_full_ROI.nii.gz
    done
done
```
 20211028 
 
 Big moves! Currently running these two scripts and they have been git'ed
```{bash dsi_studio_bash.sh}
#!/bin/bash

#### Welcome to the Region_making party #########
### Pre: Must have a file with full paths to the lesioned data 
### Post: Within each directory specified by the lesioned data, will have a directory that has all tractography (ROA, ROI, Full)
### Uses: For use in MS depression - take a subject's mimosa lesions and generate the fiber tracts (individual fascicles) that run through it
#dependencies: Using dsi studio from docker, sif created by Tim 10/26/2021
#export PATH=${PATH}:/Applications/dsi_studio.app/Contents/MacOS/
set -euf -o pipefail

export ITK_GLOBAL_DEFAULT_NUMBER_OF_THREADS=$LSB_DJOB_NUMPROC
num_cores=1

#set default paths 
template='/project/msdepression/templates/dti/HCP1065.1mm.fib.gz'
default='/project/msdepression/data/melissa_martin_files/csv/mimosa_binary_masks_hcp_space_20211026_n2336'
#default='/project/msdepression/data/melissa_martin_files/csv/erica_mini_mimosa_paths_n3'
fascicle_directory='/project/msdepression/templates/dti/HCP_YA1065_tractography/'

if [ $# == 0 ]
then
    echo "We will use the default mimosa path file" $default
    lesion_file=$default
else  
    lesion_file=$1
fi
echo "File being read is "$lesion_file
echo "... Starting to make lesions ..."

lesion_paths=$(cat $lesion_file)

# loop through each mimosa lesion map; lesion paths contain full paths to mimosa files in hcp space
job_count=1
for lesion in ${lesion_paths}; do
	echo "working on ${lesion} ..."  
	bsub -J "job_${job_count}" -n ${num_cores} -o /project/msdepression/scripts/logfiles/out_roa_${job_count}.out /project/msdepression/scripts/indiv_mimosa_lesion_dsi_s
tudio_script.sh $lesion
   	((job_count+=1))
done

```
 
and this calls 
```{bash indiv_mimosa_lesion_dsi_studio_script.sh}

### The Inner Script... Doing all the dsi studio action for each individual mimosa brain ###

### Pre: path to an individual's mimosa lesion in HCP/MNI space
### Post: Filtered tracts; ROA and ROI voxel maps/niftis that can be used for data analysis
### Uses: In trying to find a way to speed everything along, it made the most sense to separate this piece of the script out. 
#          - it takes a subject's mimosa path, and makes a fiber_tracking_map directory as well as sub directories for each bundle type
#          - it then runs ROA/ROI filtration and makes output maps. 

#set -euf -o pipefail
module load singularity
export PATH=${PATH}:/Applications/dsi_studio.app/Contents/MacOS/
export ITK_GLOBAL_DEFAULT_NUMBER_OF_THREADS=$LSB_DJOB_NUMPROC
num_cores=1

#set default directory/templates. This will change when we use local, personal dwi
template='/project/msdepression/templates/dti/HCP1065.1mm.fib.gz'
fascicle_directory='/project/msdepression/templates/dti/HCP_YA1065_tractography/'

if [ $# == 0 ]
then
    echo "You did not enter a file. Make sure your call makes sense"
else  
    lesion=$1

	echo "File being read is "$lesion
	echo "... Starting to make tracts"
# make directory within parent directory for tracts
    	parent_dir=$(echo ${lesion} | perl -pe s'/(.*)\/.*/$1/g')
    	echo "$parent_dir"
	mask_prefix=$(echo ${lesion} | perl -pe s'/(.*)\/(.*).nii.gz/$2/g')
    	echo $mask_prefix
	if [ ! -d $parent_dir/fiber_tracking_maps ] 
    	then
        	mkdir $parent_dir/fiber_tracking_maps
    	fi

    #make sub directories for each bundle type, so within fiber_tracking_maps, there will be subdirectories for each type of map
	fiber_bundle_type_list="association cerebellum cranial_nerve projection commissural"	
    	for fiber_bundle_type in ${fiber_bundle_type_list}; do
        	echo "Fiber bundle type is " $fiber_bundle_type
        	echo "making directory" $parent_dir/fiber_tracking_maps/$fiber_bundle_type
        	mkdir $parent_dir/fiber_tracking_maps/$fiber_bundle_type
        	fascicles=$(ls ${fascicle_directory}/${fiber_bundle_type}/*.tt.gz)
    

	# set a job counter to be used to name the jobs
		job_count=1
		for fascicle in ${fascicles}; do
            		echo "Fascicle is  " $fascicle
            		fascicle_root_name=$(echo $fascicle | perl -pe s'/(.*)\/(.*).tt.gz/$2/g') 
   			echo  "Fascicle root name is ${fascicle_root_name}" 
    	    		singularity exec --bind /project /project/singularity_images/dsistudio_latest.sif dsi_studio --action=ana --source=$template --tract=$fascicle --roa=
$lesion --output=$parent_dir/fiber_tracking_maps/${fiber_bundle_type}/${fascicle_root_name}_${mask_prefix}_lesioned_ROA.tt.gz
            		singularity exec --bind /project /project/singularity_images/dsistudio_latest.sif dsi_studio --action=ana --source=$template --tract=$fascicle --roi=
$lesion --output=$parent_dir/fiber_tracking_maps/${fiber_bundle_type}/${fascicle_root_name}_${mask_prefix}_lesioned_ROI.tt.gz
           
     			singularity exec --bind /project /project/singularity_images/dsistudio_latest.sif dsi_studio --action=ana --source=$template --tract=$fascicle --roa=
$lesion --output=$parent_dir/fiber_tracking_maps/${fiber_bundle_type}/${fascicle_root_name}_${mask_prefix}_lesioned_ROA.nii.gz
           		singularity exec --bind /project /project/singularity_images/dsistudio_latest.sif dsi_studio --action=ana --source=$template --tract=$fascicle --roi=
$lesion --output=$parent_dir/fiber_tracking_maps/${fiber_bundle_type}/${fascicle_root_name}_${mask_prefix}_lesioned_ROI.nii.gz
 
		# I have removed this line to save space. All hcp fibers are in the directory: /project/msdepression/templates/dti/HCP_YA1065_tractography/ . Can uncomment t
his if at some point I need to make them for each individual, like when we have their personal DWI
#singularity exec --bind /project /project/singularity_images/dsistudio_latest.sif dsi_studio --action=ana --source=$template --tract=$fascicle --output=$parent_dir/fiber_tr
acking_maps/${fiber_bundle_type}/${fascicle_root_name}_${mask_prefix}_full.tt.gz
			((job_count+=1))
		done
    	done
fi
```

20211029
[x] 3dmaskave, get the # of voxels into csvs

scripts are made, just have no more space on pmacs, so waiting for them to make space for me and then I can do this.

20211103
[x] start working on getting these files into r, MAKE SURE TO ADD A ZERO in the read in line = NA -> 0!!!

20211104
[x] ton of weird errors that are inconsistent with afni. Need to figure out if they are real or fake.

Here is how I figured out the failed subj/session #
```{bash}
more 3dmaskav_*.out | grep "ERROR" | perl -pe 's/.*\/project.*\/(sub-.*\/ses-.*)\/run.*/$1/' | sort -u > failed_3dmaskave_n243_20211103
```

Have identified the people who failed, it looks like their lesions are empty for these
```{bash}
more failed_3dmaskave_n243_20211103 | perl -pe 's/(.*)/\/project\/msdepression\/data\/subj_directories\/$1\/run-001\/mimosa_binary_mask_0.25_mni_hcp.nii.gz/' > failed_full_mimosa_paths_n243
```

[x]Going to try rerunning these specifically from the dsi_studio command, using these files instead of what is already there

Have to make a file that contains all the full volumes of each of the fascicles

```{bash make_streamline_volumes_for_template.sh}
### Make streamline volumes ###

### Pre: All template streamlines must have been made in dsi studio (these are the nii files)
### Post: fiber_volume_values.csv that contains the name of the fiber bundle and its volume
### Uses: Will be getting the volumes of the streamlines for use in later density analyses
### Dependencies: This script requires afni to be installed.

module load afni_openmp/20.1
export ITK_GLOBAL_DEFAULT_NUMBER_OF_THREADS=$LSB_DJOB_NUMPROC
num_cores=1

directory='/project/msdepression/templates/dti/HCP_YA1065_tractography/'
outfile=${directory}/fiber_volume_values.csv

#remove outfile if it exists
rm -f ${outfile}

#make the file again
touch ${outfile}
echo "fascicle,volume" >> ${outfile}
   
#go through each fiber, get volume, and store it in csv
fiber_bundle_type_list="association cerebellum cranial_nerve projection commissural"	
for fiber_bundle_type in ${fiber_bundle_type_list}; do
	echo "Fiber bundle type is " $fiber_bundle_type
fascicle_volumes=$(ls ${directory}/${fiber_bundle_type}/*.nii*)
        for fascicle in ${fascicle_volumes}; do
            fascicle_prefix=$(echo $fascicle | perl -pe 's/.*\/(.*).nii.*/$1/g')
            volume=$(3dmaskave -quiet -mask SELF -sum ${fascicle})
            echo "${fascicle_prefix},$volume" >> ${outfile}
        done
done
```


output of the above script
```{bash}
fascicle,volume
AF_L,35716
AF_R,15249
C_FPH_L,2569
C_FPH_R,2760
C_FP_L,14457
C_FP_R,21386
C_PH_L,3171
C_PHP_L,1900
C_PHP_R,4612
C_PH_R,2593
C_R_L,2666
C_R_R,5181
EMC_L,7344
EMC_R,5641
FAT_L,27142
FAT_R,15510
IFOF_L,30311
IFOF_R,34880
ILF_L,27401
ILF_R,36327
MdLF_L,7637
MdLF_R,5744
PAT_L,10921
PAT_R,13976
SLF1_L,9836
SLF1_R,13482
SLF2_L,26947
SLF2_R,37091
SLF3_L,10053
SLF3_R,15526
UF_L,7607
UF_R,7744
VOF_L,5681
VOF_R,4079
CB_L,45470
CB_R,43251
ICP_L,4963
ICP_R,4449
MCP,16514
SCP,4315
V,11299
CNIII_L,563
CNIII_R,486
CNII_L,1097
CNII_R,1415
CNVIII_L,1034
CNVIII_R,968
CNVII_L,298
CNVII_R,276
CNV_L,817
CNV_R,995
AR_L,3082
AR_R,1935
CBT_L,4609
CBT_R,6146
CPT_F_L,18693
CPT_F_R,34955
CPT_O_L,9022
CPT_O_R,7015
CPT_P_L,24377
CPT_P_R,27829
CS_A_L,26114
CS_A_R,21542
CS_P_L,5526
CS_P_R,6231
CS_S_L,31034
CS_S_R,34141
CST_L,20476
CST_R,16388
DRTT_L,14986
DRTT_R,17163
F_L,5175
F_R,8018
ML_L,10871
ML_R,9139
OR_L,6876
OR_R,5510
RST_L,14766
RST_R,11890
TR_A_L,20628
TR_A_R,14840
TR_P_L,4402
TR_P_R,4748
TR_S_L,39767
TR_S_R,37036
AC,26517
CC,390601
```

2021104
[x] need to see if total number of fibers in a bundle = ROA + ROI - NO
[] if all these work, our first analyses will be depressed vs non total , total fiber volume lost in lesions, then specificity. WOuld look at ratios ROI/total

To initialize Rstudio on pmacs
```{bash}
source  /project/bbl_projects/apps/default_modules.sh
conda activate rstudio
xbash
rstudio
### OR ###
cd /project/msdepression/scripts
source load_rstudio
```

To make list of all roi files
```{bash}
cd /project/msdepression/data/melissa_martin_files/csv/
more mimosa_binary_masks_hcp_space_20211026_n2336 | perl -pe 's/(.*)mimosa_bin.*/$1fiber_tracking_maps\/fiber_volume_values_roi\.csv/' > roi_fiber_volumes_n2336
```

Rscript to make df with lesions

```{r Roi_ratio_regressions}
### ROA Ratio Regressions ###

#####
## Pre: /project/msdepression/data/melissa_martin_files/csv/roi_fiber_volumes_n2336, which contains full paths to the ROI files, can be ammended to do ro
## Post: Analysis
## Uses: 1) reads in the ROIs, puts them in a data frame (columns are accession num/date/each fascicle), one row per subjected per date
#        2) Performers univariate analyses, depression diagnosis versus not
## Dependencies: R 3.6.3

#include packages
library(dbplyr)

#set directories
homedir<-'/project/msdepression/'

#analysis type
region_type="roi"

#read in template fascicle volumes
template_full_volumes <- read.csv(paste0(homedir, '/templates/dti/HCP_YA1065_tractography/fiber_volume_values.csv'), header = T)
fascicle_names <- template_full_volumes$fascicle

### Read in file with all full paths to region volumes
region_volume_csv <- read.table(paste0(homedir, '/data/melissa_martin_files/csv/', region_type, '_fiber_volumes_n2336'), header = F, stringsAsFactors = F)
region_volume_csv$V1 <- as.character(region_volume_csv$V1)

#outfile, named for number of subjects
outfile <- paste0(homedir, "/results/fascicle_volumes_all_subjects_", region_type, "_n", dim(region_volume_csv)[1], ".csv")

#make data frame, 1 row per subject, num rows = num rows in region_volume_csv
volumes_df <- data.frame(matrix(nrow = dim(region_volume_csv)[1], ncol = 89))
names(volumes_df) <- c("ACCESSION_NUM", "EXAM_DATE", as.character(fascicle_names))
#loop through region_volume_csv, read in df corresponding to each row of region_volume_csv, extract accession num and date,
## and transpose fiber volumes from column to rows. append accession num/date/region_volumes row into big matrix

for (subj in 1:dim(region_volume_csv)[1]) {
  file_path <- region_volume_csv$V1[subj]
  region_volume_data <- read.csv(file_path, header = T, sep = ",")
  accession_num<- region_volume_data[1,1]
  date <- region_volume_data[1,2]
  volumes <- t(region_volume_data[,4])
  volumes[is.na(volumes)] <- 0
  volumes <- volumes/template_full_volumes$volume
  row_to_add <- cbind(accession_num, date, volumes)
  volumes_df[subj,]<- row_to_add
}

write.csv(file=outfile, volumes_df, quote = FALSE, row.names = FALSE)



```


To see the frequencies of the lesions
```{bash MC plot}
library(reshape2)
library(ggplot2)
df <- read.csv("fascicle_volumes_all_subjects_roi_n2336.csv", header=TRUE)

m.df <- melt(df, id.vars = c("ACCESSION_NUM", "EXAM_DATE"))
lesioned <- subset(m.df, value > 0)

ggplot(lesioned, aes(x=value)) + geom_histogram() + facet_wrap(~variable)
```



20211107
[x] need to divide the ROIs by the total volume 

20211109
[x] need to change the date format in my regular dac pull
 - pulled the results down to my local machine
```{bash}
scp eballer@transfer.pmacs.upenn.edu:/project/msdepression/results/fascicle_volumes_all_subjects_roi_n2336.csv .
```
 [x] age
 [x] sex
 [x] depression
 [x] repeated measures
 [x] exclusions flow chart
   - compare # good phq2s/9s in the direction of depression
 [x] meeting with matt taki setup
 
 20211117
  making a list of my people with depressed/not depressed with melissa rating
```{bash}
#done locally on /Users/eballer/BBL/msdepression/data/dac
more 1yr_report_address.csv | grep "mimosa" | perl -pe 's/.*sub-(.*)\/ses-(.*)\/run.*gz,.*,(.*),20.*/$1,$2,$3/' > just_empi_date_rating

# to count how many people are unique in our gorup of people with qc, n = 1059
 more 1yr_report_address.csv | grep "mimosa" | perl -pe 's/.*sub-(.*)\/ses-(.*)\/run.*gz,.*,(.*),20.*\/pro.*/$1,$2,$3/' | cut -f 1 -d ',' | sort -u | wc


```
 
 20211118
 - my dac summary thing is getting too meaty and I can't find anything anymore. Making a new rmd with analyses.
 [x] msdepression_regressions_started_20211118.Rmd
 
20211123
[] make regression function

[] need to get total # of lesions - this will be tough, need taki's code. Not to do right now - sydney to look into

20211201
[x] trying to figure out why some people completely bottom out with their lesions. Looks like some fail registration, though I'm not really sure why.
[] make depression mask

plan to calculate depression network overlap:

1) take the depression network map and 3dresample it into the voxel space of any of the fascicle masks
2) for each fascicle mask, multiply the mask by the resampled depression network. then count the nonzero voxels. The number of nonzero voxels is the volume overlap of that fascicle with the depression network
3) plot the histogram of depression network overlap volumes. Hopefully there will be a notch in it where we can say anything beneath X mm^3 is not connected to the depression network

on local machine, make binary mask
```{bash}
cd /Users/eballer/BBL/msdepression/templates/harvard_depression
3dcalc -a Depression_Clust_mask_rois.nii.gz -expr 'ispositive(a)' -prefix Depression_Clust_mask_roi_binarized.nii.gz
scp -r harvard_depression eballer@transfer.pmacs.upenn.edu:/project/msdepression/templates/.
```

On cluster
```{bash}
cd /project/msdepression/templates/harvard_depression
3dresample -master AF_L.nii.gz -prefix "resampled_hcp_space_harvard_dep_mask.nii.gz" -input Depression_Clust_mask_roi_binarized.nii.gz
```

code for calc_vol_fascicles_within_depression_mask.sh 
```{bash calc_vol_fascicles_within_depression_mask}
#### calculate volume of fascicles within the depression network ####
### Pre: All streamlines must have been made in dsi studio (these are the nii files)
### Post: A depression mask resampled to template space, file <streamline_volume_within_dep_network>, containing each fascicle and its corresponding % within depression netw
ork
### Uses: Trying to figure out which fascicles are in the depression network for dimensionality reduction for use in later regressions (i.e. decrease # comparisons by only l
ooking at fascicles within depression network)
### Dependencies: This script requires afni to be installed (currently using 20.1)

#set outfile
outfile="/project/msdepression/results/streamline_volume_within_dep_network.csv"

#set template directories, will be making our resampled mask from within this
template="Depression_Clust_mask_roi_binarized.nii.gz"
template_dir="/project/msdepression/templates/harvard_depression"
resampled_filename="resampled_${template}"
template_fullpath="/project/msdepression/templates/harvard_depression/${template}"

#set fascicle directory
fascicle_direc="/project/msdepression/templates/dti/HCP_YA1065_tractography/"
fascicle_type="association"
fascicle_for_resampling="AF_L.nii.gz"

#set home directory
homedir="/project/msdepression/scripts/"

#initiate csvs
rm -f $outfile
touch $outfile
echo "fascicle,num_voxels_total,non_zero_voxels_in_dep_map,prop_in_mask" >> $outfile

#resample Depression_Clust_amsk_roi_binarized.nii.gz to match sample fascicle - AF_L.nii.gz
if [ -f "${template_dir}/${resampled_filename}" ]; then
	rm -f ${template_dir}/${resampled_filename}
fi
3dresample -master ${fascicle_direc}/${fascicle_type}/${fascicle_for_resampling} -prefix ${template_dir}/${resampled_filename} -input ${template_fullpath} -rmode NN

#go through each fiber, get volume, and store it in csv
fiber_bundle_type_list="association cerebellum cranial_nerve projection commissural"
for fiber_bundle_type in ${fiber_bundle_type_list}; do
    echo "Fiber bundle type is " $fiber_bundle_type
    fascicle_volumes=$(ls ${fascicle_direc}/${fiber_bundle_type}/*.nii* | grep -v "dep_mask") #list all files, exclude depression ones
    for fascicle in ${fascicle_volumes}; do
	    fascicle_prefix=$(echo $fascicle | perl -pe 's/.*\/(.*).nii.gz/$1/g')
	    num_voxels_whole_mask=$(3dmaskave -quiet -mask SELF -sum ${fascicle})

	    #remove previous mask if already made
	    if [ -f "${fascicle_direc}/${fascicle_type}/${fascicle_prefix}xdep_mask.nii.gz" ]; then
		    rm -f ${fascicle_direc}/${fascicle_type}/${fascicle_prefix}xdep_mask.nii.gz
	    fi

	    3dcalc -a ${template_dir}/${resampled_filename} -b ${fascicle} -expr 'a*b' -prefix ${fascicle_direc}/${fascicle_type}/${fascicle_prefix}xdep_mask.nii.gz
	    num_nonzero_volumes=$(3dmaskave -quiet -mask SELF -sum ${fascicle_direc}/${fascicle_type}/${fascicle_prefix}xdep_mask.nii.gz)
	    prop_in_mask=$(echo ${num_nonzero_volumes}/${num_voxels_whole_mask} | bc -l)
	    echo "num_voxels" $num_voxels_whole_mask "num_nonzero" $num_nonzero "prop_in_mask" $prop_in_mask

	    echo "${fascicle_prefix},${num_voxels_whole_mask},${num_nonzero_volumes},${prop_in_mask}" >> $outfile
    done
done
```


Moved back to home directory
```{bash}
#from local machine
scp eballer@transfer.pmacs.upenn.edu:/project/msdepression/results/streamline_volume_within_dep_network.csv .

#moved 
```

get volume in dep network per fascicle
20211202
[] figure out why registration broke