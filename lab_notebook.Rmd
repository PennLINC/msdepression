---
title: "R Notebook for MSDepression Project"
output:
  html_notebook
---

#### 20201008

First, need to summarize data

1) Got data into csv format
  - Opened /Users/eballer/Documents/Penn T32/MS_Depression_Ted_Taki/Documents/*xls in excel and saved as csv
2)
```{move_data bash}
cd /Users/eballer/BBL/msdepression/data/
mkdir dac
cp /Users/eballer/Documents/Penn T32/MS_Depression_Ted_Taki/Documents/*csv .
```

3) In R, started /Users/eballer/BBL/msdepression/dac_summary.Rmd to summarize data

** during the last iteration of de-identifying the DAC, the PHQ-9 scores all vanished. Will need to ask for them to be re-added.
** also, number of people dropped by 50% (from 36277 to 16383)

#### 20201012

Continued with descriptives

  - Read in Melissa's data sheet.
  - subsetted EMPI and Accession # (since our EMPI's are deidentified)
  - Merged with my datasheet on Accession #
  - "PatientID == EMPI"

Merged Melissa's data with mine to get empis.

#### 20201013

[x] Figure out how many people with repeat mrns - to remove doubles. Will need to remove duplicates.

#### 20201027

Going back and forth a lot with DAC people, should have a new update soon. Big thing will be to parse PHQ2/9. We will get all of them but have to tie them to their appropriate scans


#### 20201117

Lots of back and forth with DAC, significantly less people in my pull that limited its pull to people who had G35 codes only. Went back to emails with Sunil (Taki involved). See email below.

---

I think my focus was more on the images and using the challenging radiology data.
So I took a quick look at the codes and files that I might have sent or used. Unfortunately, I can’t remember what the last file I sent was and I don’t have access to the lothal drive anymore.
 
Criteria:
Don’t see any dates used. Guessing data probably was up to 7/2018(around the time I ran the report)
I looked for patients with order associated diagnosis (%340% or %G35%)  which we mentioned that it is something that is not always populated.
And specific proc codes or cpt codes:
-          '70551','70552','70553','MHDI', 'IMGMR0128','IMGMR0047','IMGMR0061','IMGMR0054','70551','70552','70553','MHDI', 'IMGMR0128','IMGMR0047','IMGMR0061','IMGMR0054'
Performing Depts: 361, 547, 6004, 6013
 
--If I remember correctly, we added additional proc code and cpt codes in because the data output was very low and associated diagnosis was not always populated. Also, Taki, Melissa and I talked about some of the possible discrepancies. Which was really helpful.
 
Recommendation: I recommend taking a couple patients and looking at their records.
 
For ex: I reviewed a patient: Zylstra, Whitney
I don’t see any ms diagnosis on the main snapshot problem list on the chart and started assuming she doesn’t have MS.
I looked further and found that there was a procedure encounter diag on 9/11/2017 with diag of “G35”.

 
But if you look at the orders, I found a couple orders with the procode listed above but the associated diagnosis was not 340 or G35. I’m not clinical and I could be wrong but I would think this patient would be on your report.
 
Thanks
Sunil
 
cid:image001.gif@01D291AA.9A09B140
Sunil Thomas
Senior Clinical Information Analyst
(: 215-662-4784
📧: Sunil.Thomas@pennmedicine.upenn.edu
 
“Be water, my friend.”
 
This is the best I have for now guys. I hope this helps!

---

#### 20210126

A lot of success. Went back and forth with DAC, decided to ask for basically everyone, and we would post sort for providers that were associated with MS clinic, assuming that patients who received a diagnosis of MS from one of these people actually had it. 

Updates dac_summary to include not only a summary of the returned DAC pull, but also of the subset of people with MS providers. dac_summary.Rmd can be found on github, and summary table on: https://docs.google.com/presentation/d/1pDWXYUmq6sq7Xe08HaWdxLELa-qtQtABCw8RIIZ_7to/edit#slide=id.gb446eacf6a_0_0

#### 20210129

[x] figure out who has unique icd9/10 and phq2/9
[x] figure out what the overlap in # of scans between Melissa and my new group are

#### 20210208
[x] check logic of unique EMPIs, looks like something wonky is going on - less unique empis in my group than in the overlap group. Obviously they should be the same if not better
   - fixed, using accession #s and not empis to look for unique empis. Now that I look for unique EMPIs, we are all good!
   
#### 20210209
[x] post to channel tomorrow

#### 20210223
[x] Melissa caught that one of our MS providers was in incorrectly. This added a bunch of scans. JACOBS, DINA A. is the right person, not JACOBS, LINDA. Reran my stuff and updated my ms google doc.

Mellisa also realized that our group should include those with a visit with an MS provider AND ICD9/10 MS code.

Today:
3737 patients
28348 total accession numbers
17038 accession numbers we don’t already have and will be requesting
3737 unique empis from the new pull who have seen an MS attending with a corresponding MS diagnosis


#### The future
-at some point, will have to make sure to clarify we used ms diagnoses and the ms provider for our final #s

#### 20210421

- Have been summarizing MS data and some interesting findings are coming about: 
1] "Number of unique procedure names (ie. MRI Head w/out contrast; MRI Source Images): 10"
[1] "Number of unique department names (ie. RAD HUP PCAM Ground): 3"
[1] "Number of unique modalities (ie. HUP PCAM GR MR4 3T; MR6 3T): 11"
[1] "Number of unique accession #s n= 16830"
[1] "Number of unique EMPIS n = 3737"
[1] "N PHQ-2 = 4606; n = 130 meeting criteria for depression (PHQ2) >= 3"
[1] "N PHQ-9 = 261; noDep/mild/mod/mod-severe/severe = 77/73/65/21/25"
[1] "num people with both phq2 and 9 = 0"
[1] "N with phq2 (Unique EMPI) n = 899 out of 4606; n - 32 meeting criteria for depression (PHQ2) >= 3"
[1] "N with phq9 (Unique EMPI) n = 68 out of 261; noDep/mild/mod/mod-severe/severe = 18/16/18/8/8"
[1] "N with ICD 9/10 codes for depression = 2123"
[1] "N with ICD 9/10 codes for depression and unique EMPI = 493 out of 16830"
[1] "N with ICD 9/10 codes for depression and phq2 (ALL SCANS) = 960 out of 2123"
[1] "N with ICD 9/10 codes for depression and phq9 (ALL SCANS) = 140 out of 2123"
[1] "N dep + PHQ-2 = 960; n = 83 meeting criteria for depression (PHQ2) >= 3"
[1] "N dep + PHQ-9 = 140; noDep/mild/mod/mod-severe/severe = 22/39/44/20/15"
[1] "N with ICD 9/10 codes for depression and phq2 (unique) = 201 out of 2123"
[1] "N with ICD 9/10 codes for depression and phq9 (unique) = 43 out of 2123"
[1] "N without Depression/ICD 9/10 codes for healthy = 14707"
[1] "N without Depression/ ICD 9/10 codes for healthy and unique EMPI = 3244 out of 14707"
[1] "N without Depression/ ICD 9/10 codes for healthy and phq2 (ALL SCANS) = 3646 out of 14707"
[1] "N healthy w/PHQ-2 = 3646; n = 47 meeting criteria for depression (PHQ2) >= 3"
[1] "N without Depression/ ICD 9/10 codes for healthy and phq9 (ALL SCANS) = 121 out of 14707"
[1] "N healthy w/PHQ-9 = 121; noDep/mild/mod/mod-severe/severe = 55/34/21/1/10"
[1] "N without Depression/ ICD 9/10 codes for healthy and phq2 (unique) = 698 out of 14707"
[1] "N without Depression/ ICD 9/10 codes for healthy and phq9 (unique) = 25 out of 14707"

- Starting to look at statistical relationships as well

- takeaways. ~12% of people have a chart dx of MS, even though the literature says much more
   - PHQ2 and phq9s characterize MS differently. On average, people are not depressed (PHQ2 ~ 0.5), but are mildly depressed with (PHQ9 ~9). What does this mean?
   - PHQ9s include 7 more qs than 2s, including a lot of somatic symptoms (fatigue, appetite, psychomotor agitation/retardation)
   
- To dos:
  [] Chi sq comparing frequency of depression dx by phq2s vs phq9s
  [] Finding out if there is some sort of a time where some people got phq2s at some point, and some got phq9s -> is there a reason? Same population, different results
  [] literature review of ms depression, understand how depression was previously dx/described; n's, any explanation for somatic sxs?
      - does depression get better with MS tx? Suggesting that MS depression dx could have a lot to do with somatic stuff
      - Another thought - if PHQ9 is pos, but 2 is negative, even though we don't have indiv measures, it is actually splitting out anhedonia from other depressive sxs, which is interesting
  [x] lit search on evidence behind phq2 and 9
  [x] matt schindler meeting
    - to prepare 10 minute summary of the research I've reviewed
       - what has been done
       - what is the state of the field?
    - summary of our sample so far
    - prelim analyses and qs
    - Ask: are there markers of progression in the literature or that you use? Could we extract from EMR? Or would we need NLP?
    - What do you all notice? ANy differences in depression in pts you start on certain txs versus other than we can test in real world?
  
- also, we do have longitudinal data in a subset, could compare phq2/9 for brains within same subject with more/less MS.


[x] meeting with everyone

#### 20210527

- We are getting really into our collab with harvard and neurology!
- on 5/28, I'll present my work so far. For visualization purposes, I've used a combo of afni (for masking) and fslview (for visualizing), and dsi studio (for making the WM tracts)

- First, we got a "depression network" from harvard, based on a paper from Shan Siddiqui. It is from a preprint:
https://www.dropbox.com/sh/lj5mbfdsig5e4xa/AABfln6Ma_2ialx_KXNHR0oQa?dl=0

- Next, Matt took this into dsi studio, made his mask, and then ran the fibertracking and got some beautiful pictures

- Then, I took the depression network, masked it with our MNI mask, and did visualization in fslview

- Making the masks (had to do this for my figures because the mask from harvard didn't quite line up with our MNI, so I had to make sure I masked the harvard one with the mni template so it looked pretty)

    3dcalc -a MNI152_T1_2mm_brain.nii.gz -expr 'ispositive(a)' -prefix mni_positive_mask.nii
    3dcalc -a mni_positive_mask.nii -b AllFX_wmean.nii -expr 'a*b' -prefix mni_x_AllFx_mean.nii

- visualizing the overlaps 
  - fslview_deprecated
  - open each of the masks. Make sure the eye is clicked to keep it "on"
  - the info button allows you to change the scale from grey to hot (red)
  - the threshold is at the top. When changing it, make sure you are clicking on the image you want to use

- dsistudio to make the fiber tracks
  - open dsistudio
  - click 3
  - open the image /Users/eballer/BBL/msdepression/templates/dti/1904002815.src.gz.odf8.f5.gqi.1.25.fib.gz
  - Step t3d, click "enable autotrack"
  - click "fibertracking"
  - so pretty!
  - To do special fibers, unhighlight the full brain
    -   Step t3d, select the fiber you want to use
    -   click "fibertracking"
  - To do a region of avoidance, go to step T3a
    -   click the white piece of paper
    - click ROA
    - in t3b, make a box, circle, or whatever on the brain
    - in T3d, click the same fiber tracking button, and now you have only the fibers that were not hit by your cutting!
    - click on and off the two fiber tracts to see what you gain/lose!
    - if you don't like what you have, delete it
    
#### 20210806

- Going to work on algorithm with Matt as Tim reprocesses all of the scans
- Doing this by taking a good, qc'd sample of mimosa, finding a way to register it to T1, and how to register T1 to MNI space (to piggyback lesion maps)
- can do the same with probability maps, though starting with lesion maps (as if they are just rois) could be a good way to start
- Tasks

[x] I need datalad on pmacs
   - so we can put our data here
   - steps:
```{bash}
ssh -Y eballer@sciget.pmacs.upenn.edu
cd ~
source pmacs-setup-project-user.sh # this was copied from the cubic-setup-project-user.sh script per Azeez
```

[x] I need to download hcp data into datalad
 
   
[x] connectomedb account
[x] dsistudio is local
   - use it to test reconstruction
[x] download 3 or 4 hcp scans
- things were going okay and then my dsi studio had a bug. Now I basically need to wait for my new computer to come in.

20210826
  [x] Chi sq comparing frequency of depression dx by phq2s vs phq9s
  [x] Finding out if there is some sort of a time where some people got phq2s at some point, and some got phq9s -> is there a reason? Same population, different results - not really
  [] literature review of ms depression, understand how depression was previously dx/described; n's, any explanation for somatic sxs?
      - does depression get better with MS tx? Suggesting that MS depression dx could have a lot to do with somatic stuff
      - Another thought - if PHQ9 is pos, but 2 is negative, even though we don't have indiv measures, it is actually splitting out anhedonia from other depressive sxs, which is interesting
[x] figure out how to register lesions to hcp scans
[x] ask Phil cook for how he registers older brains (with some WM lesions that can interfere with registration) onto MNI

20211007 
[x] made a script to take lesions (these are hand drawn) and use dsi studio to make subtraction maps. Now all I need are real files!

script: "/Users/eballer/BBL/msdepression/scripts/dsi_studio_bash.sh

```{bash dsi_studio_bash}
#!/bin/bash

#### Welcome to the Region_making party #########
### Pre: Must have a file with full paths to the lesioned data 
### Post: Within each directory specified by the lesioned data, will have a directory that has all tractography (ROA, ROI, Full)
### Uses: For use in MS depression - take a subject's mimosa lesions and generate the fiber tracts (individual fascicles) that run through it
#dependencies: Using dsi studio downloaded 9/2021

export PATH=${PATH}:/Applications/dsi_studio.app/Contents/MacOS/
template='/Users/eballer/BBL/msdepression/templates/dti/HCP1065.1mm.fib.gz'
default='/Users/eballer/BBL/msdepression/data/mimosa_file_paths'
fascicle_directory='/Users/eballer/BBL/msdepression/templates/dti/HCP_YA1065_tractography/'

if [ $# == 0 ]
then
    echo "We will use the default mimosa path file" $default
    lesion_file=$default
else  
    lesion_file=$1
fi
echo "File being read is "$lesion_file
echo "... Starting to make lesions ..."

lesion_paths=$(cat $lesion_file)

for lesion in ${lesion_paths}; do
    echo "Working on file" $lesion
    # make directory within parent directory for tracts
    parent_dir=$(echo $lesion | perl -pe s'/(.*)\/.*/$1/g')
    mask_prefix=$(echo $lesion | perl -pe s'/(.*)\/(.*).nii.gz/$2/g')
    if [ ! -d $parent_dir/fiber_tracking_maps ] 
    then
        mkdir $parent_dir/fiber_tracking_maps
    fi

    fiber_bundle_type_list=(
        "association"
        "cerebellum"
        "cranial_nerve"
        "projection"
        "commissural")
    for fiber_bundle_type in "${fiber_bundle_type_list[@]}"; do
        echo "Fiber bundle type is " $fiber_bundle_type
        echo "making directory" $parent_dir/fiber_tracking_maps/$fiber_bundle_type
        mkdir $parent_dir/fiber_tracking_maps/$fiber_bundle_type
        fascicles=$(ls ${fascicle_directory}/${fiber_bundle_type}/*.tt.gz)
        for fascicle in ${fascicles}; do
            echo "Fascicle is  " $fascicle
            fascicle_root_name=$(echo $fascicle | perl -pe s'/(.*)\/(.*).tt.gz/$2/g') 
            dsi_studio --action=ana --source=$template --tract=$fascicle --roa=$lesion --output=$parent_dir/fiber_tracking_maps/${fiber_bundle_type}/${fascicle_root_name}_${mask_prefix}_lesioned_ROA.tt.gz
            dsi_studio --action=ana --source=$template --tract=$fascicle --roi=$lesion --output=$parent_dir/fiber_tracking_maps/${fiber_bundle_type}/${fascicle_root_name}_${mask_prefix}_lesioned_ROI.tt.gz
            dsi_studio --action=ana --source=$template --tract=$fascicle --output=$parent_dir/fiber_tracking_maps/${fiber_bundle_type}/${fascicle_root_name}_${mask_prefix}_full.tt.gz
        done
        # $path/dsi_studio --action=ana --source=/Users/eballer/BBL/msdepression/templates/dti/HCP1065.1mm.fib.gz --tract=/Users/eballer/BBL/msdepression/templates/dti/HCP_YA1065_tractography/association/SLF2_R.tt.gz --roa=/Users/eballer/BBL/msdepression/templates/perfect_ms_subject/run-001/mimosa_binary_mask_0.25.nii.gz --output=/Users/eballer/BBL/msdepression/templates/roi_files_for_testing/SLF2R_lesioned_ROA.nii.gz
        # $path/dsi_studio --action=ana --source=/Users/eballer/BBL/msdepression/templates/dti/HCP1065.1mm.fib.gz --tract=/Users/eballer/BBL/msdepression/templates/dti/HCP_YA1065_tractography/association/SLF2_R.tt.gz --roi=/Users/eballer/BBL/msdepression/templates/perfect_ms_subject/run-001/mimosa_binary_mask_0.25.nii.gz --output=/Users/eballer/BBL/msdepression/templates/roi_files_for_testing/SLF2R_lesioned_ROI.nii.gz
        # $path/dsi_studio --action=ana --source=/Users/eballer/BBL/msdepression/templates/dti/HCP1065.1mm.fib.gz --tract=/Users/eballer/BBL/msdepression/templates/dti/HCP_YA1065_tractography/association/SLF2_R.tt.gz --output=/Users/eballer/BBL/msdepression/templates/roi_files_for_testing/SLF2R_full_ROI.nii.gz
    done
done

```


20211012
 [x] Working on getting a sample MS mimosa output into HCP space
 
    - Perfect subject in MS group
        - T1w: 
        ** with skull
        /Users/eballer/BBL/msdepression/templates/perfect_ms_subject/run-001/t1_n4.nii.gz
        ** skull stripped
        /Users/eballer/BBL/msdepression/templates/perfect_ms_subject/run-001/t1_n4_brain.nii.gz
        ** brainmask
        /Users/eballer/BBL/msdepression/templates/perfect_ms_subject/run-001/t1_n4_brainmask.nii.gz
        - mimosa file: /Users/eballer/BBL/msdepression/templates/perfect_ms_subject/run-001/mimosa_binary_mask_0.25.nii.gz
    - HCP T1 : /Users/eballer/BBL/msdepression/templates/dti/mni_icbm152_nlin_asym_09a/mni_icbm152_t1_tal_nlin_asym_09a.nii
  
  - recommended script from Phil Cook: 
    * antsRegistrationSyN.sh

### ---------- Narrative from Phil and Matt ------    
    If you have raw data, I would do antsBrainExtraction.sh, N4BiasFieldCorrection, then antsRegistrationSyN.sh (brain <-> brain)

Matt Cieslak  10:06 AM
would you do anything differently if you had a mask of small MS lesions?

Phil Cook  10:08 AM
You can mask them out by inverting and then passing mask with -x
10:08
So basically -x (brain_mask - lesions)

Matt Cieslak  10:09 AM
for the masks, we should use the skull-on, n4 image and -x’ed mask from antsBrainExtraction minus the lesions? as input to antsRegistrationSyN.sh (edited) 

Phil Cook  10:10 AM
If the lesions are small, masking them out should be sufficient
10:12
For larger lesions, you can try to impute "normal" tissue in various ways, then do the registration
10:17
There's different strategies for skull on vs off.
Some people use the skull-on image with a tight brain mask in fixed and moving space, to compensate for areas where the brain mask was not expansive enough.
I usually take the skull off, so that bits of skull don't get pulled inside the mask during nonlinear registration, and use a mask that is dilated a bit so that the edge of the brain is not the edge of the mask. Reasoning being that I want small misalignments at the edge of the brain to feature in the metric and its gradients

Matt Cieslak  10:19 AM
ok that’s what I thought
10:19
Sounds good @Erica Baller?
10:19
thanks as always @Phil Cook!

Erica Baller  10:20 AM
Mostly yes!
10:25
In theory it makes sense - practically a little more challenging. Is there any documentation or script that actually does this kind of thing step by step that I could use to get the more technical pieces?

Phil Cook  10:36 AM
https://github.com/ntustison/antsBrainExtractionExample
https://github.com/stnava/ANTsTutorial
The scripts are not too hard to use. An example N4 call:
N4BiasFieldCorrection -d 3 -i <input> -x <brain mask> -w <brain_mask minus lesions> -s 2 -c  [ 50x50x50x50,0.0000000001 ] -b [ 180 ] -o <output> --verbose 1
ntustison/antsBrainExtractionExample
Stars
4
Language
R
Added by GitHub
stnava/ANTsTutorial
Stars
27
Language
HTML
Added by GitHub
10:37
The trick with -x and -w for N4 is that you can include them in the mask (-x) but exclude them from the bias computation (-w is zero in lesions). This way they won't mess up bias correction but will get corrected. If you exclude voxels from -x, they do not get corrected
10:41
The shrink factor "-s" controls how to downsample the image. This makes the computation faster. For 1mm data I use 2, for sub-1mm data 4. The other parameter of interest is the initial spline spacing 180mm. Every level doubles resolution, so 180x90x45x22.5 . For a more detailed bias field, reduce this number or add an extra level. The default in ANTs scripts is 200 for adult human data, but I have found that bias fields have gotten worse over time, so I typically use 160-180
### --------- Done with excerpted text --------

Making my mask (for brain_mask minus lesions)

```{bash make_substraction_mask}
cd /Users/eballer/BBL/msdepression/templates/erica_created_for_hcp_reg
3dcalc -a t1_n4_brainmask.nii.gz -b mimosa_binary_mask_0.25.nii.gz -expr 'a-b' -prefix t1_n4_brain_minus_mimosa_binary_mask.nii.gz
```

Now Matt is asking if we need to dilate the mask more. 

So I did
```{bash}
3dmask_tool -input t1_n4_brainmask.nii.gz -prefix t1_n4_brainmask_d3.nii.gz -dilate_input 3

3dcalc -a t1_n4_brainmask.nii.gz -b mimosa_binary_mask_0.25.nii.gz -expr 'a-b' -prefix t1_n4_brain_minus_mimosa_binary_mask.nii.gz

3dcalc -a mni_icbm152_t1_tal_nlin_asym_09a.nii -b mni_icbm152_t1_tal_nlin_asym_09a_mask.nii -expr 'a*b' -prefix mni_icbm152_t1_tal_nlin_asym_09axbrainmask.nii
```
 The input going in will be:
 T1w: /Users/eballer/BBL/msdepression/templates/erica_created_for_hcp_reg/t1_n4_brain.nii.gz  
 Mask:/Users/eballer/BBL/msdepression/templates/erica_created_for_hcp_reg/t1_n4_brainmask_d3.nii.gz
 MNI HCP template: /Users/eballer/BBL/msdepression/templates/erica_created_for_hcp_reg/mni_icbm152_t1_tal_nlin_asym_09axbrainmask.nii  
 
 Transferred my directory onto pmacs, where ants should theoretically be
```{bash}
scp -r erica_created_for_hcp_reg/ eballer@transfer.pmacs.upenn.edu:/project/msdepression

ssh -Y eballer@scisub.pmacs.upenn.edu
cd /project/ms
xbash

sh ants_registration_code.sh  

```
 
Current code in ants_registration_code.sh
```{bash}
#!/bin/bash
### ANTS registration for MS Depression
##pre- requires ms patient T1, (eventually their mimosa), mni brain: mni_icbm152_t1_tal_nlin_asym_09a.
nii, mask (currently using the one that was dilated in afni, d3
## 3dmask_tool -input t1_n4_brainmask.nii.gz -prefix t1_n4_brainmask_d3.nii.gz -dilate_input 3
##Post - ms participant T1w registered to icbm_template space (and later mimosa as well)
##Uses - We have all of these great ms depression scans but they are in native space. This will get th
em into mni space so they can be used with HCP templates, both structural and diffusion
##Dependencies: Using ANTs/2.3.5

# Set up paths
#export ANTSPATH=/home/eballer/
#export PATH=${ANTSPATH}:$PATH

#### Run registration

#default T1: t1_n4_brain.nii.gz 
t1=t1_n4_brain.nii.gz 
#default brain mask: t1_n4_brainmask_d3.nii.gz
brain_mask=t1_n4_brainmask_d3.nii.gz
#default target/template hcp brain" mni_icbm152_t1_tal_nlin_asym_09axbrainmask.nii
mni_target_t1=mni_icbm152_t1_tal_nlin_asym_09axbrainmask.nii

#output
outfile_prefix=ms_t1_to_mni_icbm152
antsRegistrationSyN.sh -d 3 -f ${mni_target_t1} -m ${t1} -o ${outfile_prefix} -x ${brain_mask}

#now actually do the transform
mimosa_path=mimosa_binary_mask_0.25.nii.gz #this is from mimosa output
mimosa_mni_hcp_path=mimosa_binary_mask_0.25_mni_hcp.nii.gz #output file prefix
mni_hcp_path=mni_icbm152_t1_tal_nlin_asym_09axbrainmask.nii #template
affine_mat=ms_t1_to_mni_icbm1520GenericAffine.mat #affine output from last step
ms2mni_warp=ms_t1_to_mni_icbm1521Warp.nii.gz #warp from last step. There are a few, Warp, Warped Inver
seWarp, InverseWarped. I picked the one that matched my pnc output the closes

antsApplyTransforms -e 3 -d 3 -i ${mimosa_path} -o ${mimosa_mni_hcp_path} -r ${mni_hcp_path} -t ${ms2mni_warp} -t ${affine_mat} -n GenericLabel
```

20211013
  [x] made a copy of the pmacs stuff and put it locally for ease of making pictures
 [x] take the new lesion file, put it in dsi studio, and run the tractography to get the track loss. 
 [x] please please please git this
 [x] can also try to run with script from command line WORKS!
 [x] checked R/L orientation - cooking with gas

[x] there is a weird line in my pictures, so am going to try with different interpolation (Multilabel and Nearest Neighbor)
  - made new script: /project/msdepression/erica_created_for_hcp_reg/ants_transform_code.sh
  - to run:
  - ssh -Y eballer@scisub.pmacs.upenn.edu
  - module load ANTs/2.3.5
  - xbash
  - sh ants_transform_code.sh
  - if this doesn't work, type "export PATH=${ANTSPATH}:$PATH" at the command line
  
```{bash ants_transform_code.sh}
export PATH=${ANTSPATH}:$PATH
mimosa_path=mimosa_binary_mask_0.25.nii.gz #this is from mimosa output
mimosa_mni_hcp_path=mimosa_binary_mask_0.25_mni_hcp_gl.nii.gz #output file prefix
mni_hcp_path=mni_icbm152_t1_tal_nlin_asym_09axbrainmask.nii #template
affine_mat=ms_t1_to_mni_icbm1520GenericAffine.mat #affine output from last step
ms2mni_warp=ms_t1_to_mni_icbm1521Warp.nii.gz #warp from last step. There are a few, Warp, Warped Inver
seWarp, InverseWarped. I picked the one that matched my pnc output the closes

antsApplyTransforms -e 3 -d 3 -i ${mimosa_path} -o ${mimosa_mni_hcp_path} -r ${mni_hcp_path} -t ${ms2m
ni_warp} -t ${affine_mat} -n GenericLabel

mimosa_path=mimosa_binary_mask_0.25.nii.gz #this is from mimosa output
mimosa_mni_hcp_path=mimosa_binary_mask_0.25_mni_hcp_ml.nii.gz #output file prefix
mni_hcp_path=mni_icbm152_t1_tal_nlin_asym_09axbrainmask.nii #template
affine_mat=ms_t1_to_mni_icbm1520GenericAffine.mat #affine output from last step
ms2mni_warp=ms_t1_to_mni_icbm1521Warp.nii.gz #warp from last step. There are a few, Warp, Warped Inver
seWarp, InverseWarped. I picked the one that matched my pnc output the closes

antsApplyTransforms -e 3 -d 3 -i ${mimosa_path} -o ${mimosa_mni_hcp_path} -r ${mni_hcp_path} -t ${ms2m
ni_warp} -t ${affine_mat} -n MultiLabel

mimosa_path=mimosa_binary_mask_0.25.nii.gz #this is from mimosa output
mimosa_mni_hcp_path=mimosa_binary_mask_0.25_mni_hcp_nn.nii.gz #output file prefix
mni_hcp_path=mni_icbm152_t1_tal_nlin_asym_09axbrainmask.nii #template
affine_mat=ms_t1_to_mni_icbm1520GenericAffine.mat #affine output from last step
ms2mni_warp=ms_t1_to_mni_icbm1521Warp.nii.gz #warp from last step. There are a few, Warp, Warped Inver
seWarp, InverseWarped. I picked the one that matched my pnc output the closes

antsApplyTransforms -e 3 -d 3 -i ${mimosa_path} -o ${mimosa_mni_hcp_path} -r ${mni_hcp_path} -t ${ms2m
ni_warp} -t ${affine_mat} -n NearestNeighbor
```
  
  
  20211014
  
  [] Docker dsi studio
    - Tim downloaded 10/13
    
  [] Start making mimosa registrations for melissa's group
    - Melissa's QC'ed people 
  /project/pennsive_pacs2/repos/insurance/1yr_report_address.csv
  
  - first, filter the group to keep the people who have good mimosas (assumes that their T1s are also good, and pull out directory paths
  - make a file that contains people whose mimosas have quality 75, 100, and then combine
  
```{bash parse_mimosa_file.sh}

#n = 2336, corresponding to  958 subjects
more 1yr_report_address.csv | grep "mimosa" | grep ",,75.0" | perl -pe 's/(.*)\/mimosa.*/$1/' > mimosa_75_paths
more 1yr_report_address.csv | grep "mimosa" | grep ",,100.0" | perl -pe 's/(.*)\/mimosa.*/$1/' > mimosa_100_paths
cat mimosa_100_paths mimosa_75_paths > mimosa_100_and_75_paths
```
   New script for /project/msdepression/scripts/ants_registration_code.sh on pmacs. too nervous to git it
   
```{bash ants_registration_code.sh}


#read in directories
directories=$(cat $qc_file_path)

#extract name of directory and create shadow directory in my own data directory, with appropriate file names
for directory in $directories; do
        sub_sess_run=$(echo ${directory} | perl -pe 's/.*(sub.*)/$1/') #grab sub/sess/run
        echo $sub_sess_run
        echo "making dir" ${new_data_path}/${sub_sess_run}
        mkdir -p ${new_data_path}/${sub_sess_run}
        ln -s ${directory}/* ${new_data_path}/${sub_sess_run}
        cp ${mni_t1_path} ${new_data_path}/${sub_sess_run}

        #go into directory for afni stuff
        cd ${new_data_path}/${sub_sess_run}

        #make the dilated mask
        3dmask_tool -input ${brain_mask} -prefix ${brain_mask_dilated} -dilate_input ${mask_dilation}

        #multiply with mni t1 to get appropriate coverage
        3dcalc -a ${brain_mask_dilated} -b ${mni_t1_root}.nii -expr 'a*b' -prefix ${mni_t1_target}

        # a typical file 
#### Run registration

        antsRegistrationSyN.sh -d 3 -f ${mni_t1_target} -m ${t1} -o ${outfile_prefix} -x ${brain_mask_dilated}

        #now actually do the transform${brain
        mimosa_path=mimosa_binary_mask_0.25.nii.gz #this is from mimosa output
        mimosa_mni_hcp_path=mimosa_binary_mask_0.25_mni_hcp.nii.gz #output file prefix
        affine_mat=ms_t1_to_mni_icbm1520GenericAffine.mat #affine output from last step
        ms2mni_warp=ms_t1_to_mni_icbm1521Warp.nii.gz #warp from last step. There are a few, Warp, Warped InverseWarp, InverseWarped. I picked the one that matched my pnc output the closes

        antsApplyTransforms -e 3 -d 3 -i ${mimosa_path} -o ${mimosa_mni_hcp_path} -r ${mni_t1_target} -t ${ms2mni_warp} -t ${affine_mat} -n MultiLabel
        cd ${base_dir}
done

```
   
  