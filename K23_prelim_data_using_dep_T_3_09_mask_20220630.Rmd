---
title: "MS Prelim Data K23, using Depression T=3.09 mask"
author: "Erica Baller"
date: "6/30/22"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(visreg)
library(lme4)
library(lmerTest)
library(ggplot2)
library(reshape2)
library(pwr)
library(mgcv)
#functions
source("~/BBL/msdepression/scripts/msdepression_functions.R")
```

## MS preliminary data

## R Markdown

The first chunk here is reading in appropriate data frames and preprocessing. Two big data frames are read in. The first is the demographic, drug, lab info for the MS patients (from the DAC pull). The second is the data frame of fascicle proportion affected for people with good mimosa (# volume affected/total volume of fascicle). The most important preprocessing occurs in a series of mutate commands. These essentially add new columns to the data frame that can later be used. The thrust of these mutate commands is to define who has depression and who does not.

Of note, in prior iterations of this analysis, we did not consider psychiatric medications in determining group inclusion/exclusion. Turns out it makes a difference, as a lot of people on psychotropic medications were counted as "controls/healthy" in previous analyses. For these preliminary analysis, our inclusion/exclusion are more stringent. Of note, the graph below is irrespective of whether they had good/bad MIMoSA. As such, the MIMoSA subset is smaller. 

<img width="70%" src="/Users/eballer/BBL/msdepression/data/drugs_data/MS_Patient_Depression_Categorizations.png"/>

Lastly, unlike the prelim K data analyses, this uses a depression mask that I generated which is slightly more leniant than the one I used for my first iteration (Matt thresholded that at 3.49. I threshold this one a 3.09).The only change I made it changing which file is fed into the depression analysis.

Inclusion criteria below:

Inclusion MS Criteria (dataframe read in here has already been filtered down using the exclusions below previously)
  1) Scanned under MS protocol (42K)
  2) MS Diagnosis (17K)
  3) Seen by MS doctor (16K)
  
Inclusion criteria for Depressed Group
  1) Have an ICD10 F3* code (in our sample, people have F32 (depressive episode), F33 (major depressive disorder), and F34 (Persistent mood [affective] disorders)) 
        - there are NO participants with bipolar disorder, manic episode, or unspecified mood/affective disorder)
        - while participants may have been diagnosed with F06.3 (Depressive disorder due to known physiological condition, with depressive features), they must ALSO have had an F3(2-4) condition
  2) Screened positive for depression on PHQ2 or PHQ9 at any point
  3) Prescribed antidepressant medications per NAMI website
        - https://www.nami.org/About-Mental-Illness/Treatments/Mental-Health-Medications
        
Inclusion criteria for Healthy Group
  1) No F* diagnoses
  2) At least 1 PHQ2 or PHQ9 with a documented 0
  3) Free of psychiatric medications per NAMI website

Exclusions
  If you received the MS protocol or had a diagnosis of MS but never actually saw an MS provider, we cannot be sure that the diagnosis of MS is truly valid, as it is hard to diagnose anyway.
  If you did not have a diagnosis of depression and never completed a PHQ2 or 9, and had no history of medications, we could not safely confirm nor deny the presence of depression. These subjects were excluded from future analyses. We could consider adding these to the healthy group maybe, but not too inclined to do that right now. 

Imaging exclusion
  We are currently only using people who had good MIMOSA (75 or 100). That severely limits our numbers, but that is okay! When we re-QC, we will probably get a lot more into this group.

Final N demographics 
  Depressed: 859 (232 unique)
  Super clean healthy: 604 (148 unique)
  
(unique, with good MIMoSA):

                         Healthy          Depressed             p      test
  n                                148            232                     
  Race (%)         Caucasian       108 ( 73.0)    173 ( 74.6)   0.821     
                   Non-caucasian    40 ( 27.0)     59 ( 25.4)             
  Sex (%)          Female          117 ( 79.1)    199 ( 85.8)   0.117     
                   Male             31 ( 20.9)     33 ( 14.2)             
  Age (mean (SD))                46.57 (12.66)  48.75 (11.75)   0.089     
  Depression (%)   1               148 (100.0)      0 (  0.0)  <0.001     
                   2                 0 (  0.0)    232 (100.0)             
  PHQ2 (mean (SD))                0.00 (0.00)    0.58 (1.53)   <0.001     
  PHQ9 (mean (SD))                0.00 (NA)     10.43 (9.02)       NA 
 

  
Networks

  A note on the "depression network." This network was made by Shan Siddiqi in Michael Fox's group by doing a conglomeration of TMS datasets, stroke datasets, Nature Human Behavior 2021 (https://www.nature.com/articles/s41562-021-01161-1). It is an unthresholded mask (which I think is in Ts per their supplement). To use it, I binarized it, thresholded clusters (3.09) and then used it as an ROI and calculated, per fascicle, the proportion of the volume occupied by the fascicle that intersected with the depression mask to the whole volume of the fascicle. Most fascicles were either entirely overlapping or entirely outside the depression mask. We consider the fascicles that had any intersection with the binary depression mask to be within the depression mask, or "indepnet." 62 out of 87 fascicles are in this network. We have an even tighter mask "indepnet_10percent", which indicates that at least 10% of a fascicle's volume intersected or overlapped with the depression mask. 21 are in this network. "in_nondep_net" refers to brain regios that completely avoided the depression network (i.e. had no shared volume of overlap). 25 are in this network.

Association fascicles:
 [1] "AF_L"     "AF_R"     "C_FPH_L"  "C_FPH_R"  "C_FP_L"   "C_FP_R"   "C_PH_L"   "C_PHP_L"  "C_PHP_R"  "C_PH_R"  
[11] "C_R_L"    "C_R_R"    "EMC_L"    "EMC_R"    "FAT_L"    "FAT_R"    "IFOF_L"   "IFOF_R"   "ILF_L"    "ILF_R"   
[21] "MdLF_L"   "MdLF_R"   "PAT_L"    "PAT_R"    "SLF1_L"   "SLF1_R"   "SLF2_L"   "SLF2_R"   "SLF3_L"   "SLF3_R"  
[31] "UF_L"     "UF_R"     "VOF_L"    "VOF_R"    

Depression network (* where there are new regions as compared to the 3.49 mask, now we are up to 62 regions):
[1] "AF_L"   "AF_R"    "C_FP_L"*  "C_FP_R"*  "C_PHP_L"* "C_PHP_R" "C_R_R"*   "EMC_L"   "EMC_R"   "FAT_L"   "FAT_R" [12] "IFOF_L"  "IFOF_R"  "ILF_L"*   "ILF_R"   "MdLF_L"  "MdLF_R"  "PAT_L" "PAT_R"   "SLF1_L"*  "SLF1_R"*  "SLF2_L" [23] "SLF2_R"  "SLF3_L"  "SLF3_R"  "VOF_R"*   "CB_L"*    "CB_R"*    "MCP"*     "V"   "AR_L"*    "AR_R"    "CBT_L" [34] "CBT_R"   "CPT_F_L" "CPT_F_R" "CPT_O_L" "CPT_O_R" "CPT_P_L" "CPT_P_R" "CS_A_L"  "CS_A_R"  "CS_P_L"  "CS_P_R" 
[45] "CS_S_L"  "CS_S_R"  "CST_L"   "CST_R"   "DRTT_L"*  "DRTT_R"  "F_R"*   "ML_L"    "RST_L"   "RST_R"   "TR_A_L" 
[56] "TR_A_R"  "TR_P_L"  "TR_P_R"  "TR_S_L"  "TR_S_R"  "AC"*     "CC"

Depression 10% network (stars where there are new regions as compared to the 3.49 mask, 21 regions)
 [1] "AF_L" "AF_R"    "C_PHP_R" "EMC_R"*   "FAT_L"*   "FAT_R"   "MdLF_L"  "MdLF_R"  "PAT_L"*   "PAT_R"*   "SLF2_L"
[12] "SLF2_R"  "SLF3_R"  "CBT_L"   "CBT_R"   "CPT_O_R" "CS_P_R"  "TR_P_L"*  "TR_P_R"  "TR_S_L"*  "TR_S_R" *

Depression top quartile, r&l separated
 [1] "SLF3_R"  "AF_R"    "AF_L"    "SLF2_R"  "CBT_R"   "FAT_R"   "CS_P_R"  "C_PHP_R" "MdLF_L"  "FAT_L"   "SLF2_L"  "MdLF_R"  "CBT_L"   "TR_P_L"  "TR_S_R" 
[16] "CPT_O_R" "TR_P_R"  "PAT_L"   "PAT_R"   "EMC_R"   "TR_S_L"  "CC"  

Depression top quartile, r&l meaned
[1] AF    SLF3  SLF2  FAT   MdLF  CST   CPT_O PAT   C_PHP CS_A  CC    CPT_F

Notebook Overview

  I start out with a proof of concept analyses, to demonstrate that our lesion filtering works. I create histograms looking at the proportion of volume lost in each fascicle across subjects. 
We recapitulate earlier work (will need to cite) and show that higher volume loss with our method reflects regions previously known to have higher disease burden.These findings suggest that the streamline filtering approach could be a reasonable approach for this analysis.

  
Analyses
  There are two main types of analyses I performed, t.tests (for example, to compare inside versus outside depression network) and linear models (for example, looking at the relationship of depression to each individual fascicle). With respect to T-tests, I assume unequal variance for all. For linear models, I have looked at the first scan (considered Unique for unique empi), the last scan previously (not in this notebook), and mixed models with EMPI as a repeated measure (all at the end of the notebook). I like the unique one the best. The general pattern is to look at the total proportion of volume lost across fascicles, then within depression network, within depression 10% network, and within non depression network. Then, I look at each individual fascicle, as well as separately consider the association fascicles (per DSI studio, these are the ones that connect association cortices).

  I attempted to do FDR correction for all analyses where I looked at each of 87 fascicles separately, or bucketed by association network or within depression network. If i was not successful, I included uncorrected (P<0.05).

  A note about age. I have tried with and without age in these models. Age is so phenomenally strong as an effect (thank goodness) but it actually tends to suck up some of the depression variance so currently it is not in the depression model. Given the age of our participants (range from 20s to 80s), there are I imagine at least two big age effects going on 1) progressive disease and 2) natural (or unnatural aging). Gams would probably be better at looking at this relationship and could probably be its own thing. 

  And this is only in WM. MS is also associated with GM atrophy. I can only imagine the IMCO paper that could emerge out of looking at the relationship between white matter loss and gray matter atrophy as a function of age. But certainly not for this K! Also sounds like lots of people are interested in this. 

  I have also looked at sex differences in individual fascicles. Underwhelming right now.

Results
  Depression group: 232 with depression, 148 healthy
  Looking at each person's first scan:
    
    *Age effects:
      -Age mean 47 (range 20-83). 
      -Almost everything corrects (54 out of 87 fascicles, 25 in association network)
      -Take home - as expected, the older you are, the worse white matter fascicle invovlement you have
    
    *Sex effects:
      - In the final good MIMoSA group, there were 64 unique males and 316 unique females, 83% women
      - Individual fascicle results underwhelming, only 3 regions meet P<0.05 (unc), SCP, CPT_O_R, OR_R
      - no association or within dep network findings
      - Sex effects interaction model (fascicle ~ depGroupVar*osex + PAT_AGE_AT_EXAM)
        - age*sex interactions - SLF1_L and CNVIII_R (p<0.05 unc)
      - Analyses to consider at a later date
        [] some sort of matching
    
    *Depression over all fascicles (also, for within/outside dep network, used rowMeans and rowSums, doesn't change anything w/r/t statistics, you just get sums instead of means for means between groups):
      - The exciting news of the day! With our new depression group (moving the meds people), we have findings
      - total proportion lost - p = 0.049, depressed (27%) more loss than healthy(24%)
      - total proportion lost within depression network (xx total) - trend (0.054) between depressed (33%) and healthy(28%)
      - total proportion lost within depression 10% network (xx fascicles total) - p = 0.055 (depressed (32%) have more loss than healthy (27%))
      - total proportion lost within depression 5% network (xx fascicles total) -  p = 0.053 (depressed (32%) have more loss than healthy (27%))
      - total proportion lost outside depression network (xx fascicles total)- p = 0.042 (depressed (14%) more than healthy(13%))
      - take home - people with a lifetime history of depression have more disease than nondepressed individuals. This finding is not specific to the depression network, but is overall.
    
    *MS disease and depression network overlap:
      - Ms disease within depression network (31%) versus outside (14%), p < 2.2* 10^-16
      - MS disease within depression 10% network (30%) versus outside (14%), p < 2.2 * 10^-16
      - MS disease within depression 5% network (30%) versus outside (14%), p < 2.2 * 10^-16
      - MS disease within depression top quartile network (31%) versus areas with no overlap (14%), p < 2.2 x 10^-16
      - MS disease within depression top quartile network (31%) versus outside depression top quartile network (24%), p 1.7 * 10^-5
      - Linear Regressions (essentially matching t tests above): 
         +depressed v healthy within dep network in (p = 0.055); 
         +dep vs healthy within dep 10% (p = 0.053);
         +dep vs healthy within non dep network (p = 0.042)
         +dep vs healthy within dep top quartile (p = 0.054);
      - Take home: Multiple sclerosis white matter lesions co-locate with brain regions previously associated with depression, irrespective of diagnosis. Suggests a final possible common pathway? Shared biology? This may also in part explain why rates of depression in MS are much higher than rates of depression in other autoimmune conditions. 
    *Depression by individual fascicle:
      - Nothing corrects at this time, unfortunately. 
      - P<0.05, uncorrected findings:
          -AF_R	0.03235420			
          -FAT_R	0.03337075			
          -SLF2_R	0.04066933			
          -CPT_F_R	0.04932598			
          -CPT_O_L	0.04346334			
          -CPT_P_R	0.03471933			
          -DRTT_R	0.01914199			
          -ML_R	0.01259474			
          -TR_S_R	0.01724321	
    Fascicle loss x PHQ9:
     - Nothing significant by individual fascicle, within association network, by fascicle within the depression network
     - similarly, no significant findings looks at means of all fascicle loss, within dep network, 10% and 5% and non-depression network
     
     Depression by sex: there is an ineraction, interestingly:
     - Males with depression have higher loss in depression network, and males without depression have less loss in depression network, as compared to females. I.e. females, depression yes/no less related to lesions in/out dep network
     
     * Comparison of proportion overlap between depression network 3.49, 3.09
     
     * Proportion lost per volume x proportion overlap in depression network (prop lost * dep proportion)
     - 3.09;  only uncorrected values when looking at the relationship between depression diagnosis and lesion hit (can only look at within depression map in this analysis)
     -  AF_R_3_09	0.012274944
        FAT_R_3_09	0.022765660			
        SLF2_R_3_09	0.021441998			
        VOF_R_3_09	0.049555998			
        CPT_F_R_3_09	0.031783931			
        CPT_O_L_3_09	0.023932661			
        CPT_P_R_3_09	0.020599230			
        CS_S_R_3_09	0.042603557			
        DRTT_R_3_09	0.008120982			
        TR_A_R_3_09	0.049682290	
  
Limitations/Future directions
 
  All diagnostic info is obtained from EMR fields, not notes, nor direct chart review. We do not know if patients are relapsing/remiting, nor do we know their active depression status. Through careful review, though patients sometimes have many phq2s listed, they are always identical. It is also possible that people who are on antidepressants are prescribed them not for depression. I tried a sensitivity analysis and removed people on meds from heatlhy group but didn't include them in the depression group. Unique n in depression group went from 232->115 and all findings go away. 
  
  In order to do this, you need to change the mutate command:

##------
#goal is to keep people who were seen by 

#### add this line #####
   mutate(dep_by_dx_phq_healthy_phq0_no_psych_meds = ifelse(dep_by_dx_phq | true_healthy, 1, 0)) %>%
   rowwise(ACCESSION_NUM) %>%
   
#### remove this line or comment out
    # mutate(depGroupVar = sum(c(dep_by_dx_phq_meds_healthy_phq0_no_psych_meds,dep_by_dx_phq))) %>%
    
#### add this line
   mutate(depGroupVar = sum(c(dep_by_dx_phq_healthy_phq0_no_psych_meds,dep_by_dx_phq))) %>%
   ungroup()
### -----

  It would be great if we also had better dimensional scores. The PHQ2s are largely 0s, and the lack of spread makes interpretation really challenging. Though the PHQ9s definitely have better spread, there just aren't many of them. Doing really good cognitive and clinical phenotyping, or even getting a different or better set of measures into the MS clinic would be ideal (Aim 2).
 
  With respect to networks, we have used the "depression" one from Harvard because I was inspired by the lesion network mapping work. However, the mask is pretty broad, covering and strongly overlapping with the executive network. There is bias toward having regions that functionally connect with the L DLPFC b/c it is a TMS target. We are considering neurosynth as a possible place to look at different depression masks.
 
  Interestingly, a key topic at the ACTRIMS 2022 conference was psychiatric comorbidity. Though we are focusing on depression, it sounds like anxiety is just as bad if not worse or more highly comorbid with MS. Would be worth considering not only a DSM breakdown but dimensionally looking at internalizing disorders for the K. Also more in line with rdoc but would require changing aims a bit. 
 
  Future analyses: age x dep, sex x dep

```{r read_in_df_and_subset}
homedir <- "/Users/eballer/BBL/msdepression/"

data <- read.csv(paste0(homedir, "/data/drugs_data/parsable_msdepression.csv"), sep = ",", header = TRUE) #n=16830, only has people with MS ICD10 code G35 and seen by MS provider

columns_to_make_integer <- c("ACCESSION_NUM", "PAT_AGE_AT_EXAM","MRI_ENC_AGE","CURRENT_AGE","hemoglobin", "WBC","RBC","B12","FOLATE", "TSH", "RPR","CSFAPPEAR1","CSFAPPEAR4","CSFCOLOR1",       "CSFCOLOR4","CSFTUBE","CSFTUBE4","VitD","PHQ.2","PHQ.9")

##########################
### some preprocessing ###
##########################
#we need to keep scans from people seen by an MS provider (n = 17067) who have an MS diagnostic code (n=16,830)
#we make a bunch of columns from character to integer, binarize sex and race, and put date into a nice format YYYYMMDD, the %m%d%y indicates what it started out as

#goal is to keep people who were seen by 
 data_empi_acc_f_phq <- data %>% 
   mutate(across(.cols = columns_to_make_integer, .fns = as.integer)) %>%
   mutate(sex_binarized = ifelse(SEX == "MALE", 1, 2)) %>%
   mutate(osex = ordered(sex_binarized,levels = c(1,2), labels = c("Male","Female"))) %>%
   mutate(race_binarized = ifelse(RACE == "WHITE", 1, 2)) %>%
   mutate(orace = ordered(race_binarized,levels = c(1,2), labels = c("White","Non-white"))) %>%
   mutate(EXAM_DATE = as.Date(BEGIN_EXAM_DTTM, format = "%m/%d/%y")) %>% 
   mutate(EXAM_DATE = gsub(EXAM_DATE, pattern = "-", replacement = "")) %>%
   mutate(EMPI = as.factor(EMPI)) %>%
   mutate(On.Psych.Meds = ifelse(On.Psych.Meds == "True", 1, 0)) %>%
   mutate(On.Antidepressants = ifelse(On.Antidepressants == "True", 1, 0)) %>%
   mutate(Has.PHQ2 = ifelse(Has.PHQ2 == "True", 1, 0)) %>%
   mutate(Has.PHQ9 = ifelse(Has.PHQ9 == "True", 1, 0)) %>%
   mutate(Has.depdx = ifelse(grepl("F3", ICD10), 1, 0)) %>%
   mutate(PHQ.2_modsev_dep_sxs = ifelse((!is.na(PHQ.2) & PHQ.2 >= 3), 1, 0)) %>%
   mutate(PHQ.9_modsev_dep_sxs = ifelse((!is.na(PHQ.9) & PHQ.9 >= 10), 1, 0)) %>%
   mutate(PHQ.2_mild_dep_sxs = ifelse((!is.na(PHQ.2) & PHQ.2 > 0 & PHQ.2 < 3), 1, 0)) %>%
   mutate(PHQ.9_mild_dep_sxs = ifelse((!is.na(PHQ.9) & PHQ.9 > 0 & PHQ.9 < 10), 1, 0)) %>%
   mutate(PHQ.2_zero = ifelse((!is.na(PHQ.2) & PHQ.2 == 0), 1, 0)) %>%
   mutate(PHQ.9_zero = ifelse((!is.na(PHQ.9) & PHQ.9 == 0), 1, 0)) %>%
   mutate(dep_by_dx_phq = ifelse((Has.depdx | PHQ.2_modsev_dep_sxs | PHQ.9_modsev_dep_sxs),1,0)) %>%
   mutate(dep_by_dx_phq_antidep = ifelse((Has.depdx | On.Antidepressants | PHQ.2_modsev_dep_sxs | PHQ.9_modsev_dep_sxs),1,0)) %>%
   mutate(true_healthy = ifelse((!Has.depdx & !On.Psych.Meds & (PHQ.2_zero | PHQ.9_zero)), 1, 0)) %>%
   mutate(dep_by_dx_phq_meds_healthy_phq0_no_psych_meds = ifelse(dep_by_dx_phq_antidep | true_healthy, 1, 0)) %>%
   rowwise(ACCESSION_NUM) %>%
   mutate(depGroupVar =
            sum(c(dep_by_dx_phq_meds_healthy_phq0_no_psych_meds,dep_by_dx_phq_antidep))) %>%#you get an extra point if you are in the depression group, so the end result is dep = 2, healthy = 1, 0 for exclude
   ungroup()



##########################################################
#             Read in Fascicle info             #
##########################################################

fascicle_proportions <- read.csv(paste0(homedir, "/results/fascicle_volumes_all_subjects_roi_n2336.csv"), header = T, sep = ",") #n = 2336

#fascicle names are contained in all but the first 2 columns of the fascicle_proportions df
fascicle_names <- names(fascicle_proportions[3:dim(fascicle_proportions)[2]])
fascicle_names_no_cranial_nerves <- fascicle_names[grep("CN", fascicle_names, invert = TRUE)] #n=77
#write.table(fascicle_names,"/Users/eballer/BBL/msdepression/templates/dti/HCP_YA1065_tractography/fascicle_names.csv", row.names = F, quote = F, col.names = F)


########
#fascicle volumes in depression network
########

#### THIS WAS CHANGED 6/30 from streamline_volume_within_dep_network.csv to streamline_volume_within_dep_network_3_09.csv

fascicle_volumes_dep <- read.csv(paste0(homedir, "results/streamline_volume_within_dep_network_3_09.csv"), header = T, sep = ",")

#add column to indicate whether does not meet criteria for inclusion in dep mask (0), any overlapping voxels (1), or >10% overlapping voxels (2)
fascicle_volumes_dep_network <- fascicle_volumes_dep %>%
  replace(is.na(.), 0) %>%
  mutate(inDepMask=case_when(prop_in_mask == 0 ~ 0, (prop_in_mask > 0 & prop_in_mask < 0.1) ~ 1, prop_in_mask >= 0.1 ~ 2))



#changed this 6/30 by adding 3_09, need this for bundle mapping
fascicle_names_dep_network_grouping <- paste0(homedir,  "/templates/dti/HCP_YA1065_tractography/fascicle_names_dep_network_grouping_3_09.csv")
write.table(fascicle_volumes_dep_network, file=fascicle_names_dep_network_grouping, sep = ",", col.names=T)#, row.names = F, quote = F, col.names = T)

fascicle_names_nondep_network<- fascicle_volumes_dep_network$fascicle[which(fascicle_volumes_dep_network$inDepMask == 0)]

fascicle_names_dep_network_all <- fascicle_volumes_dep_network$fascicle[which(fascicle_volumes_dep_network$inDepMask > 0)]

fascicle_names_dep_network_all_no_cranial_nerves <- fascicle_names_dep_network_all[grep("CN", fascicle_names_dep_network_all, invert = TRUE)] 

#fascicle_names_dep_network_all <- fascicle_volumes_dep_network$fascicle[which(fascicle_volumes_dep_network$inDepMask == 1)]
#write.table(fascicle_names_dep_network_all,"/Users/eballer/BBL/msdepression/templates/dti/HCP_YA1065_tractography/fascicle_names_dep_network_all_3_09.csv", row.names = F, quote = F, col.names = F)


fascicle_names_dep_network_10_percent <- fascicle_volumes_dep_network$fascicle[which(fascicle_volumes_dep_network$inDepMask == 2)] #n=15
#write.table(fascicle_names_dep_network_10_percent,"/Users/eballer/BBL/msdepression/templates/dti/HCP_YA1065_tractography/fascicle_names_dep_network_10_percent_3_09.csv", row.names = F, quote = F, col.names = F)
 
fascicle_names_dep_network_5_percent <- fascicle_volumes_dep_network$fascicle[which(fascicle_volumes_dep_network$prop_in_mask >= 0.05)] #n=24

fascicle_names_dep_network_15_percent <- fascicle_volumes_dep_network$fascicle[which(fascicle_volumes_dep_network$prop_in_mask >= 0.15)] #n=13

#fascicle_mapping, returns numerical mapping as well as names of tracts, and whether in or out of dep network
fascicle_bundle_mapping <- get_fascicle_bundle_mapping_generic_dep_mask(dep_network_grouping_file = fascicle_names_dep_network_grouping)

##########################################################
#             Merge with data_empi              #
##########################################################
df_demo_and_fascicles <- merge(data_empi_acc_f_phq, fascicle_proportions, by = c("EMPI", "EXAM_DATE")) #n = 2962

##########################################################
#                 Histos                        #
##########################################################
##### Histograms for PHQ2/9 healthy and depressed

hist(df_demo_and_fascicles$PHQ.2[which(!is.na(df_demo_and_fascicles$PHQ.2))], main = paste0("PHQ-2 In Good Mimosa Group : n = ", length(which(!is.na(df_demo_and_fascicles$PHQ.2)))), xlab = "PHQ-2", breaks = 8)

hist(df_demo_and_fascicles$PHQ.9[which(!is.na(df_demo_and_fascicles$PHQ.9))], main = paste0("PHQ-9 In Good Mimosa Group : n = ", length(which(!is.na(df_demo_and_fascicles$PHQ.9)))), xlab = "PHQ-9", breaks = 8) 

phq2_and_dep <- df_demo_and_fascicles %>% filter(depGroupVar == 2) %>% drop_na(PHQ.2) 
phq9_and_dep <- df_demo_and_fascicles %>% filter(depGroupVar == 2) %>% drop_na(PHQ.9) 
phq2_and_healthy <- df_demo_and_fascicles %>% filter(Has.depdx == 0) %>% drop_na(PHQ.2) 
phq9_and_healthy <- df_demo_and_fascicles %>% filter(Has.depdx == 0) %>% drop_na(PHQ.9) 

hist(phq2_and_dep$PHQ.2, main = paste0("PHQ-2/Depressed In Good Mimosa Group : n = ", dim(phq2_and_dep)[1]), xlab = "PHQ-2", breaks = 8)

hist(phq9_and_dep$PHQ.9, main = paste0("PHQ-9/Depressed In Good Mimosa Group : n = ", dim(phq9_and_dep)[1]), xlab = "PHQ-9", breaks = 8)

hist(phq2_and_healthy$PHQ.2, main = paste0("PHQ-2/Healthy In Good Mimosa Group : n = ", dim(phq2_and_healthy)[1]), xlab = "PHQ-2", breaks = 8)
hist(phq9_and_healthy$PHQ.9, main = paste0("PHQ-9/Healthy In Good Mimosa Group : n = ", dim(phq9_and_healthy)[1]), xlab = "PHQ-9", breaks = 8) 


######## Histograms for depression network
#this histogram helps contextualize the number of streamlines with varying degrees of proportions affected
hist(x=fascicle_volumes_dep$prop_in_mask, main = "Histogram Affected Streamlines in Dep Net", xlab = "Proportion Volume per Fascicle Affected", breaks = 20)

a<-ggplot(data = fascicle_volumes_dep, aes(x = fascicle, y=prop_in_mask), main = "Proportion of Volume per Fascicle Affected Dep net 3_09") + 
  geom_bar(stat="identity") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.text.y = element_text(size=2),
        plot.title = element_text(hjust = 0.5))
print(a)


#sort based on overlap
fascicle_values_dep_sorted_by_overlap <- fascicle_volumes_dep
fascicle_values_dep_sorted_by_overlap$prop_in_mask[is.na(fascicle_values_dep_sorted_by_overlap$prop_in_mask)] = 0
fascicle_values_dep_sorted_by_overlap$fascicle <- factor(fascicle_values_dep_sorted_by_overlap$fascicle, levels = fascicle_values_dep_sorted_by_overlap$fascicle[order(fascicle_values_dep_sorted_by_overlap$prop_in_mask)])

plot_all_fascicles_r_and_l_sep <-ggplot(data = fascicle_values_dep_sorted_by_overlap, aes(x = fascicle, y=prop_in_mask))+
  ggtitle("Proportion of Volume per Fascicle Affected Dep net 3_09") + 
  geom_bar(stat="identity") +
  ylab("Proportion in Depression Mask") +
  ylim(0,0.4) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5))
print(plot_all_fascicles_r_and_l_sep)

fascicles_r_and_l_sep_no_cranial_nerves <- fascicle_values_dep_sorted_by_overlap %>% filter(fascicle %in% fascicle_names_no_cranial_nerves)

plot_all_fascicles_r_and_l_sep_no_cranial_nerves <-ggplot(data = fascicles_r_and_l_sep_no_cranial_nerves, aes(x = fascicle, y=prop_in_mask))+
  ggtitle("Proportion of Volume Overlap per Fascicle 3_09") + 
  geom_bar(stat="identity") +
  xlab("Fascicle") +
  ylab("Overlap with Depression Mask") +
  ylim(0,0.4) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=30),
        axis.title.x = element_text(size=30),
        axis.title.y = element_text(size=30))
print(plot_all_fascicles_r_and_l_sep_no_cranial_nerves)

#### get top quartile; 
#figure out how many fascicles that is, then 
quartile <- round((dim(fascicle_values_dep_sorted_by_overlap)[1] / 4),0)

#quartile <- floor((dim(fascicle_values_dep_sorted_by_overlap)[1] / 4))

#sort all the fascicles by %overlap, in decreasing order (so highest overlap at the top), and then take the top 1-quartile
dep_network_names_top_quartile_preproc<- (fascicle_values_dep_sorted_by_overlap[order(fascicle_values_dep_sorted_by_overlap$prop_in_mask, decreasing = TRUE),])$fascicle[1:quartile]

dep_network_names_bottom_quartile_preproc<- (fascicle_values_dep_sorted_by_overlap[order(fascicle_values_dep_sorted_by_overlap$prop_in_mask, decreasing = FALSE),])$fascicle[1:quartile]
#make sure it right format, character

dep_network_names_top_quartile <- as.character(dep_network_names_top_quartile_preproc)

#get a network that includes all of the fascicles NOT in dep 25% network
dep_network_bottom_3_quartiles <- fascicle_names[!(fascicle_names %in% dep_network_names_top_quartile_preproc)]
dep_network_names_bottom_quartile <- fascicle_names[(fascicle_names %in% dep_network_names_bottom_quartile_preproc)]

#plot values within the depression network, and values outside of it

fascicles_dep_25_percent_for_plot <- fascicle_values_dep_sorted_by_overlap[(fascicle_values_dep_sorted_by_overlap$fascicle %in% dep_network_names_top_quartile_preproc),]

plot_all_fascicles_r_and_l_sep_top_quartile <-ggplot(data = fascicles_dep_25_percent_for_plot, aes(x = fascicle, y=prop_in_mask))+
  ggtitle("Proportion of Volume per Fascicle Affected Dep net 3_09, top quartile") + 
  geom_bar(stat="identity") +
  ylab("Proportion in Depression Mask") +
  ylim(0,0.4) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5))
print(plot_all_fascicles_r_and_l_sep_top_quartile)

#bottom 3 quartiles
fascicles_dep_bottom_3_quartiles_for_plot <- fascicle_values_dep_sorted_by_overlap[(fascicle_values_dep_sorted_by_overlap$fascicle %in% dep_network_bottom_3_quartiles),]

plot_all_fascicles_r_and_l_sep_bottom_3_quartiles <-ggplot(data = fascicles_dep_bottom_3_quartiles_for_plot, aes(x = fascicle, y=prop_in_mask))+
  ggtitle("Proportion of Volume per Fascicle Affected Dep net 3_09, bottom 3 quartiles") + 
  geom_bar(stat="identity") +
  ylim(0,0.4) +
  ylab("Proportion in Depression Mask") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5))
print(plot_all_fascicles_r_and_l_sep_bottom_3_quartiles)

#plot values within the depression network, and values outside of it

fascicles_dep_bottom_quartile_for_plot <- fascicle_values_dep_sorted_by_overlap[(fascicle_values_dep_sorted_by_overlap$fascicle %in% dep_network_names_bottom_quartile_preproc),]

plot_all_fascicles_r_and_l_sep_bottom_quartile <-ggplot(data = fascicles_dep_bottom_quartile_for_plot, aes(x = fascicle, y=prop_in_mask)) +
  ggtitle("Proportion of Volume per Fascicle Affected Dep net 3_09, bottom quartile") + 
  geom_bar(stat="identity") +
  ylim(0,0.4) +
  ylab("Proportion in Depression Mask") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5))
print(plot_all_fascicles_r_and_l_sep_bottom_quartile)

##################
### Sensitivity analysis, repeat this all but exclude cranial nerves
##################

### remove all rows with cranial nerves in them
# of note, we do not have all cranial nerves represented, we only have, CNII (optic), III(oculomotor), V (trigeminal), VII(facial), VIII(vestibulocochlear)
fascicle_values_dep_no_cranial_nerves = fascicle_values_dep_sorted_by_overlap[(grep(pattern = "CN", x = fascicle_values_dep_sorted_by_overlap$fascicle, invert = TRUE)),]

#figure out how many fascicles that is, then 
quartile <- round((dim(fascicle_values_dep_no_cranial_nerves)[1] / 4),0)
#quartile <- floor((dim(fascicle_values_dep_no_cranial_nerves)[1] / 4))


#sort all the fascicles by %overlap, in decreasing order (so highest overlap at the top), and then take the top 1-quartile
dep_network_names_top_quartile_preproc_no_cranial_nerves<- (fascicle_values_dep_no_cranial_nerves[order(fascicle_values_dep_no_cranial_nerves$prop_in_mask, decreasing = TRUE),])$fascicle[1:quartile] #n=19


dep_network_names_bottom_quartile_preproc_no_cranial_nerves<- (fascicle_values_dep_sorted_by_overlap[order(fascicle_values_dep_no_cranial_nerves$prop_in_mask, decreasing = FALSE),])$fascicle[1:quartile]
#make sure it right format, character

#make sure it right format, character

dep_network_names_top_quartile_no_cranial_nerves <- as.character(dep_network_names_top_quartile_preproc_no_cranial_nerves) #n=19

#get a network that includes all of the fascicles NOT in dep 25% network
dep_network_bottom_3_quartiles_no_cranial_nerves <- fascicle_values_dep_no_cranial_nerves$fascicle[!(fascicle_values_dep_no_cranial_nerves$fascicle %in% dep_network_names_top_quartile_preproc_no_cranial_nerves)] #n=68

#bottom quartile
dep_network_names_bottom_quartile_no_cranial_nerves <- fascicle_names[(fascicle_names %in% dep_network_names_bottom_quartile_preproc_no_cranial_nerves)]

#get a network than includes all of the fascicles with NO overlap with depression network
nondep_network_names_no_cranial_nerves <- fascicle_values_dep_no_cranial_nerves$fascicle[fascicle_values_dep_no_cranial_nerves$prop_in_mask == 0] #n=15

#plot values within the depression network, and values outside of it

fascicles_dep_25_percent_for_plot_no_cranial_nerves <- fascicle_values_dep_sorted_by_overlap[(fascicle_values_dep_sorted_by_overlap$fascicle %in% dep_network_names_top_quartile_preproc_no_cranial_nerves),]

plot_all_fascicles_r_and_l_sep_top_quartile_no_cranial_nerves <-ggplot(data = fascicles_dep_25_percent_for_plot_no_cranial_nerves, aes(x = fascicle, y=prop_in_mask)) + 
  geom_bar(stat="identity") +
  ggtitle("Proportion of Volume per Fascicle Affected Dep net 3_09, top quartile") + 
  ylim(0,0.4) +
  ylab("Proportion in Depression Mask") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=30),
        axis.title.x = element_text(size=30),
        axis.title.y = element_text(size=30))
print(plot_all_fascicles_r_and_l_sep_top_quartile_no_cranial_nerves)

#bottom 3 quartiles
fascicles_dep_bottom_3_quartiles_for_plot_no_cranial_nerves <- fascicle_values_dep_sorted_by_overlap[(fascicle_values_dep_sorted_by_overlap$fascicle %in% dep_network_bottom_3_quartiles_no_cranial_nerves),]

plot_all_fascicles_r_and_l_sep_bottom_3_quartiles_no_cranial_nerves <-ggplot(data = fascicles_dep_bottom_3_quartiles_for_plot_no_cranial_nerves, aes(x = fascicle, y=prop_in_mask)) + 
  geom_bar(stat="identity") +
  ylab("Proportion in Depression Mask") +
  ggtitle("Proportion of Volume per Fascicle Affected Dep net 3_09, bottom three quartiles") + 
  ylim(0,0.4) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5))
print(plot_all_fascicles_r_and_l_sep_bottom_3_quartiles_no_cranial_nerves) #n=58, which is total 68 - 10 CNs

#bottom quartile
fascicles_dep_bottom_quartile_for_plot_no_cranial_nerves <- fascicle_values_dep_sorted_by_overlap[(fascicle_values_dep_sorted_by_overlap$fascicle %in% dep_network_names_bottom_quartile_preproc_no_cranial_nerves),]

plot_all_fascicles_r_and_l_sep_bottom_quartile_no_cranial_nerves <-ggplot(data = fascicles_dep_bottom_quartile_for_plot_no_cranial_nerves, aes(x = fascicle, y=prop_in_mask), main = "Proportion of Volume per Fascicle Affected Dep net 3_09, bottom quartile") + 
  geom_bar(stat="identity") +
  ylab("Proportion in Depression Mask") +
  ggtitle("Proportion of Volume per Fascicle Affected Dep net 3_09, bottom quartile") + 
  ylim(0,0.4) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5))
print(plot_all_fascicles_r_and_l_sep_bottom_quartile_no_cranial_nerves)


#non dep network, no cranial nerves
nondep_network_for_plot_no_cranial_nerves <- fascicle_values_dep_sorted_by_overlap %>% filter(fascicle_values_dep_sorted_by_overlap$fascicle %in% nondep_network_names_no_cranial_nerves)

plot_all_fascicles_nondep_network_for_plot_no_cranial_nerves  <-ggplot(data = nondep_network_for_plot_no_cranial_nerves, aes(x = fascicle, y=prop_in_mask)) + 
  geom_bar(stat="identity") +
  ggtitle("Proportion of Volume per Fascicle Affected nonDep net 3_09") + 
  ylab("Proportion in Depression Mask") +
  ylim(0,0.4) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5))
print(plot_all_fascicles_nondep_network_for_plot_no_cranial_nerves)


```

```{r mean_R_and_L_dep_network}

#this will make a data frame that contains each of the fascicles with r & l sides, and take a mean. It will then add them to a data frame with the midline structures and make a histogram of them

#some preprocessing because there is one section of the data frame (C_PH_L, C_PHP_L, C_PHP_R and C_PH_R) where the L , L, R, R is out of sync with the rest. 
fascicle_dep_data_frame_rows_switched <- fascicle_volumes_dep

#make nas into 0
fascicle_dep_data_frame_rows_switched$prop_in_mask[is.na(fascicle_dep_data_frame_rows_switched$prop_in_mask)] = 0 

#reorder by moving C_PH_R up before C_PHP_L, and shifting the others down

c_ph_r_row <- fascicle_dep_data_frame_rows_switched[10,]
c_php_rows <- fascicle_dep_data_frame_rows_switched[8:9,]


fascicle_dep_data_frame_rows_switched[8,] <- c_ph_r_row
fascicle_dep_data_frame_rows_switched[9:10,] <- c_php_rows

#get names of fascicles w/r and l
fascicle_names_w_r_and_l_split <- fascicle_dep_data_frame_rows_switched$fascicle[(grep("_", fascicle_dep_data_frame_rows_switched$fascicle))]

#get names of fascicles that are midline
fascicle_names_midline <- fascicle_dep_data_frame_rows_switched$fascicle[grep("_", fascicle_dep_data_frame_rows_switched$fascicle, invert=TRUE)]

#separate out right and left, important because for some reason they hae a different order
fascicle_names_r <- fascicle_names_w_r_and_l_split[(grep("_R$", fascicle_names_w_r_and_l_split))]
fascicle_names_l <- fascicle_names_w_r_and_l_split[(grep("_L$", fascicle_names_w_r_and_l_split))]

#get the fascicle names of lateral structures, we will use the right side as default
fascicle_names_of_lateral_structs <- gsub("_R$", "", fascicle_names_r)

#get values of right and left side structs
fascicle_values_r <- fascicle_dep_data_frame_rows_switched$prop_in_mask[grep("_R$", fascicle_names_w_r_and_l_split)]
fascicle_values_l <- fascicle_dep_data_frame_rows_switched$prop_in_mask[grep("_L$", fascicle_names_w_r_and_l_split)]

#take mean of r and l side and put in new df
df_r_and_l_mean <-  (fascicle_values_r + fascicle_values_l)/2
df_r_and_l <- data.frame(fascicle_names_of_lateral_structs, df_r_and_l_mean)
names(df_r_and_l) <- c("fascicle", "prop_in_mask")

#pull out midline names and values
fascicle_values_midline <- fascicle_dep_data_frame_rows_switched$prop_in_mask[grep("_", fascicle_dep_data_frame_rows_switched$fascicle, invert=TRUE)]
df_midline<- data.frame(fascicle_names_midline, fascicle_values_midline)
names(df_midline) <- c("fascicle", "prop_in_mask")

#combine data frames
fascicle_values_dep_not_lateralized <- data.frame(rbind(df_r_and_l, df_midline))

#sort based on overlap
fascicle_values_dep_sorted_by_overlap <- fascicle_values_dep_not_lateralized
fascicle_values_dep_sorted_by_overlap$fascicle <- factor(fascicle_values_dep_sorted_by_overlap$fascicle, levels = fascicle_values_dep_sorted_by_overlap$fascicle[order(fascicle_values_dep_sorted_by_overlap$prop_in_mask)])


#fascicle_values_dep_sorted_by_overlap <- fascicle_values_dep_not_lateralized[order(fascicle_values_dep_not_lateralized$prop_in_mask),]



######## Histograms for depression network
#this histogram helps contextualize the number of streamlines with varying degrees of proportions affected
hist(x=fascicle_values_dep_sorted_by_overlap$prop_in_mask, main = "Histogram Affected Streamlines in Dep Net, not lateralized", xlab = "Proportion Volume per Fascicle Affected", breaks = 20)

sorted_ggplot<-ggplot(data = fascicle_values_dep_sorted_by_overlap, aes(x = fascicle, y=prop_in_mask)) + 
  geom_bar(stat="identity") +
  ylim(0,0.4) +
  xlab("Fascicle") +
  ylab("Proportion Overlap with Depression Mask") +
  ggtitle("Proportion of Volume that Overlaps with Depression Network by Fascicle 3_09")
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=30),
        axis.title.x = element_text(size=30),
        axis.title.y = element_text(size=30))
print(sorted_ggplot)

##new depression network, top quartile of the 46 -> top 12. This step makes a new df after ordering the previous data frame in reverse order, highest numbers at top, and then takes the top quartile)
quartile <- round((dim(fascicle_values_dep_sorted_by_overlap)[1] / 4),0)
dep_network_names_top_quartile_r_and_l_meaned<- (fascicle_values_dep_sorted_by_overlap[order(fascicle_values_dep_sorted_by_overlap$prop_in_mask, decreasing = TRUE),])$fascicle[1:quartile]

```

## Depression versus healthy analysis

    
```{r demographics}

#this will display a demographics table comparing age, race, sex between healthy and depressed groups, using the first presentation to treatment

make_demographics_table_ms(data_frame = data_empi_acc_f_phq)

df_unique_empi <- data_empi_acc_f_phq %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup() 

make_demographics_table_ms(data_frame = df_unique_empi)

df_just_healthy_and_depressed <- df_unique_empi %>% filter(depGroupVar != 0)

make_demographics_table_ms(data_frame = df_just_healthy_and_depressed)


#just people with good mimosa
df_good_mimosa <- df_demo_and_fascicles %>% filter(depGroupVar != 0)
make_demographics_table_ms(data_frame = df_good_mimosa)

df_good_mimosa_unique <- df_demo_and_fascicles %>% 
  filter(depGroupVar != 0) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup() 
make_demographics_table_ms(data_frame = df_good_mimosa_unique)
```


```{r proof_of_concept}

#this section creates histograms looking at the proportion of volume lost in each fascicle across subjects
#we recapitulate earlier work and show that higher volume loss with our method reflects regions previously known to have higher volume loss
#These findings suggest that the streamline filtering approach could be a reasonable approach for this analysis

#have to pull out just the pieces I'm interested in
just_dep_and_empi <- subset(data_empi_acc_f_phq, select = c("EMPI", "depGroupVar"))
added_dep_to_fascicles <- unique(merge(just_dep_and_empi, fascicle_proportions, by = c("EMPI")))

melted_df <- melt(added_dep_to_fascicles, id.vars = c("EMPI", "EXAM_DATE", "depGroupVar"))

#exclude regions where there was no lesion at all
lesioned <- subset(melted_df, value > 0)

#only include people in healthy or depressed group
lesioned_dx <- subset(lesioned, depGroupVar != 0)

#separate out healthy and depressed
healthy <- subset(lesioned, depGroupVar == 1)
depressed <- subset(lesioned, depGroupVar == 2)

q<-ggplot(lesioned, aes(x=value, fill=depGroupVar)) + geom_histogram() + facet_wrap(~variable)
r<-ggplot(lesioned_dx, aes(x=value, fill=depGroupVar)) + geom_histogram() + facet_wrap(~variable)
r_color<-ggplot(lesioned_dx, aes(x=value, color=factor(depGroupVar))) + geom_histogram() + facet_wrap(~variable)
x<-ggplot(lesioned, aes(x=value)) + geom_histogram() + facet_wrap(~variable)
y<-ggplot(healthy, aes(x=value)) + geom_histogram() + facet_wrap(~variable)
z<-ggplot(depressed, aes(x=value)) + geom_histogram() + facet_wrap(~variable)

#print(q)
#print(r)
print(r_color)
#print(x)
#print(y)
#print(z)

###########################################################################################################
##### Looking at distribution of disease across fascicles across group and within healthy and depressed ###
###########################################################################################################

#### look at mean fascicle volume across participants and transpose
# drop exam date and empi, and transpose
fascicles_alone_df <- t(added_dep_to_fascicles[,!(colnames(added_dep_to_fascicles) %in% c("EMPI", "EXAM_DATE", "depGroupVar"))])
fascicle_names <- rownames(fascicles_alone_df)

#take row means
fascicles_alone_rowMeans <- data.frame(fascicle_names, rowMeans(fascicles_alone_df))
names(fascicles_alone_rowMeans) <- c("fascicle", "value")

#GET RID OF CRANIAL NERVES
fascicles_alone_rowMeans <- fascicles_alone_rowMeans %>% filter(fascicle %in% fascicle_names_no_cranial_nerves)

#sort based on overlap
fascicle_values_sorted_by_overlap <- fascicles_alone_rowMeans

#make this separate in case I want to use this distribution for ranking depressed and healthy networks. 
order_of_mean_values_overall <- fascicle_values_sorted_by_overlap$fascicle[order(fascicle_values_sorted_by_overlap$value)]

fascicle_values_sorted_by_overlap$fascicle <- factor(fascicle_values_sorted_by_overlap$fascicle, levels = fascicle_values_sorted_by_overlap$fascicle[order(fascicle_values_sorted_by_overlap$value)])


######## Histograms/bargraphs
#this histogram helps contextualize the number of streamlines with varying degrees of proportions affected
hist(x=fascicle_values_dep_sorted_by_overlap$prop_in_mask, main = "Histogram Affected Streamlines", xlab = "Proportion Volume per Fascicle Affected", breaks = 20)

sorted_ggplot<-ggplot(data = fascicle_values_sorted_by_overlap, aes(x = fascicle, y=value))+
  ggtitle("Proportion of Volume per Fascicle Affected") + 
  ylab("Proportion") + 
  geom_bar(stat="identity") +
  ylim(0,0.8) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=30),
        axis.title.x = element_text(size=30),
        axis.title.y = element_text(size=30))
print(sorted_ggplot)

######### 
#############
#### look at mean fascicle volume across healthy participants and transpose
#############

# drop exam date and empi, and transpose
healthy_group_fascicles <- added_dep_to_fascicles[(added_dep_to_fascicles$depGroupVar == 1),]
fascicles_alone_df <- t(healthy_group_fascicles[,!(colnames(healthy_group_fascicles) %in% c("EMPI", "EXAM_DATE", "depGroupVar"))])
fascicle_names <- rownames(fascicles_alone_df)

#take row means
fascicles_alone_rowMeans <- data.frame(fascicle_names, rowMeans(fascicles_alone_df))
names(fascicles_alone_rowMeans) <- c("fascicle", "value")

#GET RID OF CRANIAL NERVES
fascicles_alone_rowMeans <- fascicles_alone_rowMeans %>% filter(fascicle %in% fascicle_names_no_cranial_nerves)

#sort based on overlap
fascicle_values_sorted_by_overlap <- fascicles_alone_rowMeans

fascicle_values_sorted_by_overlap$fascicle <- factor(fascicle_values_sorted_by_overlap$fascicle, levels = fascicle_values_sorted_by_overlap$fascicle[order(fascicle_values_sorted_by_overlap$value)])



######## Histograms/bargraphs
#this histogram helps contextualize the number of streamlines with varying degrees of proportions affected
hist(x=fascicle_values_dep_sorted_by_overlap$prop_in_mask, main = "Histogram Affected Streamlines in Non Depressed", xlab = "Proportion Volume per Fascicle Affected", breaks = 20)

sorted_ggplot_healthy<-ggplot(data = fascicle_values_sorted_by_overlap, aes(x = fascicle, y=value))+
  ggtitle("Proportion of Volume per Fascicle Affected in Non Depressed") + 
  geom_bar(stat="identity") +
  ylab("Proportion") +
  ylim(0,0.8) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=30),
        axis.title.x = element_text(size=30),
        axis.title.y = element_text(size=30))
print(sorted_ggplot_healthy)

# ordered by mean value overall
fascicle_values_sorted_by_overlap$fascicle <- factor(fascicle_values_sorted_by_overlap$fascicle, levels = order_of_mean_values_overall)
sorted_ggplot_healthy_ordered<-ggplot(data = fascicle_values_sorted_by_overlap, aes(x = fascicle, y=value))+
  ggtitle("Proportion of Volume per Fascicle Affected Ordered by mean values NonDepressed") + 
  geom_bar(stat="identity") +
  ylab("Proportion") +
  ylim(0,0.8) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5))
print(sorted_ggplot_healthy_ordered)

###########
#### look at mean fascicle volume across depressed participants and transpose
###########
# drop exam date and empi, and transpose
depressed_group_fascicles <- added_dep_to_fascicles[(added_dep_to_fascicles$depGroupVar == 2),]
fascicles_alone_df <- t(depressed_group_fascicles[,!(colnames(depressed_group_fascicles) %in% c("EMPI", "EXAM_DATE", "depGroupVar"))])
fascicle_names <- rownames(fascicles_alone_df)

#take row means
fascicles_alone_rowMeans <- data.frame(fascicle_names, rowMeans(fascicles_alone_df))
names(fascicles_alone_rowMeans) <- c("fascicle", "value")

#GET RID OF CRANIAL NERVES
fascicles_alone_rowMeans <- fascicles_alone_rowMeans %>% filter(fascicle %in% fascicle_names_no_cranial_nerves)

#sort based on overlap
fascicle_values_sorted_by_overlap <- fascicles_alone_rowMeans

fascicle_values_sorted_by_overlap$fascicle <- factor(fascicle_values_sorted_by_overlap$fascicle, levels = fascicle_values_sorted_by_overlap$fascicle[order(fascicle_values_sorted_by_overlap$value)])



######## Histograms/bargraphs
#this histogram helps contextualize the number of streamlines with varying degrees of proportions affected
hist(x=fascicle_values_dep_sorted_by_overlap$prop_in_mask, main = "Histogram Affected Streamlines", xlab = "Proportion Volume per Fascicle Affected Depressed", breaks = 20)

sorted_ggplot_depressed<-ggplot(data = fascicle_values_sorted_by_overlap, aes(x = fascicle, y=value))+
  ggtitle("Proportion of Volume per Fascicle Affected Depressed") + 
  geom_bar(stat="identity") +
  ylab("Proportion Affected") +
  ylim(0,0.8) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=30),
        axis.title.x = element_text(size=30),
        axis.title.y = element_text(size=30))
print(sorted_ggplot_depressed)

# ordered by mean value overall
fascicle_values_sorted_by_overlap$fascicle <- factor(fascicle_values_sorted_by_overlap$fascicle, levels = order_of_mean_values_overall)
sorted_ggplot_depressed_ordered<-ggplot(data = fascicle_values_sorted_by_overlap, aes(x = fascicle, y=value))+
  ggtitle("Proportion of Volume per Fascicle Affected Ordered by mean values Depressed") + 
  ylab("Proportion Affected") +
  geom_bar(stat="identity") +
  ylim(0,0.8) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=30),
        axis.title.x = element_text(size=30),
        axis.title.y = element_text(size=30))
print(sorted_ggplot_depressed_ordered)

#no cranial nerves
fascicles_for_plot_no_cranial_nerves <- fascicle_values_sorted_by_overlap[(fascicle_values_sorted_by_overlap$fascicle %in% fascicle_names_dep_network_all_no_cranial_nerves),]

plot_all_fascicles_r_and_l_no_cranial_nerves <-ggplot(data = fascicles_for_plot_no_cranial_nerves, aes(x = fascicle, y=value))+
  ggtitle("Proportion of Volume per Fascicle Affected Net 3_09") + 
  xlab("Fascicle") + 
  ylab("Proportion Affected") +
  geom_bar(stat="identity") +
  ylim(0,0.8) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=30),
        axis.title.x = element_text(size=30),
        axis.title.y = element_text(size=30))
print(plot_all_fascicles_r_and_l_no_cranial_nerves )

##### look at mean fascicles affected in dep vs non dep network
######
#plot values within the depression network, and values outside of it

fascicles_dep_25_percent_for_plot <- fascicle_values_sorted_by_overlap[(fascicle_values_sorted_by_overlap$fascicle %in% dep_network_names_top_quartile_preproc),]

plot_all_fascicles_r_and_l_sep_top_quartile <-ggplot(data = fascicles_dep_25_percent_for_plot, aes(x = fascicle, y=value))+
  ggtitle("Proportion of Volume per Fascicle Affected Dep net 3_09, top quartile") + 
  geom_bar(stat="identity") +
  ylab("Proportion") +
  ylim(0,0.8) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5))
print(plot_all_fascicles_r_and_l_sep_top_quartile)

#bottom 3 quartiles
fascicles_dep_bottom_3_quartiles_for_plot <- fascicle_values_sorted_by_overlap[(fascicle_values_sorted_by_overlap$fascicle %in% dep_network_bottom_3_quartiles),]

plot_all_fascicles_r_and_l_sep_bottom_3_quartiles <-ggplot(data = fascicles_dep_bottom_3_quartiles_for_plot, aes(x = fascicle, y=value))+
  ggtitle("Proportion of Volume per Fascicle Affected Dep net 3_09, bottom three quartiles") + 
  ylab("Proportion") +
  geom_bar(stat="identity") +
  ylim(0,0.8) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5))
print(plot_all_fascicles_r_and_l_sep_bottom_3_quartiles)

#plot values within the depression network, and values outside of it

fascicles_dep_bottom_quartile_for_plot <- fascicle_values_sorted_by_overlap[(fascicle_values_sorted_by_overlap$fascicle %in% dep_network_names_bottom_quartile_preproc),]

plot_all_fascicles_r_and_l_sep_bottom_quartile <-ggplot(data = fascicles_dep_bottom_quartile_for_plot, aes(x = fascicle, y=value)) +
  ggtitle("Proportion of Volume per Fascicle Affected Dep net 3_09, bottom quartile") + 
  ylab("Proportion") +
  geom_bar(stat="identity") +
  ylim(0,0.8) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5))
print(plot_all_fascicles_r_and_l_sep_bottom_quartile)


#non dep network
fascicles_nondep_for_plot <- fascicle_values_sorted_by_overlap[(fascicle_values_sorted_by_overlap$fascicle %in% fascicle_names_nondep_network),]

plot_all_fascicles_r_and_l_nondep <-ggplot(data = fascicles_nondep_for_plot, aes(x = fascicle, y=value))+
  ggtitle("Proportion of Volume per Fascicle Affected nonDep net 3_09") + 
  ylab("Proportion") +
  geom_bar(stat="identity") +
  ylim(0,0.8) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5))
print(plot_all_fascicles_r_and_l_nondep)



```

```{r proof_of_concept_unique}

#this section creates histograms looking at the proportion of volume lost in each fascicle across subjects
#we recapitulate earlier work and show that higher volume loss with our method reflects regions previously known to have higher volume loss
#These findings suggest that the streamline filtering approach could be a reasonable approach for this analysis

data_empi_acc_f_phq_unique <- data_empi_acc_f_phq %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup() #n=3737
  

#have to pull out just the pieces I'm interested in
just_dep_and_empi <- subset(data_empi_acc_f_phq_unique, select = c("EMPI", "depGroupVar"))
added_dep_to_fascicles <- unique(merge(just_dep_and_empi, fascicle_proportions, by = c("EMPI")))

melted_df <- melt(added_dep_to_fascicles, id.vars = c("EMPI", "EXAM_DATE", "depGroupVar"))

#exclude regions where there was no lesion at all
lesioned <- subset(melted_df, value > 0)

#only include people in healthy or depressed group
lesioned_dx <- subset(lesioned, depGroupVar != 0)

#separate out healthy and depressed
healthy <- subset(lesioned, depGroupVar == 1)
depressed <- subset(lesioned, depGroupVar == 2)

q<-ggplot(lesioned, aes(x=value, fill=depGroupVar)) + geom_histogram() + facet_wrap(~variable)
r<-ggplot(lesioned_dx, aes(x=value, fill=depGroupVar)) + geom_histogram() + facet_wrap(~variable)
r_color<-ggplot(lesioned_dx, aes(x=value, color=factor(depGroupVar))) + geom_histogram() + facet_wrap(~variable)
x<-ggplot(lesioned, aes(x=value)) + geom_histogram() + facet_wrap(~variable)
y<-ggplot(healthy, aes(x=value)) + geom_histogram() + facet_wrap(~variable)
z<-ggplot(depressed, aes(x=value)) + geom_histogram() + facet_wrap(~variable)

#print(q)
#print(r)
print(r_color)
#print(x)
#print(y)
#print(z)

###########################################################################################################
##### Looking at distribution of disease across fascicles across group and within healthy and depressed ###
###########################################################################################################

#### look at mean fascicle volume across participants and transpose
# drop exam date and empi, and transpose
fascicles_alone_df <- t(added_dep_to_fascicles[,!(colnames(added_dep_to_fascicles) %in% c("EMPI", "EXAM_DATE", "depGroupVar"))])
fascicle_names <- rownames(fascicles_alone_df)

#take row means
fascicles_alone_rowMeans <- data.frame(fascicle_names, rowMeans(fascicles_alone_df))
names(fascicles_alone_rowMeans) <- c("fascicle", "value")

#GET RID OF CRANIAL NERVES
fascicles_alone_rowMeans <- fascicles_alone_rowMeans %>% filter(fascicle %in% fascicle_names_no_cranial_nerves)

#sort based on overlap
fascicle_values_sorted_by_overlap <- fascicles_alone_rowMeans

#make this separate in case I want to use this distribution for ranking depressed and healthy networks. 
order_of_mean_values_overall <- fascicle_values_sorted_by_overlap$fascicle[order(fascicle_values_sorted_by_overlap$value)]

fascicle_values_sorted_by_overlap$fascicle <- factor(fascicle_values_sorted_by_overlap$fascicle, levels = fascicle_values_sorted_by_overlap$fascicle[order(fascicle_values_sorted_by_overlap$value)])


######## Histograms/bargraphs
#this histogram helps contextualize the number of streamlines with varying degrees of proportions affected
hist(x=fascicle_values_dep_sorted_by_overlap$prop_in_mask, main = "Histogram Affected Streamlines", xlab = "Proportion Volume per Fascicle Affected", breaks = 20)

sorted_ggplot<-ggplot(data = fascicle_values_sorted_by_overlap, aes(x = fascicle, y=value))+
  ggtitle("Proportion of Volume per Fascicle Affected") + 
  xlab("Fascicle") +
  ylab("Mean Proportion") + 
  geom_bar(stat="identity") +
  ylim(0,0.8) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size =30),
        axis.title.x = element_text(size=30),
        axis.title.y = element_text(size=30))
print(sorted_ggplot)

######### 
#############
#### look at mean fascicle volume across healthy participants and transpose
#############

# drop exam date and empi, and transpose
healthy_group_fascicles <- added_dep_to_fascicles[(added_dep_to_fascicles$depGroupVar == 1),]
fascicles_alone_df <- t(healthy_group_fascicles[,!(colnames(healthy_group_fascicles) %in% c("EMPI", "EXAM_DATE", "depGroupVar"))])
fascicle_names <- rownames(fascicles_alone_df)

#take row means
fascicles_alone_rowMeans <- data.frame(fascicle_names, rowMeans(fascicles_alone_df))
names(fascicles_alone_rowMeans) <- c("fascicle", "value")

#GET RID OF CRANIAL NERVES
fascicles_alone_rowMeans <- fascicles_alone_rowMeans %>% filter(fascicle %in% fascicle_names_no_cranial_nerves)

#sort based on overlap
fascicle_values_sorted_by_overlap <- fascicles_alone_rowMeans

fascicle_values_sorted_by_overlap$fascicle <- factor(fascicle_values_sorted_by_overlap$fascicle, levels = fascicle_values_sorted_by_overlap$fascicle[order(fascicle_values_sorted_by_overlap$value)])



######## Histograms/bargraphs
#this histogram helps contextualize the number of streamlines with varying degrees of proportions affected
hist(x=fascicle_values_dep_sorted_by_overlap$prop_in_mask, main = "Histogram Affected Streamlines in Non Depressed", xlab = "Proportion Volume per Fascicle Affected", breaks = 20)

sorted_ggplot_healthy<-ggplot(data = fascicle_values_sorted_by_overlap, aes(x = fascicle, y=value))+
  ggtitle("Proportion of Volume per Fascicle Affected in Non Depressed") + 
  geom_bar(stat="identity") +
  ylab("Proportion") +
  ylim(0,0.8) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5))
print(sorted_ggplot_healthy)

# ordered by mean value overall
fascicle_values_sorted_by_overlap$fascicle <- factor(fascicle_values_sorted_by_overlap$fascicle, levels = order_of_mean_values_overall)
sorted_ggplot_healthy_ordered<-ggplot(data = fascicle_values_sorted_by_overlap, aes(x = fascicle, y=value))+
  ggtitle("Proportion of Volume per Fascicle Affected Ordered by mean values NonDepressed") + 
  geom_bar(stat="identity") +
  ylab("Proportion") +
  ylim(0,0.8) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5))
print(sorted_ggplot_healthy_ordered)

###########
#### look at mean fascicle volume across depressed participants and transpose
###########
# drop exam date and empi, and transpose
depressed_group_fascicles <- added_dep_to_fascicles[(added_dep_to_fascicles$depGroupVar == 2),]
fascicles_alone_df <- t(depressed_group_fascicles[,!(colnames(depressed_group_fascicles) %in% c("EMPI", "EXAM_DATE", "depGroupVar"))])
fascicle_names <- rownames(fascicles_alone_df)

#take row means
fascicles_alone_rowMeans <- data.frame(fascicle_names, rowMeans(fascicles_alone_df))
names(fascicles_alone_rowMeans) <- c("fascicle", "value")

#GET RID OF CRANIAL NERVES
fascicles_alone_rowMeans <- fascicles_alone_rowMeans %>% filter(fascicle %in% fascicle_names_no_cranial_nerves)

#sort based on overlap
fascicle_values_sorted_by_overlap <- fascicles_alone_rowMeans

fascicle_values_sorted_by_overlap$fascicle <- factor(fascicle_values_sorted_by_overlap$fascicle, levels = fascicle_values_sorted_by_overlap$fascicle[order(fascicle_values_sorted_by_overlap$value)])



######## Histograms/bargraphs
#this histogram helps contextualize the number of streamlines with varying degrees of proportions affected
hist(x=fascicle_values_dep_sorted_by_overlap$prop_in_mask, main = "Histogram Affected Streamlines", xlab = "Proportion Volume per Fascicle Affected Depressed", breaks = 20)

sorted_ggplot_depressed<-ggplot(data = fascicle_values_sorted_by_overlap, aes(x = fascicle, y=value))+
  ggtitle("Proportion of Volume per Fascicle Affected Depressed") + 
  geom_bar(stat="identity") +
  ylab("Proportion Affected") +
  ylim(0,0.8) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5))
print(sorted_ggplot_depressed)

# ordered by mean value overall
fascicle_values_sorted_by_overlap$fascicle <- factor(fascicle_values_sorted_by_overlap$fascicle, levels = order_of_mean_values_overall)
sorted_ggplot_depressed_ordered<-ggplot(data = fascicle_values_sorted_by_overlap, aes(x = fascicle, y=value))+
  ggtitle("Proportion of Volume per Fascicle Affected Ordered by mean values Depressed") + 
  ylab("Proportion Affected") +
  geom_bar(stat="identity") +
  ylim(0,0.8) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5))
print(sorted_ggplot_depressed_ordered)

#no cranial nerves
fascicles_for_plot_no_cranial_nerves <- fascicle_values_sorted_by_overlap[(fascicle_values_sorted_by_overlap$fascicle %in% fascicle_names_dep_network_all_no_cranial_nerves),]

plot_all_fascicles_r_and_l_no_cranial_nerves <-ggplot(data = fascicles_for_plot_no_cranial_nerves, aes(x = fascicle, y=value))+
  ggtitle("Proportion of Volume per Fascicle Affected Net 3_09") + 
  ylab("Proportion Affected") +
  geom_bar(stat="identity") +
  ylim(0,0.8) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5))
print(plot_all_fascicles_r_and_l_no_cranial_nerves )

##### look at mean fascicles affected in dep vs non dep network
######
#plot values within the depression network, and values outside of it

fascicles_dep_25_percent_for_plot <- fascicle_values_sorted_by_overlap[(fascicle_values_sorted_by_overlap$fascicle %in% dep_network_names_top_quartile_preproc),]

plot_all_fascicles_r_and_l_sep_top_quartile <-ggplot(data = fascicles_dep_25_percent_for_plot, aes(x = fascicle, y=value))+
  ggtitle("Proportion of Volume per Fascicle Affected Dep net 3_09, top quartile") + 
  geom_bar(stat="identity") +
  ylab("Proportion") +
  ylim(0,0.8) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5))
print(plot_all_fascicles_r_and_l_sep_top_quartile)

#bottom 3 quartiles
fascicles_dep_bottom_3_quartiles_for_plot <- fascicle_values_sorted_by_overlap[(fascicle_values_sorted_by_overlap$fascicle %in% dep_network_bottom_3_quartiles),]

plot_all_fascicles_r_and_l_sep_bottom_3_quartiles <-ggplot(data = fascicles_dep_bottom_3_quartiles_for_plot, aes(x = fascicle, y=value))+
  ggtitle("Proportion of Volume per Fascicle Affected Dep net 3_09, bottom three quartiles") + 
  ylab("Proportion") +
  geom_bar(stat="identity") +
  ylim(0,0.8) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5))
print(plot_all_fascicles_r_and_l_sep_bottom_3_quartiles)

#plot values within the depression network, and values outside of it

fascicles_dep_bottom_quartile_for_plot <- fascicle_values_sorted_by_overlap[(fascicle_values_sorted_by_overlap$fascicle %in% dep_network_names_bottom_quartile_preproc),]

plot_all_fascicles_r_and_l_sep_bottom_quartile <-ggplot(data = fascicles_dep_bottom_quartile_for_plot, aes(x = fascicle, y=value)) +
  ggtitle("Proportion of Volume per Fascicle Affected Dep net 3_09, bottom quartile") + 
  ylab("Proportion") +
  geom_bar(stat="identity") +
  ylim(0,0.8) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5))
print(plot_all_fascicles_r_and_l_sep_bottom_quartile)


#non dep network
fascicles_nondep_for_plot <- fascicle_values_sorted_by_overlap[(fascicle_values_sorted_by_overlap$fascicle %in% fascicle_names_nondep_network),]

plot_all_fascicles_r_and_l_nondep <-ggplot(data = fascicles_nondep_for_plot, aes(x = fascicle, y=value))+
  ggtitle("Proportion of Volume per Fascicle Affected nonDep net 3_09") + 
  ylab("Proportion") +
  geom_bar(stat="identity") +
  ylim(0,0.8) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5))
print(plot_all_fascicles_r_and_l_nondep)



```

```{r age_effects_fascicles_unique}
########### age effect whole group

#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>% 
  filter(depGroupVar != 0)  %>% 
  mutate(total_fascicle_prop_lost = rowMeans(across(fascicle_names_no_cranial_nerves))) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()


#### age histo ###
hist(dep_and_healthy_groups_for_ICD_analysis$PAT_AGE_AT_EXAM,
main = paste0("Age In Good Mimosa Group : n = ", dim(dep_and_healthy_groups_for_ICD_analysis)[1]), xlab = "Age", breaks = 10)

#lm
fascicle_age_lm <- lapply(fascicle_names_no_cranial_nerves, function(x) 
{
  lm(substitute(i ~ PAT_AGE_AT_EXAM, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_age_lm) <- fascicle_names_no_cranial_nerves

#anova
fascicle_age_anova <- lapply(fascicle_age_lm, anova)

#fdr corrected
fascicle_age_anova_fdr <- fdr_anova_generic(fascicle_age_anova, 1)
print(fascicle_age_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_age_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#visreg
#sapply(fascicle_age_lm,visreg)
visreg(fascicle_age_lm$AF_R,ylab = "Proportion of Affected Streamlines", xlab = "Age in Years",
       line=list(col="red"),
       points=list(col="black"))

### Mean proportion volume loss x age
age_x_prop_vol_affected <- lm(total_fascicle_prop_lost~ PAT_AGE_AT_EXAM, data=dep_and_healthy_groups_for_ICD_analysis )
print(summary(age_x_prop_vol_affected))
visreg(age_x_prop_vol_affected, gg=TRUE) + 
  xlab("Age") + 
  ylab("Mean Proportion of Fascicle Affected") + 
  ggtitle("Mean Proportion of Fascicles Affected by Age, p = 2.2*10^-5") + 
  theme(plot.title = element_text(hjust = 0.5))

scatter_age_x_prop_affected <- ggplot(data=age_x_prop_vol_affected, aes(x=PAT_AGE_AT_EXAM, y=total_fascicle_prop_lost)) +
  geom_point(size=1) + 
  geom_smooth(method=lm)+
  xlab("Age") + 
  ylab("Mean Proportion of Fascicles Affected") + 
  ggtitle("Mean Proportion of Fascicles Affected by Age, p = 2.2*10^-5") + 
  theme(plot.title = element_text(hjust = 0.5, size=20),
        axis.title = element_text(size=20),
        axis.text = element_text(size=14),
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        panel.background = element_rect(colour = "white", fill = "white"))
print(scatter_age_x_prop_affected)

##### Ascending graph of all age regressions
#get lm results, including uncorrected
df_t_lm_age <- sapply(fascicle_age_lm, function(v) summary(v)$coefficients[2,3])

#Convert to data frame
df_t_lm_age <- data_frame(fascicle_names_no_cranial_nerves, df_t_lm_age)
names(df_t_lm_age) = c("Fascicle", "tvalue")

#remove items with cranial nerves
df_t_lm_age_no_cranial_nerves <- df_t_lm_age  %>% filter(Fascicle %in% fascicle_names_no_cranial_nerves)

df_t_lm_age_no_cranial_nerves$Fascicle <- factor(df_t_lm_age_no_cranial_nerves$Fascicle, levels = df_t_lm_age_no_cranial_nerves$Fascicle[order(df_t_lm_age_no_cranial_nerves$tvalue)])
  
# bar graph of T-values of fascicles
plot_fascicle_by_t_sorted <-ggplot(data = df_t_lm_age_no_cranial_nerves, aes(x = Fascicle, y=tvalue))+ 
  geom_bar(stat="identity") +
  xlab("Fascicle") + 
  ylab("T-value of AgexFascile Affected Regression") + 
  ylim(-2,8) +
  ggtitle("Effects of age within each fascicle ") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=30),
        axis.title.x = element_text(size=30),
        axis.title.y = element_text(size=30))
print(plot_fascicle_by_t_sorted)
```


```{r sex_effects_fascicles_unique}

### really not interesting at all. 3 areas that are uncorrected: SCP, CPT_O_R, OR_R

#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>% filter(depGroupVar != 0)  %>% 
  mutate(total_fascicle_prop_lost = rowMeans(across(fascicle_names_no_cranial_nerves))) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()

#### sex histo ###
hist(dep_and_healthy_groups_for_ICD_analysis$sex_binarized,
main = paste0("Sex In Good Mimosa Group : n (M/F)= ", sum(dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1), "/", sum(dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)),  xlab = "Sex", breaks = 2)

######## Mean male vs female, male = 1, female = 2, m = 30%, F = 29%
males_vs_females_across_all_fascicles <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[which(dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1)], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[which(dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)], var.equal = T)

sex <- c("Male", "Female")
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1]),
           mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2]))

sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$sex_binarized ==1))),
           (sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$sex_binarized ==2))))

data <- data.frame(sex,value, sem)
#data$Fascicle <- pretty_names

# Grouped
barplot <- ggplot(data, aes(x=reorder(sex, -value),fill=sex, y=value)) + 
  geom_bar(stat="identity", colour="black", width=0.8, size=1.5) + 
  geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9), size=1.5) +
  scale_fill_manual(values = c("#cdcdcd", "#FFFFFF")) + #comment out if you want colored graph
  ggtitle("Mean Proportion of Fascicles Affected Males vs Females, p = 0.48, NS") +
  ylab("Mean Proportion of Fasccicles Affected") +
  theme(plot.title = element_text(size=14, hjust=0.5),
        legend.position="none", 
        axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        panel.background = element_rect(colour = "white", fill = "white")) + #comment out if you want pretty 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.52)) #comment out if you want colored graph

print(barplot)

### Linear models
#lm
fascicle_sex_lm <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ osex, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_sex_lm) <- fascicle_names

#anova
fascicle_sex_anova <- lapply(fascicle_sex_lm, anova)

#fdr corrected
fascicle_sex_anova_fdr <- fdr_anova_generic(fascicle_sex_anova, 1)
print(fascicle_sex_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sex_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sex_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_sex_anova_p <- sapply(fascicle_sex_anova, function(v) v$"Pr(>F)"[1])
fascicle_sex_anova_p05_unc <- as.data.frame(fascicle_sex_anova_p[fascicle_sex_anova_p < 0.05])
print(fascicle_sex_anova_p05_unc)

######
# lapply to get results of t-test in each fascicle
#ldepGroup 2 is depressed group, Dep group 1 is healthy group. Positive Ts are places where depressed people have more disease than controls
fascicle_sex_t <- lapply(fascicle_names_no_cranial_nerves, function(x) 
{
  t_test_command <- paste0("t.test(dep_and_healthy_groups_for_ICD_analysis$", x, "[dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1], dep_and_healthy_groups_for_ICD_analysis$", x, "[dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2], var.equal=F)")
  eval(parse(text=t_test_command))
})
names(fascicle_sex_t) <- fascicle_names_no_cranial_nerves

#pull t-statistic
sex_t_values <- sapply(fascicle_sex_t, function(x) x$statistic)

#convert to data frame
df_t_values <- as.data.frame(sex_t_values) 
row.names(df_t_values) <- fascicle_names_no_cranial_nerves
  
#pull p-values
sex_p_values <- sapply(fascicle_sex_t, function(x) x$p.value)

#convert to data frame
df_sex_p_values <- as.data.frame(sex_p_values)
row.names(df_sex_p_values) <- fascicle_names_no_cranial_nerves

#FDR correct p-values
sex_pfdr <- p.adjust(sex_p_values,method="fdr")
  
#Convert to data frame
df_sex_pfdr <- as.data.frame(sex_pfdr)
row.names(df_sex_pfdr) <- fascicle_names_no_cranial_nerves

# Sort by t
#Convert to data frame
df_t_sex <- data_frame(fascicle_names_no_cranial_nerves, df_t_values)
names(df_t_sex) = c("Fascicle", "tvalue")

df_t_sex$Fascicle <- factor(df_t_sex$Fascicle, levels = df_t_sex$Fascicle[order(df_t_sex$tvalue)])
  
# bar graph of T-values of fascicles
plot_fascicle_by_t_sorted <-ggplot(data = df_t_sex, aes(x = Fascicle, y=tvalue))+ 
  geom_bar(stat="identity") +
  xlab("Fascicle") + 
  ylab("T-value of Sex difference") + 
  ylim(-2,8) + 
  ggtitle("Effects of sex within each fascicle; all P=NS") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        axis.title.x = element_text(size=30),
        axis.title.y = element_text(size=30),
        plot.title = element_text(hjust = 0.5, size = 30))
print(plot_fascicle_by_t_sorted)


#######################
### plot differences ##
#######################

#combine data frames, column 1 has names of fascicles, column 2 has proportion of overlap with depression network, column 3 has t-test value of dep vs healthy unc, 4th dep vs healthy fdr corrected within that fascicle

df_fascicle_dep_mask_overlap_t_value <- data.frame(df_fascicle_and_prop_in_mask$fascicle, df_fascicle_and_prop_in_mask$prop_in_mask, df_t_values$sex_t_values, df_fascicle_and_volume_in_mask$non_zero_voxels_in_dep_map)
names(df_fascicle_dep_mask_overlap_t_value) <- c("fascicle", "depression_mask_overlap", "sex_t", "volume_in_dep_mask")


df_fascicle_dep_mask_overlap_t_value_sorted_by_prop_overlap_depression_mask <- df_fascicle_dep_mask_overlap_t_value


df_fascicle_dep_mask_overlap_t_value_sorted_by_prop_overlap_depression_mask <- df_fascicle_dep_mask_overlap_t_value

df_fascicle_dep_mask_overlap_t_value_sorted_by_prop_overlap_depression_mask$fascicle  <- factor(df_fascicle_dep_mask_overlap_t_value_sorted_by_prop_overlap_depression_mask$fascicle, levels = df_fascicle_dep_mask_overlap_t_value_sorted_by_prop_overlap_depression_mask$fascicle[order(df_fascicle_dep_mask_overlap_t_value_sorted_by_prop_overlap_depression_mask$depression_mask_overlap)])


# bar graph of T-values of fascicles, sorted by depression overlap
plot_fascicle_by_t_sorted_by_dep_overlap <-ggplot(data = df_fascicle_dep_mask_overlap_t_value_sorted_by_prop_overlap_depression_mask, aes(x = fascicle, y=sex_t), main = "Dep vs Healthy T value, Fascicles ordered by overlap with dep network") + 
  geom_bar(stat="identity") +
  ylim(0,5) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
print(plot_fascicle_by_t_sorted_by_dep_overlap)


# plot fascicle overlap x t value
#statistic, p = 0.010
dep_overlap_x_sex_t <- lm(sex_t ~ depression_mask_overlap, data=df_fascicle_dep_mask_overlap_t_value)
print(summary(dep_overlap_x_sex_t))

scatter_t_val_by_dep_net_overlap <- ggplot(data=df_fascicle_dep_mask_overlap_t_value, aes(x=depression_mask_overlap, y=sex_t)) +
  geom_point(size=1) + 
  geom_smooth(method=lm)+
  xlab("Proportion of Fascicle in Depression Network") + 
  ylab("Effect of diagnosis (T)") + 
  ggtitle("Fascicle/depression mask overlap by dx T, p = 0.010")
print(scatter_t_val_by_dep_net_overlap)


#statistic volume, p = 0.031
dep_overlap_x_sex_t <- lm(sex_t ~ volume_in_dep_mask, data=df_fascicle_dep_mask_overlap_t_value)
print(summary(dep_overlap_x_sex_t))

scatter_t_val_by_dep_net_overlap <- ggplot(data=df_fascicle_dep_mask_overlap_t_value, aes(x=volume_in_dep_mask, y=sex_t)) +
  geom_point(size=1) + 
  geom_smooth(method=lm)+
  xlab("Volume of Fascicle in Depression Network") + 
  ylab("Effect of diagnosis (T)") + 
  ggtitle("Fascicle/depression mask volume by dx T, p = 0.031")
print(scatter_t_val_by_dep_net_overlap)



#drop areas where there is no overlap with depression network, n = 62
df_removed_areas_with_no_depression_overlap <- df_fascicle_dep_mask_overlap_t_value %>% filter(depression_mask_overlap!=0)

#statistic, p = 0.040
df_removed_areas_with_no_depression_overlap_t <- lm(sex_t ~ depression_mask_overlap, data=df_removed_areas_with_no_depression_overlap)
print(summary(df_removed_areas_with_no_depression_overlap_t))

scatter_t_val_by_dep_net_overlap_removed_areas_with_no_dep_overlap <- ggplot(data=df_removed_areas_with_no_depression_overlap, aes(x=depression_mask_overlap, y=sex_t)) +
  geom_point(size=1) + 
  geom_smooth(method=lm)+
  xlab("Proportion of Fascicle in Depression Network (only areas that overlapped to some degree") + 
  ylab("Effect of diagnosis (T)") + 
  ggtitle("Fascicle/depression mask overlap by dx T, removed fascicles with no dep mask overlap, p = 0.040")
print(scatter_t_val_by_dep_net_overlap_removed_areas_with_no_dep_overlap)

### look at number of voxels, not just proportion


```



```{r depression_unique_all_fascicles_together_in_dep_networks}

#isolate out only the depressed group and healthy group, make a column that sums up the total prop lost)
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>% 
  filter(depGroupVar != 0)  %>% 
  mutate(total_fascicle_prop_lost = rowMeans(across(fascicle_names))) %>%
  mutate(total_fascicle_prop_lost_indepnet = rowMeans(across(fascicle_names_dep_network_all))) %>%
  mutate(total_fascicle_prop_lost_indepnet_10_percent =
           rowMeans(across(fascicle_names_dep_network_10_percent))) %>%
  mutate(total_fascicle_prop_lost_indepnet_5_percent =
           rowMeans(across(fascicle_names_dep_network_5_percent))) %>%
  mutate(total_fascicle_prop_lost_nondep_network =
           rowMeans(across(fascicle_names_nondep_network))) %>%
  mutate(total_fascicle_prop_lost_indepnet_top_quartile = 
           rowMeans(across(dep_network_names_top_quartile))) %>%
  mutate(total_fascicle_prop_lost_indepnet_bottom_quartile = 
           rowMeans(across(dep_network_names_bottom_quartile))) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()


dep_vs_healthy <- lm(total_fascicle_prop_lost ~ depGroupVar, data = dep_and_healthy_groups_for_ICD_analysis)
summary(dep_vs_healthy) #p=0.0494

dep_vs_healthy_top_quartile <- lm(total_fascicle_prop_lost_indepnet_top_quartile ~ depGroupVar, data = dep_and_healthy_groups_for_ICD_analysis)
summary(dep_vs_healthy_top_quartile) #p=0.054

#power analysis to predict sample required for K, u = num df, v = denom df, f2=0.01 (cohen d = 0.02/2) 
#prop in each fascicle predicting dep (87), number of predictors (age, sex, ef, ess?) = 4, u = 87-4 = 83
pwr.f2.test(u=83, f2 = 0.02, sig.level = 0.5, power = 0.8)

#test whether proportion lost overall different between depressed and healthy- yes, p = 0.049
total_volume_lost_dep_vs_healthy_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 27%, mean non_dep = 24%, p = 0.049, cohen d = 0.17


df_for_visreg <- as.data.frame(cbind(c(dep_and_healthy_groups_for_ICD_analysis$EMPI, dep_and_healthy_groups_for_ICD_analysis$EMPI), c(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]), c(rep(1,298), rep(2,298))))
names(df_for_visreg) <- c("EMPI", "prop_lost", "Diagnosis")
df_for_visreg$Diagnosis <- as.factor(df_for_visreg$Diagnosis)

plot <- ggplot(df_for_visreg, aes(x=Diagnosis, y = prop_lost, col=Diagnosis)) +
  geom_violin() + 
  geom_jitter(shape=16, position=position_jitter(0.05)) + 
  geom_boxplot(width=0.1) + theme_minimal() + 
  stat_summary(fun.y=median, geom="point", size=2, color="black") + 
  scale_x_discrete(labels=c("1" = "Depressed", "2" = "Non-Depressed"))

print(plot)

#bar plot
Diagnosis <- c("MS w/Depression", "MS No Depression")
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]),
           mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1]))

sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==2))),
           (sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==1))))

data <- data.frame(Diagnosis,value, sem)
#data$Fascicle <- pretty_names

# Grouped
barplot <- ggplot(data, aes(x=Diagnosis,fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", position=position_dodge(0.9)) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9)) + 
  ylab("Proportion of Fascicles Affected") +
  ylim(0,0.5) +
  theme(axis.text = element_text(size = 12, colour = "black"))
    
print(barplot)

# Grouped
barplot <- ggplot(data, aes(x=reorder(Diagnosis, -value),fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", colour="black", width=0.8, size=1.5) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9), size=1.5) +
  scale_fill_manual(values = c("#cdcdcd", "#FFFFFF")) + #comment out if you want colored graph
  ylab("Proportion of Fascicles Affected") +
  theme(axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
        axis.title.y = element_text(size=20),
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        panel.background = element_rect(colour = "white", fill = "white")) + #comment out if you want pretty 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.52)) #comment out if you want colored graph

print(barplot)



#look at within depression network specifically - trend, p = 0.054
total_volume_lost_dep_vs_healthy_unique_in_dep_network <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 33%, mean non_dep = 28%, p = 0.054

#look at within depression network in fascicles where at least 10% of the volume of the fascicle was in dep network
#yes, p = 0.055
total_volume_lost_dep_vs_healthy_unique_in_dep_network_10percent <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_10_percent[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_10_percent[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 32%, mean non_dep = 27%, p = 0.055

#look at within depression network in fascicles where at least 5% of the volume of the fascicle was in dep network
#yes, p=0.053
total_volume_lost_dep_vs_healthy_unique_in_dep_network_5percent <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_5_percent[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_5_percent[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 32%, mean non_dep = 27%, p = 0.053

#within 25% depression network; n = 0.053, depressed 33%, healthy 28%
total_volume_lost_dep_vs_healthy_unique_in_dep_network_top_quartile <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) 

#within bottom quartile depression network; n = 0.053, depressed 8%, healthy 7%, p=0.12
total_volume_lost_dep_vs_healthy_unique_in_dep_network_bottom_quartile <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_bottom_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_bottom_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) 

#look at outside depression network, yes p = 0.042
total_volume_lost_dep_vs_healthy_unique_in_nondep_network <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 14%, mean non_dep = 13%, p = 0.042

### Age actually makes things worse, switched age and dep group var around, values are the same
#however, when I send an anova over the linear model, depression group var becomes significant
dep_vs_healthy_w_age <- lm(total_fascicle_prop_lost ~ PAT_AGE_AT_EXAM + depGroupVar , data = dep_and_healthy_groups_for_ICD_analysis)
summary(dep_vs_healthy_w_age) #dep group var p = 0.101
dep_vs_healthy_w_age_anova=anova(dep_vs_healthy_w_age) # p = 0.044

#df for visreg - actually not using visreg. Just a nice way to see that there is significantly more loss in depression network versus outside depression network





```


```{r depression_unique_all_fascicles_together_in_dep_networks_no_cranial_nerves}

####

# so this is interesting. When you look at the top quartile, but exclude the cranial nerves, you drop a few more fascicles from the depression network (i.e. now it has 19 items, instead of 22). This actually pushes the depressed vs healthy within the depression network over the hump, becoming significant. Probably an even cooler finding. So if you look over all the fascicles, not significantly different. But if you look within the depression network (25%), depressed patients have more disease than healthy patients


#### 
#isolate out only the depressed group and healthy group, make a column that sums up the total prop lost)
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>% 
  filter(depGroupVar != 0)  %>% 
  mutate(total_fascicle_prop_lost = rowMeans(across(fascicle_names_dep_network_all_no_cranial_nerves))) %>%
  mutate(total_fascicle_prop_lost_indepnet = rowMeans(across(fascicle_names_dep_network_all_no_cranial_nerves))) %>% 
  mutate(total_fascicle_prop_lost_nondep_network =
           rowMeans(across(nondep_network_names_no_cranial_nerves))) %>%
  mutate(total_fascicle_prop_lost_indepnet_top_quartile = 
           rowMeans(across(dep_network_names_top_quartile_no_cranial_nerves))) %>%
  mutate(total_fascicle_prop_lost_nondep_bottom_3_quartiles = 
           rowMeans(across(dep_network_bottom_3_quartiles_no_cranial_nerves))) %>%
  mutate(total_fascicle_prop_lost_nondep_bottom_quartile = 
           rowMeans(across(dep_network_names_bottom_quartile_no_cranial_nerves))) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()


dep_vs_healthy <- lm(total_fascicle_prop_lost ~ depGroupVar, data = dep_and_healthy_groups_for_ICD_analysis)
summary(dep_vs_healthy) #p=0.055

dep_vs_healthy_top_quartile <- lm(total_fascicle_prop_lost_indepnet_top_quartile ~ depGroupVar, data = dep_and_healthy_groups_for_ICD_analysis)
summary(dep_vs_healthy_top_quartile) #p=0.048

dep_vs_healthy_nondep_bottom_3_quartiles <- lm(total_fascicle_prop_lost_nondep_bottom_3_quartiles ~ depGroupVar, data = dep_and_healthy_groups_for_ICD_analysis)
summary(dep_vs_healthy_nondep_bottom_3_quartiles) #p=0.057

#test whether proportion lost overall different between depressed and healthy- no, p = 0.054
total_volume_lost_dep_vs_healthy_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 33%, mean non_dep = 28%, p = 0.054


df_for_visreg <- as.data.frame(cbind(c(dep_and_healthy_groups_for_ICD_analysis$EMPI, dep_and_healthy_groups_for_ICD_analysis$EMPI), c(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]), c(rep(1,298), rep(2,298))))
names(df_for_visreg) <- c("EMPI", "prop_lost", "Diagnosis")
df_for_visreg$Diagnosis <- as.factor(df_for_visreg$Diagnosis)

plot <- ggplot(df_for_visreg, aes(x=Diagnosis, y = prop_lost, col=Diagnosis)) +
  geom_violin() + 
  geom_jitter(shape=16, position=position_jitter(0.05)) + 
  geom_boxplot(width=0.1) + theme_minimal() + 
  stat_summary(fun.y=median, geom="point", size=2, color="black") + 
  scale_x_discrete(labels=c("1" = "Depressed", "2" = "Non-Depressed"))

print(plot)

#bar plot
Diagnosis <- c("MS w/Depression", "MS No Depression")
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]),
           mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1]))

sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==2))),
           (sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==1))))

data <- data.frame(Diagnosis,value, sem)
#data$Fascicle <- pretty_names

# Grouped
barplot <- ggplot(data, aes(x=Diagnosis,fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", position=position_dodge(0.9)) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9)) + 
  ylab("Proportion of Fascicles Affected") +
  ylim(0,0.5) +
  theme(axis.text = element_text(size = 12, colour = "black"))
    
print(barplot)

# Grouped
barplot <- ggplot(data, aes(x=reorder(Diagnosis, -value),fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", colour="black", width=0.8, size=1.5) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9), size=1.5) +
  scale_fill_manual(values = c("#cdcdcd", "#FFFFFF")) + #comment out if you want colored graph
  ylab("Proportion of Fascicles Affected") +
  ggtitle("Total Prop Affected by dx") + 
  theme(axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
        axis.title.y = element_text(size=20),
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        plot.title = element_text(hjust=0.5, size = 14), 
        panel.background = element_rect(colour = "white", fill = "white")) + #comment out if you want pretty 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.52)) #comment out if you want colored graph

print(barplot)



#look at within depression network using top quartiles, yes p = 0.047
total_volume_lost_dep_vs_healthy_unique_in_dep_network_top_quartile <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 32%, mean non_dep = 26%, p = 0.047


#look at outside depression network (i.e. areas that never overalpped dep network), yes p = 0.049
total_volume_lost_dep_vs_healthy_unique_in_nondep_network <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 23%, mean non_dep = 20%, p = 0.049

#look at 75%, no p = 0.057
total_volume_lost_dep_vs_healthy_unique_in_bottom_3_quartiles <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_bottom_3_quartiles[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_bottom_3_quartiles[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 30%, mean non_dep = 27%, p = 0.057

#look at bottom quartile

total_volume_lost_dep_vs_healthy_unique_in_bottom_quartile <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_bottom_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_bottom_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 18%, mean non_dep = 16%, p = 0.13

############
#bar plot
############

Diagnosis <- c("MS w/Depression", "MS No Depression")
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]),
           mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1]))

sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==2))),
           (sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==1))))

data <- data.frame(Diagnosis,value, sem)
#data$Fascicle <- pretty_names

# Grouped
barplot <- ggplot(data, aes(x=Diagnosis,fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", position=position_dodge(0.9)) + 
  geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9)) + 
  ggtitle("Mean Prop Fasc Affected w/in 25% dep mask by dx; p=0.047") +
  ylab("Proportion of Fascicles Affected") +
  ylim(0,0.5) +
  theme(title = element_text(size=14),
    axis.text = element_text(size = 12, colour = "black"))
    
print(barplot)

# Grouped
barplot <- ggplot(data, aes(x=reorder(Diagnosis, -value),fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", colour="black", width=0.8, size=1.5) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9), size=1.5) +
  scale_fill_manual(values = c("#cdcdcd", "#FFFFFF")) + #comment out if you want colored graph
  ggtitle("Mean Prop Fasc Affected w/in 25% dep mask by dx; p=0.047") +
  ylab("Proportion of Fascicles Affected") +
  theme(title = element_text(size=14),
        axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
        axis.title.y = element_text(size=20),
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        panel.background = element_rect(colour = "white", fill = "white")) + #comment out if you want pretty 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.52)) #comment out if you want colored graph

print(barplot)

```


```{r depression_unique_all_fascicles_together_in_dep_networks_sum_rather_than_mean}

#### SUM DOESN"T CHANGE STATS AT ALL
#isolate out only the depressed group and healthy group, make a column that sums up the total prop lost)
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>% 
  filter(depGroupVar != 0)  %>% 
  mutate(total_fascicle_prop_lost = rowSums(across(fascicle_names))) %>%
  mutate(total_fascicle_prop_lost_indepnet = rowSums(across(fascicle_names_dep_network_all))) %>%
  mutate(total_fascicle_prop_lost_indepnet_10_percent =
           rowSums(across(fascicle_names_dep_network_10_percent))) %>%
   mutate(total_fascicle_prop_lost_indepnet_5_percent =
           rowSums(across(fascicle_names_dep_network_5_percent))) %>%
  mutate(total_fascicle_prop_lost_nondep_network =
           rowSums(across(fascicle_names_nondep_network))) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()


dep_vs_healthy <- lm(total_fascicle_prop_lost ~ depGroupVar, data = dep_and_healthy_groups_for_ICD_analysis)
summary(dep_vs_healthy) #p=0.0494


#power analysis to predict sample required for K, u = num df, v = denom df, f2=0.01 (cohen d = 0.02/2) 
#prop in each fascicle predicting dep (87), number of predictors (age, sex, ef, ess?) = 4, u = 87-4 = 83
pwr.f2.test(u=83, f2 = 0.02, sig.level = 0.5, power = 0.8)

#test whether proportion lost overall different between depressed and healthy- yes, p = 0.049
total_volume_lost_dep_vs_healthy_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 27%, mean non_dep = 24%, p = 0.049, cohen d = 0.17


df_for_visreg <- as.data.frame(cbind(c(dep_and_healthy_groups_for_ICD_analysis$EMPI, dep_and_healthy_groups_for_ICD_analysis$EMPI), c(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]), c(rep(1,298), rep(2,298))))
names(df_for_visreg) <- c("EMPI", "prop_lost", "Diagnosis")
df_for_visreg$Diagnosis <- as.factor(df_for_visreg$Diagnosis)

plot <- ggplot(df_for_visreg, aes(x=Diagnosis, y = prop_lost, col=Diagnosis)) +
  geom_violin() + 
  geom_jitter(shape=16, position=position_jitter(0.05)) + 
  geom_boxplot(width=0.1) + theme_minimal() + 
  stat_summary(fun.y=median, geom="point", size=2, color="black") + 
  scale_x_discrete(labels=c("1" = "Depressed", "2" = "Non-Depressed"))

print(plot)

#bar plot
Diagnosis <- c("MS w/Depression", "MS No Depression")
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]),
           mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1]))

sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==2))),
           (sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==1))))

data <- data.frame(Diagnosis,value, sem)
#data$Fascicle <- pretty_names

# Grouped
barplot <- ggplot(data, aes(x=Diagnosis,fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", position=position_dodge(0.9)) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9)) + 
  ylab("Proportion of Fascicles Affected") +
  ylim(0,40) +
  theme(axis.text = element_text(size = 12, colour = "black"))
    
print(barplot)

# Grouped
barplot <- ggplot(data, aes(x=reorder(Diagnosis, -value),fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", colour="black", width=0.8, size=1.5) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9), size=1.5) +
  scale_fill_manual(values = c("#cdcdcd", "#FFFFFF")) + #comment out if you want colored graph
  ylab("Proportion of Fascicles Affected") +
  theme(axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
        axis.title.y = element_text(size=20),
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        panel.background = element_rect(colour = "white", fill = "white")) + #comment out if you want pretty 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 40)) #comment out if you want colored graph

print(barplot)



#look at within depression network specifically - trend, p = 0.054
total_volume_lost_dep_vs_healthy_unique_in_dep_network <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 20.2, mean non_dep = 17.4, p = 0.054

#look at within depression network in fascicles where at least 10% of the volume of the fascicle was in dep network
#yes, p = 0.055
total_volume_lost_dep_vs_healthy_unique_in_dep_network_10percent <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_10_percent[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_10_percent[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 6.7, mean non_dep = 5.6, p = 0.055

#look at within depression network in fascicles where at least 5% of the volume of the fascicle was in dep network
#yes, p=0.053
total_volume_lost_dep_vs_healthy_unique_in_dep_network_5percent <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_5_percent[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_5_percent[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 10.2, mean non_dep = 8.6, p = 0.053


#look at outside depression network, yes p = 0.042
total_volume_lost_dep_vs_healthy_unique_in_nondep_network <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 3.6, mean non_dep = 3.2, p = 0.042

### Age actually makes things worse, switched age and dep group var around, values are the same
#however, when I send an anova over the linear model, depression group var becomes significant
dep_vs_healthy_w_age <- lm(total_fascicle_prop_lost ~ PAT_AGE_AT_EXAM + depGroupVar , data = dep_and_healthy_groups_for_ICD_analysis)
summary(dep_vs_healthy_w_age) #dep group var p = 0.101
dep_vs_healthy_w_age_anova=anova(dep_vs_healthy_w_age) # p = 0.044

#df for visreg - actually not using visreg. Just a nice way to see that there is significantly more loss in depression network versus outside depression network





```

```{r depressed_versus_healthy_unique_subjs_indiv_fascicle}
##### repeat above analysis but use only the first instance of each EMPI, sorted by date
df_unique_empi <- df_demo_and_fascicles %>% 
  filter(depGroupVar != 0) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup() 


#lm
fascicle_lm_unique <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ depGroupVar + PAT_AGE_AT_EXAM, list(i = as.name(x))), data = df_unique_empi)
})
names(fascicle_lm_unique) <- fascicle_names

#anova
fascicle_anova_unique <- lapply(fascicle_lm_unique, anova)

#fdr corrected
fascicle_anova_unique_fdr <- fdr_anova_generic(fascicle_anova_unique, 1)
print(fascicle_anova_unique_fdr)#anova values < 0.05, uncorrected

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_anova_unique[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)


#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_anova_unique[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr)

#fdr corrected only dep 10% mask
fascicle_anova_w_fiber_mapping <- fascicle_anova_unique[which(fascicle_bundle_mapping$inDepNetwork_vector ==2)]
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr)

#fdr corrected only dep 5% mask
fascicle_anova_w_fiber_mapping <- fascicle_anova_unique[which(fascicle_volumes_dep_network$prop_in_mask >= 0.05)]
fascicle_anova_fdr<- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr)




#uncorrected
fascicle_anova_unique_p <- sapply(fascicle_anova_unique, function(v) v$"Pr(>F)"[1])
fascicle_anova_unique_p05_unc <- as.data.frame(fascicle_anova_unique_p[fascicle_anova_unique_p < 0.05])
print(fascicle_anova_unique_p05_unc)

### plot AF_R 

df_for_visreg <- as.data.frame(cbind(c(dep_and_healthy_groups_for_ICD_analysis$EMPI, dep_and_healthy_groups_for_ICD_analysis$EMPI), c(dep_and_healthy_groups_for_ICD_analysis$AF_R[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$AF_R[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]), c(rep(1,298), rep(2,298))))
names(df_for_visreg) <- c("EMPI", "prop_lost", "Diagnosis")
df_for_visreg$Diagnosis <- as.factor(df_for_visreg$Diagnosis)



plot <- ggplot(df_for_visreg, aes(x=Diagnosis, y = prop_lost, col=Diagnosis)) +
  ggtitle("Arcuate Fasciculus R") + 
 # geom_violin() + 
  geom_jitter(shape=16, position=position_jitter(0.05)) + 
  geom_boxplot(width=0.1) + theme_minimal() + 
  stat_summary(fun.y=median, geom="point", size=2, color="black") + 
  scale_x_discrete(labels=c("1" = "Depressed", "2" = "Non-Depressed")) 
  
print(plot)

### Plot OR_R	0.69024050
df_for_visreg <- as.data.frame(cbind(c(dep_and_healthy_groups_for_ICD_analysis$EMPI, dep_and_healthy_groups_for_ICD_analysis$EMPI), c(dep_and_healthy_groups_for_ICD_analysis$OR_R[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$OR_R[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]), c(rep(1,298), rep(2,298))))
names(df_for_visreg) <- c("EMPI", "prop_lost", "Diagnosis")
df_for_visreg$Diagnosis <- as.factor(df_for_visreg$Diagnosis)



plot <- ggplot(df_for_visreg, aes(x=Diagnosis, y = prop_lost, col=Diagnosis)) +
  ggtitle("Optic Radiation R") + 
 # geom_violin() + 
  geom_jitter(shape=16, position=position_jitter(0.05)) + 
  geom_boxplot(width=0.1) + theme_minimal() + 
  stat_summary(fun.y=median, geom="point", size=2, color="black") + 
  scale_x_discrete(labels=c("1" = "Depressed", "2" = "Non-Depressed")) 
print(plot)


### grouped bar plot

Diagnosis <- c(rep("Depressed" , 2) , rep("Non-Depressed" , 2))
Fascicle <- rep(c("Depression Network (AF)" , "Region Outside Depression Network (C_PH)"), 2)
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$AF_R[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]),
           mean(dep_and_healthy_groups_for_ICD_analysis$C_PH_L[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]),
           mean(dep_and_healthy_groups_for_ICD_analysis$AF_R[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1]),
           mean(dep_and_healthy_groups_for_ICD_analysis$C_PH_L[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1]))

sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$AF_R[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==2))),
           (sd(dep_and_healthy_groups_for_ICD_analysis$C_PH_L[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==2))),
           (sd(dep_and_healthy_groups_for_ICD_analysis$AF_R[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==1 ))),
          (sd(dep_and_healthy_groups_for_ICD_analysis$C_PH_L[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==1 ))))

data <- data.frame(Diagnosis,Fascicle,value, sem)
#data$Fascicle <- pretty_names

# Grouped
barplot <- ggplot(data, aes(fill=Diagnosis, y=value, x=Fascicle)) + 
    geom_bar(position="dodge", stat="identity") + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9)) + 
  ylab("Proportion of Fascicles Affected") +
  theme(axis.text = element_text(size = 12, colour = "black"), axis.title.x = element_blank())
    
print(barplot)


# Grouped
barplot <- ggplot(data, aes(fill=Diagnosis, y=value, x=Fascicle)) + 
    geom_bar(position="dodge", stat="identity") + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9)) + 
  ylab("Proportion of Fascicles Affected") +
  theme(axis.text = element_text(size = 12, colour = "black"), axis.title.x = element_blank())
    
print(barplot)


barplot2 <- ggplot(data, aes(fill=Diagnosis, y=value, x=Fascicle)) + 
    geom_bar(position="dodge", stat="identity", colour = "black", width=0.9,size=1.5) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9), size=1) + 
    scale_fill_manual(values = c("#cdcdcd", "#FFFFFF", "#cdcdcd", "#FFFFFF")) + #comment out if you want colored graph
 
    ylab("Proportion of Fascicles Affected") +
    theme(axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
          axis.title.y = element_text(size=20),
          axis.line = element_line(size = 1.5, colour = "black", linetype=1),
          panel.background = element_rect(colour = "white", fill = "white")) + #comment out if you want pretty graph
    scale_y_continuous(expand = c(0, 0), limits = c(0, 0.52)) #comment out if you want colored graph


print(barplot2)


```

```{r testing_whether_ms_disease_more_likely_in_depression_mask_unique}
### tests whether there is higher proportion of vertices lost in depression network versus not

#some new subnetworks

#filter
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>% 
  filter(depGroupVar != 0)  %>% 
  mutate(total_fascicle_prop_lost = rowMeans(across(fascicle_names))) %>%
  mutate(total_fascicle_prop_lost_indepnet = rowMeans(across(fascicle_names_dep_network_all))) %>%
  mutate(total_fascicle_prop_lost_indepnet_10_percent =
           rowMeans(across(fascicle_names_dep_network_10_percent))) %>%
  mutate(total_fascicle_prop_lost_indepnet_5_percent =
           rowMeans(across(fascicle_names_dep_network_5_percent))) %>%
  mutate(total_fascicle_prop_lost_nondep_network =
           rowMeans(across(fascicle_names_nondep_network))) %>%
  mutate(total_fascicle_prop_lost_indepnet_top_quartile = 
           rowMeans(across(dep_network_names_top_quartile))) %>%
  mutate(total_fascicle_prop_lost_indepnet_bottom_three_quartiles = 
           rowMeans(across(dep_network_bottom_3_quartiles))) %>%
  mutate(total_fascicle_prop_lost_indepnet_bottom_quartile = 
           rowMeans(across(dep_network_names_bottom_quartile))) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ### when I filter and remove fascicles where there was no loss at all, the depression vs healthy findings go away
#  filter(total_fascicle_prop_lost > 0) %>%
  ungroup()


#test whether there is differentially more volume loss in depression versus nondepression network
volume_lost_dep_vs_nondep_network_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet, dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network, var.equal = F) #mean dep_net = 31%, mean non_dep_net =  14%, p 2.2 x 10^-16

volume_lost_dep10_vs_nondep_network_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_10_percent,
dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network, var.equal = F) #mean dep net = 30%, mean non_dep_net = 14%, p 2.2 * 10^-16

volume_lost_dep5_vs_nondep_network_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_5_percent,
dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network, var.equal = F) #mean dep net = 30%, mean non_dep_net = 14%, p 2.2 * 10^-16

#compares top quartile of depression network with fascicles that NEVER overlapped w/depression network
volume_lost_dep_vs_nondep_network_top_quartile_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_top_quartile,
dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network, var.equal = F) #mean dep net = 31%, mean non_dep_net = 20%, p 2.2 * 10^-16

#compares top quartile of depression network with all fascicles that are NOT in the top quartile of depression network; i.e. everything not in top quartile is the "non"-depressed network
volume_lost_dep_top_versus_bottom_3_quartiles_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_top_quartile,
dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_bottom_three_quartiles, var.equal = F) #mean dep net = 31%, mean bottom 3 quartiles = 24, p 1.6 * 10^-5

#compares top quartile of depression network with bottom quartile of depression network
volume_lost_dep_top_versus_bottom_quartile_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_top_quartile,
dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_bottom_quartile, var.equal = F) #mean dep net = 31%, mean bottom quartile = 7%, p 2.2 * 10^-16

#df for visreg - actually not using visreg. Just a nice way to see that there is significantly more loss in depression network versus outside depression network
df_for_visreg <- as.data.frame(cbind(c(dep_and_healthy_groups_for_ICD_analysis$EMPI, dep_and_healthy_groups_for_ICD_analysis$EMPI), c(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet, dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network), c(rep(1,298), rep(2,298))))
names(df_for_visreg) <- c("EMPI", "prop_lost", "network")
df_for_visreg$network <- as.factor(df_for_visreg$network)

plot <- ggplot(df_for_visreg, aes(x=network, y = prop_lost, col=network)) +
  geom_violin() + 
  geom_jitter(shape=16, position=position_jitter(0.05)) + 
  geom_boxplot(width=0.1) + theme_minimal() + 
  stat_summary(fun.y=median, geom="point", size=2, color="red") + 
  scale_x_discrete(labels=c("1" = "Depression Network", "2" = "Non-Depression Network")) + 
  ylab("Proportion of Fascicles Affected") + 
  theme(axis.text =element_text(size=14), axis.title.x = element_blank())
  
print(plot)

########## Bar plot
Network <- c("Depression Network","Non-Depression Network")
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet),
           mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network))

sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet)/sqrt(dim(dep_and_healthy_groups_for_ICD_analysis)[1])),
           (sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network)/sqrt(dim(dep_and_healthy_groups_for_ICD_analysis)[1])))

data <- data.frame(Network,value,sem)
#data$Fascicle <- pretty_names

# Grouped
barplot <- ggplot(data, aes(x=Network,fill=Network, y=value)) + 
  geom_bar(stat="identity", position=position_dodge(0.9)) + 
  geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9)) + 
  ylab("Proportion of Fascicles Affected") +
  ylim(0,0.5) +
  theme(axis.text = element_text(size = 12, colour = "black"))
    
print(barplot)
# Black and white
barplot <- ggplot(data, aes(x=Network,fill=Network, y=value)) + 
  geom_bar(stat="identity", colour="black", width=0.8, size=1.5) + 
  geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9), size=1.5) +
  scale_fill_manual(values = c("#cdcdcd", "#FFFFFF")) + #comment out if you want colored graph
  ylab("Proportion of Fascicles Affected") +
  theme(axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
        axis.title.y = element_text(size=20),
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        panel.background = element_rect(colour = "white", fill = "white")) + #comment out if you want pretty 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.52)) #comment out if you want colored graph


print(barplot)



###### Depression network x depression group interaction - It is there, depression always worse. 
#these lms largely match up with the t.tests above. Sig differences between depressed (more disease) within and outside of mask

loss_in_dep_network <- lm(total_fascicle_prop_lost_indepnet~depGroupVar, data = dep_and_healthy_groups_for_ICD_analysis) #non sig, p = 0.055
loss_in_dep_network_10_percent <- lm(total_fascicle_prop_lost_indepnet_10_percent~depGroupVar, data = dep_and_healthy_groups_for_ICD_analysis) #p = 0.056
loss_in_nondep_network <- lm(total_fascicle_prop_lost_nondep_network~depGroupVar, data = dep_and_healthy_groups_for_ICD_analysis) #p=0.042

```

```{r testing_whether_ms_disease_more_likely_in_depression_mask_unique_no_cranial_nerves}
### tests whether there is higher proportion of vertices lost in depression network versus not

### Take home here - 
## 1) in the absence of the cranial nerves, more disease in areas than interact w/depression network vs places that never had any overlap
## 2) in the absence of the cranial nerves, more disease in the top 25% than in areas that never intersected with depression map 
## 3) in the absense of cranial nerves, the difference between the top 25% and the bottom 75% is no longer significant

#some new subnetworks

#filter
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>% 
  filter(depGroupVar != 0)  %>% 
  mutate(total_fascicle_prop_lost = rowMeans(across(fascicle_names_no_cranial_nerves))) %>%
  mutate(total_fascicle_prop_lost_indepnet = rowMeans(across(fascicle_names_dep_network_all_no_cranial_nerves))) %>%
  mutate(total_fascicle_prop_lost_nondep_network =
           rowMeans(across(nondep_network_names_no_cranial_nerves))) %>%
  mutate(total_fascicle_prop_lost_indepnet_top_quartile = 
           rowMeans(across(dep_network_names_top_quartile_no_cranial_nerves))) %>%
  mutate(total_fascicle_prop_lost_indepnet_bottom_three_quartiles = 
           rowMeans(across(dep_network_bottom_3_quartiles_no_cranial_nerves))) %>%
  mutate(total_fascicle_prop_lost_indepnet_bottom_quartile = 
           rowMeans(across(dep_network_names_bottom_quartile_no_cranial_nerves))) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ### when I filter and remove fascicles where there was no loss at all, the depression vs healthy findings go away
#  filter(total_fascicle_prop_lost > 0) %>%
  ungroup()


#test whether there is differentially more volume loss in depression versus nondepression network
volume_lost_dep_vs_nondep_network_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet, dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network, var.equal = F) #mean dep_net = 31%, mean non_dep_net =  22%, p 8.58 x 10^-12


#compares top quartile of depression network with fascicles that NEVER overlapped w/depression network
volume_lost_dep_vs_nondep_network_top_quartile_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_top_quartile,
dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network, var.equal = F) #mean dep net = 30%, mean non_dep_net = 22%, p 7.3* 10^-8

#compares top quartile of depression network with all fascicles that are NOT in the top quartile of depression network; i.e. everything not in top quartile is the "non"-depressed network
volume_lost_dep_top_versus_bottom_3_quartiles_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_top_quartile,
dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_bottom_three_quartiles, var.equal = F) #mean dep net = 30%, mean bottom 3 quartiles = 29, p = 0.52

#compares top quartile of depression network with bottom quartile of depression network; 
volume_lost_dep_top_versus_bottom_quartile_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_top_quartile,
dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_bottom_quartile, var.equal = F) #mean dep net = 30%, mean bottom quartile= 28, p = 0.4


#df for visreg - actually not using visreg. Just a nice way to see that there is significantly more loss in depression network versus outside depression network
df_for_visreg <- as.data.frame(cbind(c(dep_and_healthy_groups_for_ICD_analysis$EMPI, dep_and_healthy_groups_for_ICD_analysis$EMPI), c(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet, dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network), c(rep(1,298), rep(2,298))))
names(df_for_visreg) <- c("EMPI", "prop_lost", "network")
df_for_visreg$network <- as.factor(df_for_visreg$network)

plot <- ggplot(df_for_visreg, aes(x=network, y = prop_lost, col=network)) +
  geom_violin() + 
  geom_jitter(shape=16, position=position_jitter(0.05)) + 
  geom_boxplot(width=0.1) + theme_minimal() + 
  stat_summary(fun.y=median, geom="point", size=2, color="red") + 
  scale_x_discrete(labels=c("1" = "Depression Network", "2" = "Non-Depression Network")) + 
  ylab("Proportion of Fascicles Affected") + 
  theme(axis.text =element_text(size=14), axis.title.x = element_blank())
  
print(plot)

########## Bar plot
Network <- c("Depression Network","Non-Depression Network")
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet),
           mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network))

sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet)/sqrt(dim(dep_and_healthy_groups_for_ICD_analysis)[1])),
           (sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_network)/sqrt(dim(dep_and_healthy_groups_for_ICD_analysis)[1])))

data <- data.frame(Network,value,sem)
#data$Fascicle <- pretty_names

# Grouped
barplot <- ggplot(data, aes(x=Network,fill=Network, y=value)) + 
  geom_bar(stat="identity", position=position_dodge(0.9)) + 
  geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9)) + 
  ylab("Proportion of Fascicles Affected") +
  ylim(0,0.5) +
  theme(axis.text = element_text(size = 12, colour = "black"))
    
print(barplot)
# Black and white
barplot <- ggplot(data, aes(x=Network,fill=Network, y=value)) + 
  geom_bar(stat="identity", colour="black", width=0.8, size=1.5) + 
  geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9), size=1.5) +
  scale_fill_manual(values = c("#cdcdcd", "#FFFFFF")) + #comment out if you want colored graph
  ylab("Proportion of Fascicles Affected") +
  theme(axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
        axis.title.y = element_text(size=20),
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        panel.background = element_rect(colour = "white", fill = "white")) + #comment out if you want pretty 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.52)) #comment out if you want colored graph


print(barplot)

```


```{r phq9_correlation_fascicles}

####### NOTHING SIGNIFICANT!!!! ########3
#isolate out only the depressed group and healthy group
with_phq9 <- df_demo_and_fascicles %>%
  filter(depGroupVar != 0) %>%
  filter(!is.na(PHQ.9)) %>%
  mutate(total_fascicle_prop_lost = rowMeans(across(fascicle_names))) %>%
  mutate(total_fascicle_prop_lost_indepnet = rowMeans(across(fascicle_names_dep_network_all))) %>%
  mutate(total_fascicle_prop_lost_indepnet_10_percent =
           rowMeans(across(fascicle_names_dep_network_10_percent))) %>%
  mutate(total_fascicle_prop_lost_indepnet_5_percent =
           rowMeans(across(fascicle_names_dep_network_5_percent))) %>%
  mutate(total_fascicle_prop_lost_nondep_network =
           rowMeans(across(fascicle_names_nondep_network))) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()

#lm
fascicle_lm <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ PHQ.9, list(i = as.name(x))), data = with_phq9)
})
names(fascicle_lm) <- fascicle_names

#anova
fascicle_anova <- lapply(fascicle_lm, anova)

#fdr corrected
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova, 1)
print(fascicle_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr<- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr)

#fdr corrected only dep 10% mask
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$inDepNetwork_vector == 2)]
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr)

#uncorrected
fascicle_anova_p <- sapply(fascicle_anova, function(v) v$"Pr(>F)"[1])
fascicle_anova_p05_unc <- fascicle_anova_p[!is.na(fascicle_anova_p) & fascicle_anova_p < 0.05]
print(fascicle_anova_p05_unc)


######### overall fascicle proportion affected - nothing is significant
overall_prop_affected <- lm(total_fascicle_prop_lost~PHQ.9, data=with_phq9)
overall_prop_affected_depnet <- lm(total_fascicle_prop_lost_indepnet~PHQ.9, data=with_phq9)
overall_prop_affected_depnet_10percent <- lm(total_fascicle_prop_lost_indepnet_10_percent~PHQ.9, data=with_phq9)
overall_prop_affected_depnet_5percent <- lm(total_fascicle_prop_lost_indepnet_5_percent~PHQ.9, data=with_phq9)
overall_prop_affected_nondep <- lm(total_fascicle_prop_lost_nondep_network~PHQ.9, data=with_phq9)
```

```{r phq9_regressions_just_dep_group}
##### NOTHING SIGNIFICANT ########
##################################
## Just within depression group ##
##################################
#isolate out only the depressed group and healthy group
with_phq9 <- df_demo_and_fascicles %>%
  filter(depGroupVar == 2) %>%
  filter(!is.na(PHQ.9)) %>%
  mutate(total_fascicle_prop_lost = rowMeans(across(fascicle_names))) %>%
  mutate(total_fascicle_prop_lost_indepnet = rowMeans(across(fascicle_names_dep_network_all))) %>%
  mutate(total_fascicle_prop_lost_indepnet_10_percent =
           rowMeans(across(fascicle_names_dep_network_10_percent))) %>%
  mutate(total_fascicle_prop_lost_indepnet_5_percent =
           rowMeans(across(fascicle_names_dep_network_5_percent))) %>%
  mutate(total_fascicle_prop_lost_nondep_network =
           rowMeans(across(fascicle_names_nondep_network))) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()
#lm
fascicle_lm <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ PHQ.9, list(i = as.name(x))), data = with_phq9)
})
names(fascicle_lm) <- fascicle_names

#anova
fascicle_anova <- lapply(fascicle_lm, anova)

#fdr corrected
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova, 1)
print(fascicle_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr<- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr)


#fdr corrected only dep 10% mask
fascicle_anova_w_fiber_mapping <- fascicle_anova[which(fascicle_bundle_mapping$inDepNetwork_vector == 2)]
fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr)

#uncorrected
fascicle_anova_p <- sapply(fascicle_anova, function(v) v$"Pr(>F)"[1])
fascicle_anova_p05_unc <- fascicle_anova_p[!is.na(fascicle_anova_p) & fascicle_anova_p < 0.05]
print(fascicle_anova_p05_unc)

######### overall fascicle proportion affected - nothing is significant
overall_prop_affected <- lm(total_fascicle_prop_lost~PHQ.9, data=with_phq9)
overall_prop_affected_depnet <- lm(total_fascicle_prop_lost_indepnet~PHQ.9, data=with_phq9)
overall_prop_affected_depnet_10percent <- lm(total_fascicle_prop_lost_indepnet_10_percent~PHQ.9, data=with_phq9)
overall_prop_affected_depnet_5percent <- lm(total_fascicle_prop_lost_indepnet_5_percent~PHQ.9, data=with_phq9)
overall_prop_affected_nondep <- lm(total_fascicle_prop_lost_nondep_network~PHQ.9, data=with_phq9)

#visreg
#sapply(fascicle_lm, visreg)
```
All the mixed models are below
```{r age_effects_indiv_fascicles_mm}

### This subscript compares proportion of fascicles lost across age for each fascicle of the 80+. Looks lonly at the people in the depressed versus healthy group. Importantly, I ran this looking at everyone, at the results are the same.
### Separately considers findings just within the association cortex

#isolate out only the depressed group and healthy group
df_mm <- df_demo_and_fascicles %>% filter(depGroupVar != 0)
#n depressed = 859, healthy = 604, total n = 1463


#lm
fascicle_lm_mm <- lapply(fascicle_names, function(x) 
{
  lmerTest::lmer(substitute(i ~ PAT_AGE_AT_EXAM + (1 | EMPI), list(i = as.name(x))), data = df_mm)
})
names(fascicle_lm_mm) <- fascicle_names

#anova
fascicle_anova_mm <- lapply(fascicle_lm_mm, anova)

#fdr corrected
fascicle_anova_mm_fdr <- fdr_anova_generic(fascicle_anova_mm, 1)
print(fascicle_anova_mm_fdr)#anova values < 0.05, uncorrected

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_anova_mm[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_anova_mm[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network 10%
fascicle_anova_w_fiber_mapping <- fascicle_anova_mm[which(fascicle_bundle_mapping$inDepNetwork_vector == 2)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_anova_mm_p <- sapply(fascicle_anova_mm, function(v) v$"Pr(>F)"[1])
fascicle_anova_mm_p05_unc <- as.data.frame(fascicle_anova_mm_p[fascicle_anova_mm_p < 0.05])
print(fascicle_anova_mm_p05_unc)


```

```{r sex_effects_fascicles_mm}
########### sex effect whole group

#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>% filter(depGroupVar != 0) 
#healthhy = 713, total n = 1106

#### sex histo ###
hist(dep_and_healthy_groups_for_ICD_analysis$sex_binarized,
main = paste0("Sex In Good Mimosa Group : n (M/F)= ", sum(dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1), "/", sum(dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)),  xlab = "Sex", breaks = 2)

#lm
fascicle_sex_lm <- lapply(fascicle_names, function(x) 
{
  lmerTest::lmer(substitute(i ~ osex + (1|EMPI), list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_sex_lm) <- fascicle_names

#anova
fascicle_sex_anova <- lapply(fascicle_sex_lm, anova)

#fdr corrected
fascicle_sex_anova_fdr <- fdr_anova_generic(fascicle_sex_anova, 1)
print(fascicle_sex_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sex_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_anova_mm_p <- sapply(fascicle_sex_anova, function(v) v$"Pr(>F)"[1])
fascicle_anova_mm_p05_unc <- as.data.frame(fascicle_anova_mm_p[fascicle_anova_mm_p < 0.05])
print(fascicle_anova_mm_p05_unc)
#visreg
#sapply(fascicle_sex_lm,visreg)
```

```{r depressed_versus_healthy_indiv_fascicles_mm}

### This subscript compares proportion of fascicles lost for each fascicle of the 80+ between those in the depressed and the clean healthy group. Done as both a mixed model as well as using unique individuals alone.

#Of note, adding age into this model makes things WORSE

### Separately considers findings just within the association cortex
#isolate out only the depressed group and healthy group
df_mm <- df_demo_and_fascicles %>% filter(depGroupVar != 0)
#n depressed = 859, healthy = 604, total n = 1463


#lm
fascicle_lm_mm <- lapply(fascicle_names, function(x) 
{
  lmerTest::lmer(substitute(i ~ depGroupVar + (1 | EMPI), list(i = as.name(x))), data = df_mm)
})
names(fascicle_lm_mm) <- fascicle_names

#anova
fascicle_anova_mm <- lapply(fascicle_lm_mm, anova)

#fdr corrected
fascicle_anova_mm_fdr <- fdr_anova_generic(fascicle_anova_mm, 1)
print(fascicle_anova_mm_fdr)#anova values < 0.05, uncorrected

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_anova_mm[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_anova_mm[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network 10%
fascicle_anova_w_fiber_mapping <- fascicle_anova_mm[which(fascicle_bundle_mapping$inDepNetwork_vector == 2)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_anova_mm_p <- sapply(fascicle_anova_mm, function(v) v$"Pr(>F)"[1])
fascicle_anova_mm_p05_unc <- as.data.frame(fascicle_anova_mm_p[fascicle_anova_mm_p < 0.05])
print(fascicle_anova_mm_p05_unc)


```


Lastly, this section will explore interactions (age * dep), (sex * dep)

```{r age_by_depression_unique}

#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>%
  filter(depGroupVar != 0)  %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()

#lm
fascicle_agedep_lm <- lapply(fascicle_names, function(x) 
{
   lm(substitute(i ~ PAT_AGE_AT_EXAM*depGroupVar, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
# lm(substitute(i ~ depGroupVar + PAT_AGE_AT_EXAM + osex, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_agedep_lm) <- fascicle_names

#anova
fascicle_agedep_anova <- lapply(fascicle_agedep_lm, anova)


#fdr corrected - depression alone
fascicle_agedep_anova_fdr <- fdr_anova_generic(fascicle_agedep_anova, 2)
print(fascicle_agedep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_agedep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,2)
print(fascicle_anova_fdr_association)

#fdr corrected - interaction
fascicle_agedep_anova_fdr <- fdr_anova_generic(fascicle_agedep_anova, 3)
print(fascicle_agedep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_agedep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,3)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_agedep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,3)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network 10%
fascicle_anova_w_fiber_mapping <- fascicle_agedep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector == 2)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,3)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_anova_p <- sapply(fascicle_agedep_anova, function(v) v$"Pr(>F)"[3])
fascicle_anova_p05_unc <- as.data.frame(fascicle_anova_p[fascicle_anova_p < 0.05])
print(fascicle_anova_p05_unc)
```

```{r sex_by_depression_unique}

#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>%
  filter(depGroupVar != 0)  %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()

#lm
fascicle_sexdep_lm <- lapply(fascicle_names, function(x) 
{
   lm(substitute(i ~ osex*depGroupVar, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)

})
names(fascicle_sexdep_lm) <- fascicle_names

#anova
fascicle_sexdep_anova <- lapply(fascicle_sexdep_lm, anova)


#fdr corrected - depression alone
fascicle_sexdep_anova_fdr <- fdr_anova_generic(fascicle_sexdep_anova, 2)
print(fascicle_sexdep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,2)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_anova_p <- sapply(fascicle_sexdep_anova, function(v) v$"Pr(>F)"[2])
fascicle_anova_p05_unc <- as.data.frame(fascicle_anova_p[fascicle_anova_p < 0.05])
print(fascicle_anova_p05_unc)

#fdr corrected - interaction
fascicle_sexdep_anova_fdr <- fdr_anova_generic(fascicle_sexdep_anova, 3)
print(fascicle_sexdep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,3)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,3)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network 10%
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector == 2)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,3)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_anova_p <- sapply(fascicle_sexdep_anova, function(v) v$"Pr(>F)"[3])
fascicle_anova_p05_unc <- as.data.frame(fascicle_anova_p[fascicle_anova_p < 0.05])
print(fascicle_anova_p05_unc)
```
Interaction models below

```{r sexdep_effects_fascicles_unique_age_cov}

### Trying to figure out if there are any sex * depression effects, covarying for age given that men tend to get worse over time. dep*sex uncorrected in SLF1_L and CNVIII_R p< 0.05)

#isolate out only the depressed group and healthy group
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>% filter(depGroupVar != 0)  %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()

#### sex histo ###
hist(dep_and_healthy_groups_for_ICD_analysis$sex_binarized,
main = paste0("Sex In Good Mimosa Group : n (M/F)= ", sum(dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1), "/", sum(dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)),  xlab = "Sex", breaks = 2)

#lm
fascicle_sexdep_lm <- lapply(fascicle_names, function(x) 
{
  lm(substitute(i ~ depGroupVar*osex + PAT_AGE_AT_EXAM, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis)
})
names(fascicle_sexdep_lm) <- fascicle_names

#anova
fascicle_sexdep_anova <- lapply(fascicle_sexdep_lm, anova)


##### depGroupVar ####
### 12 areas, nearly identical to reg model

#fdr corrected
fascicle_sexdep_anova_fdr <- fdr_anova_generic(fascicle_sexdep_anova, 1)
print(fascicle_sexdep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_sexdep_anova_p <- sapply(fascicle_sexdep_anova, function(v) v$"Pr(>F)"[1])
fascicle_sexdep_anova_p05_unc <- as.data.frame(fascicle_sexdep_anova_p[fascicle_sexdep_anova_p < 0.05])
print(fascicle_sexdep_anova_p05_unc) ### CNVIII p < 0.05

##### sex differences ####
## same as above, just add in CNVIII_R

#fdr corrected
fascicle_sexdep_anova_fdr <- fdr_anova_generic(fascicle_sexdep_anova, 2)
print(fascicle_sexdep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,2)
print(fascicle_anova_fdr_association)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,2)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_sexdep_anova_p <- sapply(fascicle_sexdep_anova, function(v) v$"Pr(>F)"[2])
fascicle_sexdep_anova_p05_unc <- as.data.frame(fascicle_sexdep_anova_p[fascicle_sexdep_anova_p < 0.05])
print(fascicle_sexdep_anova_p05_unc) ### CNVIII p < 0.05


#######interaction ####

### SLF1_L and CNVIII_R

#fdr corrected interaction
fascicle_sexdep_anova_fdr <- fdr_anova_generic(fascicle_sexdep_anova, 4)
print(fascicle_sexdep_anova_fdr)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,4)
print(fascicle_anova_fdr_association)

#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_sexdep_anova[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,4)
print(fascicle_anova_fdr_association)

#uncorrected
fascicle_sexdep_anova_p <- sapply(fascicle_sexdep_anova, function(v) v$"Pr(>F)"[4])
fascicle_sexdep_anova_p05_unc <- as.data.frame(fascicle_sexdep_anova_p[fascicle_sexdep_anova_p < 0.05])
print(fascicle_sexdep_anova_p05_unc) #p uncorrected slf1_L p = 0.0488, CNVIII_R 0.01)


### grouped bar and line plot

Diagnosis <- c(rep("Depressed" , 2) , rep("Non-Depressed" , 2))
Sex <- rep(c("Male" , "Female"), 2)
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$SLF1_L[(dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1)]),
           mean(dep_and_healthy_groups_for_ICD_analysis$SLF1_L[(dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)]),
           mean(dep_and_healthy_groups_for_ICD_analysis$SLF1_L[(dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1)]),
           mean(dep_and_healthy_groups_for_ICD_analysis$SLF1_L[(dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)]))


sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$SLF1_L[(dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1)])/sqrt(sum((dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1)))),
         (sd(dep_and_healthy_groups_for_ICD_analysis$SLF1_L[(dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)])/sqrt(sum((dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)))),
         (sd(dep_and_healthy_groups_for_ICD_analysis$SLF1_L[(dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1)])/sqrt(sum((dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 1)))),
         (sd(dep_and_healthy_groups_for_ICD_analysis$SLF1_L[(dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)])/sqrt(sum((dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1) & (dep_and_healthy_groups_for_ICD_analysis$sex_binarized == 2)))))
           

data <- data.frame(Diagnosis,Sex,value, sem)
#data$Fascicle <- pretty_names

# Grouped
barplot <- ggplot(data, aes(fill=Sex, y=value, x=Diagnosis)) + 
    geom_bar(position="dodge", stat="identity") + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9)) + 
  ylab("Proportion of SLF Affected") +
  theme(axis.text = element_text(size = 12, colour = "black"), axis.title.x = element_blank())
    
print(barplot)



lineplot <- ggplot(data=data, aes(fill=Sex, y=value, x=Diagnosis, group = Sex)) + 

    geom_line(aes(color=Sex, size=0.9)) +
    geom_point(aes(color=Sex, size=0.9)) +
    ylim(0.05,0.30)+
    ylab("Proportion of SLF Affected") +
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1) + 
    theme(axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank())
    
print(lineplot)



```
```{r compare_proportion_overlap_in_dep_3_49_and_3_09_maps}
fascicle_proportions <- read.csv(paste0(homedir, "/results/fascicle_volumes_all_subjects_roi_n2336.csv"), header = T, sep = ",") #n = 2336

#fascicle names are contained in all but the first 2 columns of the fascicle_proportions df
fascicle_names <- names(fascicle_proportions[3:dim(fascicle_proportions)[2]])


dep_map_3_49 <-
  read.csv(paste0(homedir, "results/streamline_volume_within_dep_network.csv"), sep = ",", header = T)
dep_map_3_09 <-
  read.csv(paste0(homedir, "results/streamline_volume_within_dep_network_3_09.csv"), sep = ",", header = T)

dep_map_together <- data.frame(dep_map_3_49$fascicle, round(dep_map_3_49$prop_in_mask,3), round(dep_map_3_09$prop_in_mask,3))
names(dep_map_together) <- c("fascicle", "dep_map_3_49_prop", "dep_map_3_09_prop")

#get fascicle names vectors
#fascicle names are contained in all but the first 2 columns of the fascicle_proportions df
fascicle_names <- names(fascicle_proportions[3:dim(fascicle_proportions)[2]])
names_dep_map_3_49 <- gsub("^(.*)", "\\1_3_49", fascicle_names)
names_dep_map_3_09 <- gsub("^(.*)", "\\1_3_09", fascicle_names)

#multiply each row (Margin=2 equals by row), each %overlap w/depression map of that fascicle, this is like a dysconnectome score, but doesn't take into account the STRENGTH(T) of the voxels in the depression mask. Using the third column to the end of the fascicle_proportions data_frame because the first 2 are empi and date
lesion_prop_x_prop_in_dep_mask_3_49<-sweep(fascicle_proportions[,3:(dim(fascicle_proportions)[2])], MARGIN=2, dep_map_together$dep_map_3_49_prop, `*`)
names(lesion_prop_x_prop_in_dep_mask_3_49) <- names_dep_map_3_49

lesion_prop_x_prop_in_dep_mask_3_09<-sweep(fascicle_proportions[,3:(dim(fascicle_proportions)[2])], MARGIN=2, dep_map_together$dep_map_3_09_prop, `*`)
names(lesion_prop_x_prop_in_dep_mask_3_09) <- names_dep_map_3_09

#merge them all together, big data frame, the proportion of each fascicle that is affected per person, and the proportion of that fascicle with the proportion of depression overlap for that fascicle

fascicle_volumes_dep_w_lesion_prop_x_prop_in_dep_mask <- data.frame(fascicle_proportions, lesion_prop_x_prop_in_dep_mask_3_49, lesion_prop_x_prop_in_dep_mask_3_09)


df_demo_and_fascicles <- merge(data_empi_acc_f_phq, fascicle_volumes_dep_w_lesion_prop_x_prop_in_dep_mask, by = c("EMPI", "EXAM_DATE")) #n = 2962




#get unique first scan, n = 380

dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>%
  filter(depGroupVar != 0)  %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()


### for 3_09

#### map the fiber bundles
fascicle_names_dep_network_grouping <- paste0(homedir,  "/templates/dti/HCP_YA1065_tractography/fascicle_names_dep_network_grouping_3_09.csv")

fascicle_bundle_mapping <- get_fascicle_bundle_mapping_generic_dep_mask(dep_network_grouping_file = fascicle_names_dep_network_grouping)

#0 is not in, 1 is between 0 and 10% mask, 2 is 10% mask, >0 is all
names_dep_map_3_09_excluding_na_cols <- names_dep_map_3_09[which(fascicle_bundle_mapping$inDepNetwork_vector > 0)]

#lm

fascicle_lm_unique <- lapply(names_dep_map_3_09_excluding_na_cols, function(x) 
{
  lm(substitute(i ~ depGroupVar, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis, na.action=na.omit)
})
names(fascicle_lm_unique) <- names_dep_map_3_09_excluding_na_cols 

#anova
fascicle_anova_unique <- lapply(fascicle_lm_unique, anova)

#fdr corrected
fascicle_anova_unique_fdr <- fdr_anova_generic(fascicle_anova_unique, 1)
print(fascicle_anova_unique_fdr)#anova values < 0.05, uncorrected



#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_anova_unique[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network
#fascicle_anova_w_fiber_mapping <- fascicle_anova_unique[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
#fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
#print(fascicle_anova_fdr)

#fdr corrected only dep 10% mask
#fascicle_anova_w_fiber_mapping <- fascicle_anova_unique[which(fascicle_bundle_mapping$inDepNetwork_vector ==2)]
#fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
#print(fascicle_anova_fdr)

#fdr corrected only dep 5% mask
#fascicle_anova_w_fiber_mapping <- fascicle_anova_unique[which(fascicle_volumes_dep_network$prop_in_mask >= 0.05)]
#fascicle_anova_fdr<- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
#print(fascicle_anova_fdr)


#uncorrected
fascicle_anova_unique_p <- sapply(fascicle_anova_unique, function(v) v$"Pr(>F)"[1])
fascicle_anova_unique_p05_unc <- as.data.frame(fascicle_anova_unique_p[fascicle_anova_unique_p < 0.05 & !is.na(fascicle_anova_unique_p)])
#rownames(fascicle_anova_unique_p05_unc) <- names_dep_map_3_09_excluding_na_cols[which(fascicle_anova_unique_p < 0.05)]
print(fascicle_anova_unique_p05_unc)

### for 3_49

#### map the fiber bundles
fascicle_names_dep_network_grouping <- paste0(homedir,  "/templates/dti/HCP_YA1065_tractography/fascicle_names_dep_network_grouping.csv")

fascicle_bundle_mapping <- get_fascicle_bundle_mapping_generic_dep_mask(dep_network_grouping_file = fascicle_names_dep_network_grouping)

#0 is not in, 1 is between 0 and 10% mask, 2 is 10% mask, >0 is all
names_dep_map_3_49_excluding_na_cols <- names_dep_map_3_49[which(fascicle_bundle_mapping$inDepNetwork_vector > 0)]

#lm

fascicle_lm_unique <- lapply(names_dep_map_3_49_excluding_na_cols, function(x) 
{
  lm(substitute(i ~ depGroupVar, list(i = as.name(x))), data = dep_and_healthy_groups_for_ICD_analysis, na.action=na.omit)
})
names(fascicle_lm_unique) <- names_dep_map_3_49_excluding_na_cols 

#anova
fascicle_anova_unique <- lapply(fascicle_lm_unique, anova)

#fdr corrected
fascicle_anova_unique_fdr <- fdr_anova_generic(fascicle_anova_unique, 1)
print(fascicle_anova_unique_fdr)#anova values < 0.05, uncorrected



#fdr corrected only association cortex
fascicle_anova_w_fiber_mapping <- fascicle_anova_unique[which(fascicle_bundle_mapping$name_vector == "association")]
fascicle_anova_fdr_association <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
print(fascicle_anova_fdr_association)

#fdr corrected only dep network
#fascicle_anova_w_fiber_mapping <- fascicle_anova_unique[which(fascicle_bundle_mapping$inDepNetwork_vector >0)]
#fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
#print(fascicle_anova_fdr)

#fdr corrected only dep 10% mask
#fascicle_anova_w_fiber_mapping <- fascicle_anova_unique[which(fascicle_bundle_mapping$inDepNetwork_vector ==2)]
#fascicle_anova_fdr <- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
#print(fascicle_anova_fdr)

#fdr corrected only dep 5% mask
#fascicle_anova_w_fiber_mapping <- fascicle_anova_unique[which(fascicle_volumes_dep_network$prop_in_mask >= 0.05)]
#fascicle_anova_fdr<- fdr_anova_generic(fascicle_anova_w_fiber_mapping,1)
#print(fascicle_anova_fdr)


#uncorrected
fascicle_anova_unique_p <- sapply(fascicle_anova_unique, function(v) v$"Pr(>F)"[1])
fascicle_anova_unique_p05_unc <- as.data.frame(fascicle_anova_unique_p[fascicle_anova_unique_p < 0.05 & !is.na(fascicle_anova_unique_p)])
#rownames(fascicle_anova_unique_p05_unc) <- names_dep_map_3_49_excluding_na_cols[which(fascicle_anova_unique_p < 0.05)]
print(fascicle_anova_unique_p05_unc)


```

```{r comparing_depression_map_overlap_with_dx_diff_no_cranial_nerves}
# the purpose of this chunk is to plot the relationship of the degree of overlap of a depression network with the diagnostic difference between groups

##############################
## FASCICLES TO BE INCLUDED ##
##############################

#define the depression network (all areas that intersect with depression network, no cranial nerves)
fascicle_proportions <- read.csv(paste0(homedir, "/results/fascicle_volumes_all_subjects_roi_n2336.csv"), header = T, sep = ",") #n = 2336

#fascicle names are contained in all but the first 2 columns of the fascicle_proportions df
fascicle_names <- names(fascicle_proportions[3:dim(fascicle_proportions)[2]])
fascicle_names_no_cranial_nerves <- fascicle_names[grep("CN", fascicle_names, invert = TRUE)] #n=77

#######################
### depression map  ###
#######################

### define depression map
fascicle_volumes_dep <- read.csv(paste0(homedir, "results/streamline_volume_within_dep_network_3_09.csv"), header = T, sep = ",")

#filter to exclude fascicles w/cranial nerves
fascicle_volumes_dep_network_no_cranial_nerves <- fascicle_volumes_dep %>%
  replace(is.na(.), 0) %>%
  filter(fascicle%in% fascicle_names_no_cranial_nerves)

#make data frame that includes each fascicle in 1 column, and each proportion of overlap with depression network in second column

df_fascicle_and_prop_in_mask <- subset(x = fascicle_volumes_dep_network_no_cranial_nerves, select = c("fascicle", "prop_in_mask"))
df_fascicle_and_volume_in_mask <- subset(x = fascicle_volumes_dep_network_no_cranial_nerves, select = c("fascicle", "non_zero_voxels_in_dep_map"))

#######################
### real data x dx  ###
#######################

#then, make the data frame
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>% 
  filter(depGroupVar != 0)  %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()


# lapply to get results of t-test in each fascicle
#ldepGroup 2 is depressed group, Dep group 1 is healthy group. Positive Ts are places where depressed people have more disease than controls
fascicle_dep_vs_healthy_t <- lapply(fascicle_names_no_cranial_nerves, function(x) 
{
  t_test_command <- paste0("t.test(dep_and_healthy_groups_for_ICD_analysis$", x, "[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], dep_and_healthy_groups_for_ICD_analysis$", x, "[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], var.equal=F)")
  eval(parse(text=t_test_command))
})
names(fascicle_dep_vs_healthy_t) <- fascicle_names_no_cranial_nerves

#pull t-statistic
dep_vs_healthy_t_values <- sapply(fascicle_dep_vs_healthy_t, function(x) x$statistic)

#convert to data frame
df_t_values <- as.data.frame(dep_vs_healthy_t_values) 
row.names(df_t_values) <- fascicle_names_no_cranial_nerves
  
#pull p-values
dep_vs_healthy_p_values <- sapply(fascicle_dep_vs_healthy_t, function(x) x$p.value)

#convert to data frame
df_dep_vs_healthy_p_values <- as.data.frame(dep_vs_healthy_p_values)
row.names(df_dep_vs_healthy_p_values) <- fascicle_names_no_cranial_nerves

#FDR correct p-values
dep_vs_healthy_pfdr <- p.adjust(dep_vs_healthy_p_values,method="fdr")
  
#Convert to data frame
df_dep_vs_healthy_pfdr <- as.data.frame(dep_vs_healthy_pfdr)
row.names(df_dep_vs_healthy_pfdr) <- fascicle_names_no_cranial_nerves

#######################
### plot differences ##
#######################

#combine data frames, column 1 has names of fascicles, column 2 has proportion of overlap with depression network, column 3 has t-test value of dep vs healthy unc, 4th dep vs healthy fdr corrected within that fascicle

df_fascicle_dep_mask_overlap_t_value <- data.frame(df_fascicle_and_prop_in_mask$fascicle, df_fascicle_and_prop_in_mask$prop_in_mask, df_t_values$dep_vs_healthy_t_values, df_fascicle_and_volume_in_mask$non_zero_voxels_in_dep_map)
names(df_fascicle_dep_mask_overlap_t_value) <- c("fascicle", "depression_mask_overlap", "dep_vs_healthy_t", "volume_in_dep_mask")

df_fascicle_dep_mask_overlap_t_value_sorted_by_prop_overlap_depression_mask <- df_fascicle_dep_mask_overlap_t_value

df_fascicle_dep_mask_overlap_t_value_sorted_by_prop_overlap_depression_mask$fascicle  <- factor(df_fascicle_dep_mask_overlap_t_value_sorted_by_prop_overlap_depression_mask$fascicle, levels = df_fascicle_dep_mask_overlap_t_value_sorted_by_prop_overlap_depression_mask$fascicle[order(df_fascicle_dep_mask_overlap_t_value_sorted_by_prop_overlap_depression_mask$depression_mask_overlap)])


# bar graph of T-values of fascicles, sorted by depression overlap
plot_fascicle_by_t_sorted_by_dep_overlap <-ggplot(data = df_fascicle_dep_mask_overlap_t_value_sorted_by_prop_overlap_depression_mask, aes(x = fascicle, y=dep_vs_healthy_t), main = "Dep vs Healthy T value, Fascicles ordered by overlap with dep network") + 
  geom_bar(stat="identity") +
  ylim(0,5) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
print(plot_fascicle_by_t_sorted_by_dep_overlap)


# plot fascicle overlap x t value
#statistic, p = 0.010
dep_overlap_x_dep_vs_healthy_t <- lm(dep_vs_healthy_t ~ depression_mask_overlap, data=df_fascicle_dep_mask_overlap_t_value)
print(summary(dep_overlap_x_dep_vs_healthy_t))

scatter_t_val_by_dep_net_overlap <- ggplot(data=df_fascicle_dep_mask_overlap_t_value, aes(x=depression_mask_overlap, y=dep_vs_healthy_t)) +
  geom_point(size=1) + 
  geom_smooth(method=lm)+
  xlab("Proportion of Fascicle in Depression Network") + 
  ylab("Effect of diagnosis (T)") + 
  ggtitle("Fascicle/depression mask overlap by dx T, p = 0.010") + 
  theme(plot.title=element_text(hjust=0.5))
print(scatter_t_val_by_dep_net_overlap)


#statistic volume, p = 0.031
dep_overlap_x_dep_vs_healthy_t <- lm(dep_vs_healthy_t ~ volume_in_dep_mask, data=df_fascicle_dep_mask_overlap_t_value)
print(summary(dep_overlap_x_dep_vs_healthy_t))

scatter_t_val_by_dep_net_overlap <- ggplot(data=df_fascicle_dep_mask_overlap_t_value, aes(x=volume_in_dep_mask, y=dep_vs_healthy_t)) +
  geom_point(size=1) + 
  geom_smooth(method=lm)+
  xlab("Volume of Fascicle in Depression Network") + 
  ylab("Effect of diagnosis (T)") + 
  ggtitle("Fascicle/depression mask volume by dx T, p = 0.031") + 
  theme(plot.title=element_text(hjust=0.5))
print(scatter_t_val_by_dep_net_overlap)



#drop areas where there is no overlap with depression network, n = 62
df_removed_areas_with_no_depression_overlap <- df_fascicle_dep_mask_overlap_t_value %>% filter(depression_mask_overlap!=0)

#statistic, p = 0.040
df_removed_areas_with_no_depression_overlap_t <- lm(dep_vs_healthy_t ~ depression_mask_overlap, data=df_removed_areas_with_no_depression_overlap)
print(summary(df_removed_areas_with_no_depression_overlap_t))

scatter_t_val_by_dep_net_overlap_removed_areas_with_no_dep_overlap <- ggplot(data=df_removed_areas_with_no_depression_overlap, aes(x=depression_mask_overlap, y=dep_vs_healthy_t)) +
  geom_point(size=1) + 
  geom_smooth(method=lm)+
  xlab("Proportion of Fascicle in Depression Network (only areas that overlapped to some degree") + 
  ylab("Effect of diagnosis (T)") + 
  ggtitle("Fascicle/depression mask overlap by dx T, removed fascicles with no dep mask overlap, p = 0.040") + 
  theme(plot.title=element_text(hjust=0.5))
print(scatter_t_val_by_dep_net_overlap_removed_areas_with_no_dep_overlap)

### look at number of voxels, not just proportion


```
```{r depression_vs_healthy_overall_volume_of_fascicles_affected}

#goal of this segment is to look at overall lesion burden between depression and controls, outside of fascicles
#I'll read in the volume of each fascicle, and multiply it by the proportion of volume loss in each subject, thereby returing the volume of the fascicle affected

#read in fiber volume values
fiber_volume_values <- read.csv(paste0(homedir, "templates/dti/HCP_YA1065_tractography/fiber_volume_values.csv"), sep=",", header = T)

#extract data frame that only includes the fascicle proportion lost
df_fascicles_only <- df_demo_and_fascicles[ , (names(df_demo_and_fascicles) %in% fascicle_names)]
df_everything_else <- df_demo_and_fascicles[ , !(names(df_demo_and_fascicles) %in% fascicle_names)]

#multiply each row by the vector of total volumes
df_fascicle_volumes <- sweep(x = df_fascicles_only, MARGIN = 2,                        # Sweep with Complex STATS
                  STATS = fiber_volume_values$volume_full, FUN = "*")

#combine back with data_fram
df_demo_and_fascicle_volumes_full <- cbind(df_everything_else, df_fascicle_volumes)

#remove rows with cranial nerves
#fiber_volume_values_no_cranial_nerves <- fiber_volume_values %>% filter(fiber_volume_values$fascicle %in% fascicle_names_no_cranial_nerves)

#make dataframe and multiply values

#isolate out only the depressed group and healthy group, make a column that sums up the total prop lost)
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicle_volumes_full %>% 
  filter(depGroupVar != 0)  %>% 
  mutate(total_fascicle_vol_lost = rowMeans(across(fascicle_names_dep_network_all_no_cranial_nerves))) %>%
  mutate(total_fascicle_vol_lost_indepnet = rowMeans(across(fascicle_names_dep_network_all_no_cranial_nerves))) %>% 
  mutate(total_fascicle_vol_lost_nondep_network =
           rowMeans(across(nondep_network_names_no_cranial_nerves))) %>%
  mutate(total_fascicle_vol_lost_indepnet_top_quartile = 
           rowMeans(across(dep_network_names_top_quartile_no_cranial_nerves))) %>%
  mutate(total_fascicle_vol_lost_nondep_bottom_3_quartiles = 
           rowMeans(across(dep_network_bottom_3_quartiles_no_cranial_nerves))) %>%
  mutate(total_fascicle_vol_lost_nondep_bottom_quartile = 
           rowMeans(across(dep_network_names_bottom_quartile_no_cranial_nerves))) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()


dep_vs_healthy <- lm(total_fascicle_vol_lost ~ depGroupVar, data = dep_and_healthy_groups_for_ICD_analysis)
summary(dep_vs_healthy) #p=0.0456

dep_vs_healthy_top_quartile <- lm(total_fascicle_vol_lost_indepnet_top_quartile ~ depGroupVar, data = dep_and_healthy_groups_for_ICD_analysis)
summary(dep_vs_healthy_top_quartile) #p=0.0351

dep_vs_healthy_nondep_bottom_3_quartiles <- lm(total_fascicle_vol_lost_nondep_bottom_3_quartiles ~ depGroupVar, data = dep_and_healthy_groups_for_ICD_analysis)
summary(dep_vs_healthy_nondep_bottom_3_quartiles) #p=0.0535

#test whether volortion lost overall different between depressed and healthy- no, p = 0.054
total_volume_lost_dep_vs_healthy_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 33%, mean non_dep = 28%, p = 0.054


df_for_visreg <- as.data.frame(cbind(c(dep_and_healthy_groups_for_ICD_analysis$EMPI, dep_and_healthy_groups_for_ICD_analysis$EMPI), c(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]), c(rep(1,298), rep(2,298))))
names(df_for_visreg) <- c("EMPI", "vol_lost", "Diagnosis")
df_for_visreg$Diagnosis <- as.factor(df_for_visreg$Diagnosis)

plot <- ggplot(df_for_visreg, aes(x=Diagnosis, y = vol_lost, col=Diagnosis)) +
  geom_violin() + 
  geom_jitter(shape=16, position=position_jitter(0.05)) + 
  geom_boxplot(width=0.1) + theme_minimal() + 
  stat_summary(fun.y=median, geom="point", size=2, color="black") + 
  scale_x_discrete(labels=c("1" = "Depressed", "2" = "Non-Depressed"))

print(plot)

#bar plot
Diagnosis <- c("MS w/Depression", "MS No Depression")
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]),
           mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1]))

sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==2))),
           (sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==1))))

data <- data.frame(Diagnosis,value, sem)
#data$Fascicle <- pretty_names

# Grouped
barplot <- ggplot(data, aes(x=Diagnosis,fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", position=position_dodge(0.9)) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9)) + 
  ylab("volortion of Fascicles Affected") +
  theme(axis.text = element_text(size = 12, colour = "black"))
    
print(barplot)

# Grouped
barplot <- ggplot(data, aes(x=reorder(Diagnosis, -value),fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", colour="black", width=0.8, size=1.5) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9), size=1.5) +
  scale_fill_manual(values = c("#cdcdcd", "#FFFFFF")) + #comment out if you want colored graph
  ylab("volortion of Fascicles Affected") +
  ggtitle("Total vol Affected by dx") + 
  theme(axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
        axis.title.y = element_text(size=20),
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        plot.title = element_text(hjust=0.5, size = 14), 
        panel.background = element_rect(colour = "white", fill = "white"))# + #comment out if you want pretty 
  #scale_y_continuous(expand = c(0, 0), limits = c(0, 0.52)) #comment out if you want colored graph

print(barplot)



#look at within depression network using top quartiles, yes p = 0.047
total_volume_lost_dep_vs_healthy_unique_in_dep_network_top_quartile <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 32%, mean non_dep = 26%, p = 0.047


#look at outside depression network (i.e. areas that never overalpped dep network), yes p = 0.049
total_volume_lost_dep_vs_healthy_unique_in_nondep_network <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_nondep_network[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_nondep_network[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 23%, mean non_dep = 20%, p = 0.049

#look at 75%, no p = 0.057
total_volume_lost_dep_vs_healthy_unique_in_bottom_3_quartiles <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_nondep_bottom_3_quartiles[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_nondep_bottom_3_quartiles[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 30%, mean non_dep = 27%, p = 0.057

#look at bottom quartile

total_volume_lost_dep_vs_healthy_unique_in_bottom_quartile <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_nondep_bottom_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_nondep_bottom_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 18%, mean non_dep = 16%, p = 0.13

############
#bar plot
############

Diagnosis <- c("MS w/Depression", "MS No Depression")
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]),
           mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1]))

sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==2))),
           (sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==1))))

data <- data.frame(Diagnosis,value, sem)
#data$Fascicle <- pretty_names

# Grouped
barplot <- ggplot(data, aes(x=Diagnosis,fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", position=position_dodge(0.9)) + 
  geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9)) + 
  ggtitle("Mean vol Fasc Affected w/in 25% dep mask by dx") +
  ylab("volortion of Fascicles Affected") +
  theme(title = element_text(size=14),
    axis.text = element_text(size = 12, colour = "black"))
    
print(barplot)

# Grouped
barplot <- ggplot(data, aes(x=reorder(Diagnosis, -value),fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", colour="black", width=0.8, size=1.5) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9), size=1.5) +
  scale_fill_manual(values = c("#cdcdcd", "#FFFFFF")) + #comment out if you want colored graph
  ggtitle("Mean vol Fasc Affected w/in 25% dep mask by dx") +
  ylab("Volume of Fascicles Affected") +
  theme(title = element_text(size=14),
        axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
        axis.title.y = element_text(size=20),
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        panel.background = element_rect(colour = "white", fill = "white"))# + #comment out if you want pretty 
#  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.52)) #comment out if you want colored graph

print(barplot)
#test dep vs healthy across all volume


```

```{r depression_vs_healthy_overall_volume_of_fascicles_affected_sums}

#goal of this segment is to look at overall lesion burden between depression and controls, outside of fascicles
#I'll read in the volume of each fascicle, and multiply it by the proportion of volume loss in each subject, thereby returing the volume of the fascicle affected

#read in fiber volume values
fiber_volume_values <- read.csv(paste0(homedir, "templates/dti/HCP_YA1065_tractography/fiber_volume_values.csv"), sep=",", header = T)

#extract data frame that only includes the fascicle proportion lost
df_fascicles_only <- df_demo_and_fascicles[ , (names(df_demo_and_fascicles) %in% fascicle_names)]
df_everything_else <- df_demo_and_fascicles[ , !(names(df_demo_and_fascicles) %in% fascicle_names)]

#multiply each row by the vector of total volumes
df_fascicle_volumes <- sweep(x = df_fascicles_only, MARGIN = 2,                        # Sweep with Complex STATS
                  STATS = fiber_volume_values$volume_full, FUN = "*")

#combine back with data_fram
df_demo_and_fascicle_volumes_full <- cbind(df_everything_else, df_fascicle_volumes)

#remove rows with cranial nerves
#fiber_volume_values_no_cranial_nerves <- fiber_volume_values %>% filter(fiber_volume_values$fascicle %in% fascicle_names_no_cranial_nerves)

#make dataframe and multiply values

#isolate out only the depressed group and healthy group, make a column that sums up the total prop lost)
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicle_volumes_full %>% 
  filter(depGroupVar != 0)  %>% 
  mutate(total_fascicle_vol_lost = rowSums(across(fascicle_names_dep_network_all_no_cranial_nerves))) %>%
  mutate(total_fascicle_vol_lost_indepnet = rowSums(across(fascicle_names_dep_network_all_no_cranial_nerves))) %>% 
  mutate(total_fascicle_vol_lost_nondep_network =
           rowSums(across(nondep_network_names_no_cranial_nerves))) %>%
  mutate(total_fascicle_vol_lost_indepnet_top_quartile = 
           rowSums(across(dep_network_names_top_quartile_no_cranial_nerves))) %>%
  mutate(total_fascicle_vol_lost_nondep_bottom_3_quartiles = 
           rowSums(across(dep_network_bottom_3_quartiles_no_cranial_nerves))) %>%
  mutate(total_fascicle_vol_lost_nondep_bottom_quartile = 
           rowSums(across(dep_network_names_bottom_quartile_no_cranial_nerves))) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()


dep_vs_healthy <- lm(total_fascicle_vol_lost ~ depGroupVar, data = dep_and_healthy_groups_for_ICD_analysis)
summary(dep_vs_healthy) #p=0.0456

dep_vs_healthy_top_quartile <- lm(total_fascicle_vol_lost_indepnet_top_quartile ~ depGroupVar, data = dep_and_healthy_groups_for_ICD_analysis)
summary(dep_vs_healthy_top_quartile) #p=0.0351

dep_vs_healthy_nondep_bottom_3_quartiles <- lm(total_fascicle_vol_lost_nondep_bottom_3_quartiles ~ depGroupVar, data = dep_and_healthy_groups_for_ICD_analysis)
summary(dep_vs_healthy_nondep_bottom_3_quartiles) #p=0.0535

#test whether vol lost overall different between depressed and healthy- no, p = 0.045
total_volume_lost_dep_vs_healthy_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #Sum dep = 33%, Sum non_dep = 28%, p = 0.045

#look at within depression network using top quartiles, yes p = 0.034
total_volume_lost_dep_vs_healthy_unique_in_dep_network_top_quartile <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #sum dep = 32%, sum non_dep = 26%, p = 0.047


#look at outside depression network (i.e. areas that never overalpped dep network), yes p = 0.048
total_volume_lost_dep_vs_healthy_unique_in_nondep_network <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_nondep_network[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_nondep_network[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #sum dep = 23%, sum non_dep = 20%, p = 0.049

#look at 75%, no p = 0.054
total_volume_lost_dep_vs_healthy_unique_in_bottom_3_quartiles <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_nondep_bottom_3_quartiles[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_nondep_bottom_3_quartiles[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #sum dep = 30%, sum non_dep = 27%, p = 0.057

#look at bottom quartile, p = 0.14

total_volume_lost_dep_vs_healthy_unique_in_bottom_quartile <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_nondep_bottom_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_nondep_bottom_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #sum dep = 18%, sum non_dep = 16%, p = 0.13


df_for_visreg <- as.data.frame(cbind(c(dep_and_healthy_groups_for_ICD_analysis$EMPI, dep_and_healthy_groups_for_ICD_analysis$EMPI), c(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]), c(rep(1,298), rep(2,298))))
names(df_for_visreg) <- c("EMPI", "vol_lost", "Diagnosis")
df_for_visreg$Diagnosis <- as.factor(df_for_visreg$Diagnosis)

plot <- ggplot(df_for_visreg, aes(x=Diagnosis, y = vol_lost, col=Diagnosis)) +
  geom_violin() + 
  geom_jitter(shape=16, position=position_jitter(0.05)) + 
  geom_boxplot(width=0.1) + theme_minimal() + 
  stat_summary(fun.y=median, geom="point", size=2, color="black") + 
  scale_x_discrete(labels=c("1" = "Depressed", "2" = "Non-Depressed"))

print(plot)

#bar plot
Diagnosis <- c("MS w/Depression", "MS No Depression")
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]),
           mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1]))

sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==2))),
           (sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==1))))

data <- data.frame(Diagnosis,value, sem)
#data$Fascicle <- pretty_names

# Grouped
barplot <- ggplot(data, aes(x=Diagnosis,fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", position=position_dodge(0.9)) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9)) + 
  ylab("volortion of Fascicles Affected") +
  theme(axis.text = element_text(size = 12, colour = "black"))
    
print(barplot)

# Grouped
barplot <- ggplot(data, aes(x=reorder(Diagnosis, -value),fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", colour="black", width=0.8, size=1.5) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9), size=1.5) +
  scale_fill_manual(values = c("#cdcdcd", "#FFFFFF")) + #comment out if you want colored graph
  ylab("volortion of Fascicles Affected") +
  ggtitle("Total vol Affected by dx") + 
  theme(axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
        axis.title.y = element_text(size=20),
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        plot.title = element_text(hjust=0.5, size = 14), 
        panel.background = element_rect(colour = "white", fill = "white"))# + #comment out if you want pretty 
  #scale_y_continuous(expand = c(0, 0), limits = c(0, 0.52)) #comment out if you want colored graph

print(barplot)




############
#bar plot
############

Diagnosis <- c("MS w/Depression", "MS No Depression")
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]),
           mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1]))

sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==2))),
           (sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==1))))

data <- data.frame(Diagnosis,value, sem)
#data$Fascicle <- pretty_names

# Grouped
barplot <- ggplot(data, aes(x=Diagnosis,fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", position=position_dodge(0.9)) + 
  geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9)) + 
  ggtitle("sum vol Fasc Affected w/in 25% dep mask by dx") +
  ylab("volortion of Fascicles Affected") +
  theme(title = element_text(size=14),
    axis.text = element_text(size = 12, colour = "black"))
    
print(barplot)

# Grouped
barplot <- ggplot(data, aes(x=reorder(Diagnosis, -value),fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", colour="black", width=0.8, size=1.5) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9), size=1.5) +
  scale_fill_manual(values = c("#cdcdcd", "#FFFFFF")) + #comment out if you want colored graph
  ggtitle("sum vol Fasc Affected w/in 25% dep mask by dx") +
  ylab("Volume of Fascicles Affected") +
  theme(title = element_text(size=14),
        axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
        axis.title.y = element_text(size=20),
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        panel.background = element_rect(colour = "white", fill = "white"))# + #comment out if you want pretty 
#  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.52)) #comment out if you want colored graph

print(barplot)
#test dep vs healthy across all volume

################

################
#######################
### depression map  ###
#######################

### define depression map
fascicle_volumes_dep <- read.csv(paste0(homedir, "results/streamline_volume_within_dep_network_3_09.csv"), header = T, sep = ",")

#filter to exclude fascicles w/cranial nerves
fascicle_volumes_dep_network_no_cranial_nerves <- fascicle_volumes_dep %>%
  replace(is.na(.), 0) %>%
  filter(fascicle%in% fascicle_names_no_cranial_nerves)

#make data frame that includes each fascicle in 1 column, and each proportion of overlap with depression network in second column

df_fascicle_and_prop_in_mask <- subset(x = fascicle_volumes_dep_network_no_cranial_nerves, select = c("fascicle", "prop_in_mask"))
df_fascicle_and_volume_in_mask <- subset(x = fascicle_volumes_dep_network_no_cranial_nerves, select = c("fascicle", "non_zero_voxels_in_dep_map"))

#######################
### real data x dx  ###
#######################




# lapply to get results of t-test in each fascicle
#ldepGroup 2 is depressed group, Dep group 1 is healthy group. Positive Ts are places where depressed people have more disease than controls
fascicle_dep_vs_healthy_t <- lapply(fascicle_names_no_cranial_nerves, function(x) 
{
  t_test_command <- paste0("t.test(dep_and_healthy_groups_for_ICD_analysis$", x, "[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], dep_and_healthy_groups_for_ICD_analysis$", x, "[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], var.equal=F)")
  eval(parse(text=t_test_command))
})
names(fascicle_dep_vs_healthy_t) <- fascicle_names_no_cranial_nerves

#pull t-statistic
dep_vs_healthy_t_values <- sapply(fascicle_dep_vs_healthy_t, function(x) x$statistic)

#convert to data frame
df_t_values <- as.data.frame(dep_vs_healthy_t_values) 
row.names(df_t_values) <- fascicle_names_no_cranial_nerves
  
#pull p-values
dep_vs_healthy_p_values <- sapply(fascicle_dep_vs_healthy_t, function(x) x$p.value)

#convert to data frame
df_dep_vs_healthy_p_values <- as.data.frame(dep_vs_healthy_p_values)
row.names(df_dep_vs_healthy_p_values) <- fascicle_names_no_cranial_nerves

#FDR correct p-values
dep_vs_healthy_pfdr <- p.adjust(dep_vs_healthy_p_values,method="fdr")
  
#Convert to data frame
df_dep_vs_healthy_pfdr <- as.data.frame(dep_vs_healthy_pfdr)
row.names(df_dep_vs_healthy_pfdr) <- fascicle_names_no_cranial_nerves

#######################
### plot differences ##
#######################

#combine data frames, column 1 has names of fascicles, column 2 has proportion of overlap with depression network, column 3 has t-test value of dep vs healthy unc, 4th dep vs healthy fdr corrected within that fascicle

df_fascicle_dep_mask_overlap_t_value <- data.frame(df_fascicle_and_prop_in_mask$fascicle, df_fascicle_and_prop_in_mask$prop_in_mask, df_t_values$dep_vs_healthy_t_values, df_fascicle_and_volume_in_mask$non_zero_voxels_in_dep_map)
names(df_fascicle_dep_mask_overlap_t_value) <- c("fascicle", "depression_mask_overlap", "dep_vs_healthy_t", "volume_in_dep_mask")

df_fascicle_dep_mask_overlap_t_value_sorted_by_prop_overlap_depression_mask <- df_fascicle_dep_mask_overlap_t_value

df_fascicle_dep_mask_overlap_t_value_sorted_by_prop_overlap_depression_mask$fascicle  <- factor(df_fascicle_dep_mask_overlap_t_value_sorted_by_prop_overlap_depression_mask$fascicle, levels = df_fascicle_dep_mask_overlap_t_value_sorted_by_prop_overlap_depression_mask$fascicle[order(df_fascicle_dep_mask_overlap_t_value_sorted_by_prop_overlap_depression_mask$depression_mask_overlap)])


# bar graph of T-values of fascicles, sorted by depression overlap
plot_fascicle_by_t_sorted_by_dep_overlap <-ggplot(data = df_fascicle_dep_mask_overlap_t_value_sorted_by_prop_overlap_depression_mask, aes(x = fascicle, y=dep_vs_healthy_t), main = "Dep vs Healthy T value, Fascicles ordered by overlap with dep network") + 
  geom_bar(stat="identity") +
  ylim(0,5) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
print(plot_fascicle_by_t_sorted_by_dep_overlap)


# plot fascicle overlap x t value
#statistic, p = 0.01
dep_overlap_x_dep_vs_healthy_t <- lm(dep_vs_healthy_t ~ depression_mask_overlap, data=df_fascicle_dep_mask_overlap_t_value)
print(summary(dep_overlap_x_dep_vs_healthy_t))

scatter_t_val_by_dep_net_overlap <- ggplot(data=df_fascicle_dep_mask_overlap_t_value, aes(x=depression_mask_overlap, y=dep_vs_healthy_t)) +
  geom_point(size=1) + 
  geom_smooth(method=lm)+
  xlab("Proportion of Fascicle in Depression Network") + 
  ylab("Effect of diagnosis (T)") + 
  ggtitle("Fascicle/depression mask overlap by dx T, p = 0.01") + 
  theme(plot.title=element_text(hjust=0.5))
print(scatter_t_val_by_dep_net_overlap)


#statistic volume, p = 0.031
dep_overlap_x_dep_vs_healthy_t <- lm(dep_vs_healthy_t ~ volume_in_dep_mask, data=df_fascicle_dep_mask_overlap_t_value)
print(summary(dep_overlap_x_dep_vs_healthy_t))

scatter_t_val_by_dep_net_overlap <- ggplot(data=df_fascicle_dep_mask_overlap_t_value, aes(x=volume_in_dep_mask, y=dep_vs_healthy_t)) +
  geom_point(size=1) + 
  geom_smooth(method=lm)+
  xlab("Volume of Fascicle in Depression Network") + 
  ylab("Effect of diagnosis (T)") + 
  ggtitle("Fascicle/depression mask volume by dx T, p = 0.031") + 
  theme(plot.title=element_text(hjust=0.5))
print(scatter_t_val_by_dep_net_overlap)



#drop areas where there is no overlap with depression network, n = 62
df_removed_areas_with_no_depression_overlap <- df_fascicle_dep_mask_overlap_t_value %>% filter(depression_mask_overlap!=0)

#statistic, p = 0.040
df_removed_areas_with_no_depression_overlap_t <- lm(dep_vs_healthy_t ~ depression_mask_overlap, data=df_removed_areas_with_no_depression_overlap)
print(summary(df_removed_areas_with_no_depression_overlap_t))

scatter_t_val_by_dep_net_overlap_removed_areas_with_no_dep_overlap <- ggplot(data=df_removed_areas_with_no_depression_overlap, aes(x=depression_mask_overlap, y=dep_vs_healthy_t)) +
  geom_point(size=1) + 
  geom_smooth(method=lm)+
  xlab("Proportion of Fascicle in Depression Network (only areas that overlapped to some degree") + 
  ylab("Effect of diagnosis (T)") + 
  ggtitle("Fascicle/depression mask overlap by dx T, removed fascicles with no dep mask overlap, p = 0.040") + 
  theme(plot.title=element_text(hjust=0.5))
print(scatter_t_val_by_dep_net_overlap_removed_areas_with_no_dep_overlap)

### look at number of voxels, not just proportion


```

```{r compare_overall_volume_of_lesions_dep_vs_non_dep}

lesion_volumes <- read.csv(paste0(homedir, "results/mimosa_binary_masks_hcp_space_20211026_n2336_volumes"), sep = ",", header = TRUE)

#merge with full dataset
df_full_dataset_plus_lesion_volumes = merge(df_demo_and_fascicles, lesion_volumes, by = c("EMPI", "EXAM_DATE"))

#separate out only people in depression group, and take first instance
dep_and_healthy_groups_for_ICD_analysis <- df_full_dataset_plus_lesion_volumes %>% 
  filter(depGroupVar != 0)  %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()

dep_vs_healthy_volume <- lm(volume_of_mimosa_lesions ~ depGroupVar, data = dep_and_healthy_groups_for_ICD_analysis)
summary(dep_vs_healthy) #p=0.08

dep_vs_healthy_t_test_lesion_volume <-  t.test(dep_and_healthy_groups_for_ICD_analysis$volume_of_mimosa_lesions[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$volume_of_mimosa_lesions[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #p=0.07

Diagnosis <- c("MS w/Depression", "MS No Depression")
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$volume_of_mimosa_lesions[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]),
           mean(dep_and_healthy_groups_for_ICD_analysis$volume_of_mimosa_lesions[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1]))

sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$volume_of_mimosa_lesions[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==2))),
           (sd(dep_and_healthy_groups_for_ICD_analysis$volume_of_mimosa_lesions[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==1))))

data <- data.frame(Diagnosis,value, sem)
#data$Fascicle <- pretty_names

# Grouped
barplot <- ggplot(data, aes(x=Diagnosis,fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", position=position_dodge(0.9)) + 
  geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9)) + 
  ggtitle("Volume of Mimosa Lesions by Diagnosis") +
  ylab("Volume of Lesions") +
  theme(title = element_text(size=14),
    axis.text = element_text(size = 12, colour = "black"))
    
print(barplot)

# Grouped
barplot <- ggplot(data, aes(x=reorder(Diagnosis, -value),fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", colour="black", width=0.8, size=1.5) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9), size=1.5) +
  scale_fill_manual(values = c("#cdcdcd", "#FFFFFF")) + #comment out if you want colored graph
  ggtitle("Volume of Mimosa Lesions by Diagnosis") +
  ylab("Volume of Lesion") +
  theme(title = element_text(size=14),
        axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
        axis.title.y = element_text(size=20),
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        panel.background = element_rect(colour = "white", fill = "white"))# + #comment out if you want pretty 
#  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.52)) #comment out if you want colored graph
print(barplot)

```

