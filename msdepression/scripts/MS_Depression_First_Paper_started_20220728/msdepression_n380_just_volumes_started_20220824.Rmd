---
title: "MS Depression Paper, started 2022 08 24"
author: "Erica Baller"
date: '2022-08-24'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(visreg)
library(lme4)
library(lmerTest)
library(ggplot2)
library(reshape2)
library(pwr)
library(mgcv)
library(boot)
library(boot.pval)
library(lsr)
library(sjPlot)
#functions
source("~/BBL/msdepression/scripts/msdepression_functions.R")
```

Read in Data and do some preprocessing

```{r read_in_df_and_subset}
homedir <- "/Users/eballer/BBL/msdepression/"

data <- read.csv(paste0(homedir, "/data/drugs_data/parsable_msdepression.csv"), sep = ",", header = TRUE) #n=16830, only has people with MS ICD10 code G35 and seen by MS provider

columns_to_make_integer <- c("ACCESSION_NUM", "PAT_AGE_AT_EXAM","MRI_ENC_AGE","CURRENT_AGE","hemoglobin", "WBC","RBC","B12","FOLATE", "TSH", "RPR","CSFAPPEAR1","CSFAPPEAR4","CSFCOLOR1",       "CSFCOLOR4","CSFTUBE","CSFTUBE4","VitD","PHQ.2","PHQ.9")

##########################
### some preprocessing ###
##########################
#we need to keep scans from people seen by an MS provider (n = 17067) who have an MS diagnostic code (n=16,830)
#we make a bunch of columns from character to integer, binarize sex and race, and put date into a nice format YYYYMMDD, the %m%d%y indicates what it started out as

#goal is to keep people who were seen by 
 data_empi_acc_f_phq <- data %>% 
   mutate(across(.cols = columns_to_make_integer, .fns = as.integer)) %>%
   mutate(sex_binarized = ifelse(SEX == "MALE", 1, 2)) %>%
   mutate(osex = ordered(sex_binarized,levels = c(1,2), labels = c("Male","Female"))) %>%
   mutate(race_binarized = ifelse(RACE == "WHITE", 1, 2)) %>%
   mutate(orace = ordered(race_binarized,levels = c(1,2), labels = c("White","Non-white"))) %>%
   mutate(EXAM_DATE = as.Date(BEGIN_EXAM_DTTM, format = "%m/%d/%y")) %>% 
   mutate(EXAM_DATE = gsub(EXAM_DATE, pattern = "-", replacement = "")) %>%
   mutate(BEGIN_EXAM_DTTM = as.Date(BEGIN_EXAM_DTTM, format = "%m/%d/%y")) %>% #make sure to actually save it as date object for later processing
   mutate(EMPI = as.factor(EMPI)) %>%
   mutate(On.Psych.Meds = ifelse(On.Psych.Meds == "True", 1, 0)) %>%
   mutate(On.Antidepressants = ifelse(On.Antidepressants == "True", 1, 0)) %>%
   mutate(Has.PHQ2 = ifelse(Has.PHQ2 == "True", 1, 0)) %>%
   mutate(Has.PHQ9 = ifelse(Has.PHQ9 == "True", 1, 0)) %>%
   mutate(Has.depdx = ifelse(grepl("F3", ICD10), 1, 0)) %>%
   mutate(PHQ.2_modsev_dep_sxs = ifelse((!is.na(PHQ.2) & PHQ.2 >= 3), 1, 0)) %>%
   mutate(PHQ.9_modsev_dep_sxs = ifelse((!is.na(PHQ.9) & PHQ.9 >= 10), 1, 0)) %>%
   mutate(PHQ.2_mild_dep_sxs = ifelse((!is.na(PHQ.2) & PHQ.2 > 0 & PHQ.2 < 3), 1, 0)) %>%
   mutate(PHQ.9_mild_dep_sxs = ifelse((!is.na(PHQ.9) & PHQ.9 > 0 & PHQ.9 < 10), 1, 0)) %>%
   mutate(PHQ.2_zero = ifelse((!is.na(PHQ.2) & PHQ.2 == 0), 1, 0)) %>%
   mutate(PHQ.9_zero = ifelse((!is.na(PHQ.9) & PHQ.9 == 0), 1, 0)) %>%
   mutate(dep_by_dx_phq = ifelse((Has.depdx | PHQ.2_modsev_dep_sxs | PHQ.9_modsev_dep_sxs),1,0)) %>%
   mutate(dep_by_dx_phq_antidep = ifelse((Has.depdx | On.Antidepressants | PHQ.2_modsev_dep_sxs | PHQ.9_modsev_dep_sxs),1,0)) %>%
   mutate(true_healthy = ifelse((!Has.depdx & !On.Psych.Meds & (PHQ.2_zero | PHQ.9_zero)), 1, 0)) %>%
   mutate(dep_by_dx_phq_meds_healthy_phq0_no_psych_meds = ifelse(dep_by_dx_phq_antidep | true_healthy, 1, 0)) %>%
   rowwise(ACCESSION_NUM) %>%
   mutate(depGroupVar =
            sum(c(dep_by_dx_phq_meds_healthy_phq0_no_psych_meds,dep_by_dx_phq_antidep))) %>%#you get an extra point if you are in the depression group, so the end result is dep = 2, healthy = 1, 0 for exclude
   ungroup()


##########################################################
#             Read in Fascicle info             #
##########################################################

fascicle_proportions <- read.csv(paste0(homedir, "/results/fascicle_volumes_all_subjects_roi_n2336.csv"), header = T, sep = ",") #n = 2336

#fascicle names are contained in all but the first 2 columns of the fascicle_proportions df
fascicle_names <- names(fascicle_proportions[3:dim(fascicle_proportions)[2]])
fascicle_names_no_cranial_nerves <- fascicle_names[grep("CN", fascicle_names, invert = TRUE)] #n=77, drop cranial nerves

#write.table(fascicle_names,"/Users/eballer/BBL/msdepression/templates/dti/HCP_YA1065_tractography/fascicle_names.csv", row.names = F, quote = F, col.names = F)

#add suffix to each measure
fascicle_names_w_prop_suffix <- gsub(pattern = "(.*)", replacement = "\\1_prop", perl=TRUE, x = fascicle_names_no_cranial_nerves)
fascicle_names_w_vol_suffix <- gsub(pattern = "(.*)", replacement = "\\1_vol", perl=TRUE, x = fascicle_names_no_cranial_nerves)


########
#fascicle volumes in depression network
########

fascicle_volumes_dep <- read.csv(paste0(homedir, "results/streamline_volume_within_dep_network_3_09.csv"), header = T, sep = ",")

#add column to indicate whether does not meet criteria for inclusion in dep mask (0), any overlapping voxels (1), or >10% overlapping voxels (2)
#fascicle_volumes_dep_network <- fascicle_volumes_dep %>%
 # replace(is.na(.), 0) %>%
#  mutate(inDepMask=case_when(prop_in_mask == 0 ~ 0, (prop_in_mask > 0 & prop_in_mask < 0.1) ~ 1, prop_in_mask >= 0.1 ~ 2))



#Write out the new network groupings to a file, will be used later
#fascicle_names_dep_network_grouping <- paste0(homedir,  "/templates/dti/HCP_YA1065_tractography/fascicle_names_dep_network_grouping_3_09.csv")
#write.table(fascicle_volumes_dep_network, file=fascicle_names_dep_network_grouping, sep = ",", col.names=T)#, row.names = F, quote = F, col.names = T)

#fascicle_mapping, returns numerical mapping as well as names of tracts, and whether any overlap with depression network (anything above 1 is overlap), as well as whether the fascicle overlaps, and the proportion of overlap with yeo networks
#fascicle_bundle_mapping <- get_fascicle_bundle_mapping_generic_dep_mask(dep_network_grouping_file = fascicle_names_dep_network_grouping)

##########################################################
#             Read in Lesion Volumes                     #
##########################################################

# contains the volume of lesioned voxels, i.e. a sum of all the areas of each individual's binary mask that are 1

lesion_volumes <- read.csv(paste0(homedir, "results/mimosa_binary_masks_hcp_space_20211026_n2336_volumes"), sep = ",", header = TRUE)

##########################################################
#             Merge with data_empi              #
##########################################################
#merge whole data set with fascicle proportions
df_demo_and_fascicles <- merge(data_empi_acc_f_phq, fascicle_proportions, by = c("EMPI", "EXAM_DATE")) #n = 2962

#merge with the df that has lesion volumes, 1 per perosn
df_demo_and_fascicles <- merge(df_demo_and_fascicles, lesion_volumes, by = c("EMPI", "EXAM_DATE")) #n = 2962

##########################################################
#  Add columns for volume and change proportion names    #
##########################################################

#read in fiber volume values
fiber_volume_values <- read.csv(paste0(homedir, "templates/dti/HCP_YA1065_tractography/fiber_volume_values.csv"), sep=",", header = T)

#extract data frame that only includes the fascicle proportion lost
df_fascicles_prop <- df_demo_and_fascicles[ , (names(df_demo_and_fascicles) %in% fascicle_names_no_cranial_nerves)]
df_everything_else <- df_demo_and_fascicles[ , !(names(df_demo_and_fascicles) %in% fascicle_names_no_cranial_nerves)]

#multiply each row by the vector of total volumes to extract volume of disease within fascicle
df_fascicles_volumes <- sweep(x = df_fascicles_prop, MARGIN = 2,                        # Sweep with Complex STATS
                  STATS = fiber_volume_values$volume_full, FUN = "*")

# change name of df_fascicle_volumes to have the suffix, and add a suffix for the proportion measures
names(df_fascicles_prop) <- fascicle_names_w_prop_suffix
names(df_fascicles_volumes) <- fascicle_names_w_vol_suffix


#combine back with data_fram
#df_demo_and_fascicle_volumes_full <- cbind(df_everything_else, df_fascicle_volumes)
df_demo_and_fascicles_prop_and_vol <- cbind(df_everything_else, df_fascicles_prop, df_fascicles_volumes )


```
PROMIS DATA HANDLING to link a person to their most proximal promis

```{r promis_data_handling}
##########################################################
#            Read in PROMIS Data              #
##########################################################
promis_data <- readRDS(paste0(homedir, "/data/dac/promis_data_cleaned_n1694_unique_indiv_n501_2015-2022.rds"))
promis_score_names <- names(promis_data[7:16]) 

df_people_with_promis_data <- df_demo_and_fascicles_prop_and_vol %>%
  filter(EMPI %in% promis_data$EMPI) #n=398

unique_empis_in_promis_group <- unique(df_people_with_promis_data$EMPI) #n=116

#go through each person w/promis data and append the columns to their row that reflects the closest collected PROMIS

#function, take an empi and date, returns a column of promis scores
get_closest_promis_to_ms_exam_date <- function(subj_empi, subj_exam_date) {
  df_closest_promis <- promis_data %>%
    filter(EMPI == subj_empi) %>%
    mutate(distance_from_scan = abs(RECORDED_TIME-subj_exam_date)) %>%
    filter(abs(RECORDED_TIME-subj_exam_date)==min(abs(RECORDED_TIME-subj_exam_date))) %>%
    slice(1)
  return(df_closest_promis)
}

#make dataframe to store promis info
promis_info_closest_proximity <- data.frame(matrix(NA, nrow=dim(df_people_with_promis_data)[1], ncol=(dim(promis_data)[2] + 1)))
names(promis_info_closest_proximity) <- c(names(promis_data), "distance_from_scan")

for (line in 1:dim(df_people_with_promis_data)[1]) {
  #pull out subject empi and exam date
  print(line)
  subj_empi <- df_people_with_promis_data$EMPI[line]
  subj_exam_date <- df_people_with_promis_data$BEGIN_EXAM_DTTM[line]
  closest_promis_data <- get_closest_promis_to_ms_exam_date(subj_empi = subj_empi, subj_exam_date = subj_exam_date)
  promis_info_closest_proximity[line,] = closest_promis_data
}

#drop unnecessary columns c("DE_PAT_ID", "EMPI", "HUP_MRN", "SEX", "RACE")
promis_info_closest_proximity_just_scores <- promis_info_closest_proximity[,6:dim(promis_info_closest_proximity)[2]]

#combine with df_people_with_promis_data
df_people_with_promis_data_scores_added = cbind(df_people_with_promis_data, promis_info_closest_proximity_just_scores)

#summarize the distance from scans
summary(df_people_with_promis_data_scores_added$distance_from_scan/364) #mean 2.40 ys, median 2.10 years, range 0.003 y to 6.83 years
hist(df_people_with_promis_data_scores_added$distance_from_scan/364, 
     main = "Hisogram of years between Promis and Scan",
     xlab = "Years from Scan") #convert to years



```

Demographics
```{r demographics}

#this will display a demographics table comparing age, race, sex between healthy and depressed groups, using the first presentation to treatment

df_good_mimosa_unique_dep_and_healthy <- df_demo_and_fascicles %>% 
  filter(depGroupVar != 0) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup() 
make_demographics_table_ms(data_frame = df_good_mimosa_unique_dep_and_healthy)

#just good mimosa w/promis
df_people_with_promis_data_scores_added_unique <- df_people_with_promis_data_scores_added %>%
  filter(depGroupVar != 0) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup() 
make_demographics_table_ms_w_promis(data_frame = df_people_with_promis_data_scores_added_unique)

```
Compare overall volume of the lesions, irrespective of fascicle involvement, between diagnostic groups

```{r compare_overall_volume_of_lesions_dep_vs_non_dep}

#separate out only people in depression group, and take first instance
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles_prop_and_vol %>% 
  filter(depGroupVar != 0)  %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()

dep_vs_healthy_t_test_lesion_volume <-  t.test(dep_and_healthy_groups_for_ICD_analysis$volume_of_mimosa_lesions[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$volume_of_mimosa_lesions[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #p=0.07

#extract overall volume and diagnosis
df_lesion_volume_and_diagnosis <- dep_and_healthy_groups_for_ICD_analysis %>% 
  dplyr::select(volume_of_mimosa_lesions,depGroupVar) %>%
  filter(depGroupVar != 0) %>% 
  mutate(depGroupVar = ifelse(depGroupVar == 1, "Non-depressed", "Depressed"))

violin_lesion_volume <- ggplot(df_lesion_volume_and_diagnosis, aes(x=depGroupVar, y=volume_of_mimosa_lesions, fill=depGroupVar)) +#, fill=depGroupVar)) + 
  geom_violin() + 
  geom_boxplot(width=0.1, color="black", fill="white", outlier.size = 0.2) + #theme_minimal(color="black") + 
  scale_x_discrete(labels=c("1" = "Depressed", "2" = "Non-Depressed")) + 
  ggtitle(paste0("Volume of Lesions by Diagnosis")) +
  ylab("Volume of Lesions") +
  theme(plot.title = element_text(size=16, hjust = 0.8),
        axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
        axis.title.y = element_text(size=16),
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        legend.position = "none",
        aspect.ratio=7/5,
        panel.background = element_rect(colour = "white", fill = "white"))# + #comment out if you want pretty 
print(violin_lesion_volume) #p=0.067

```
Define Depression Network by Volume of Overlap
```{r visualize_depression_network_volume}
##########################################################
#                 Histos                        #
##########################################################


######## Histograms for depression network
#first set the values to be the volumes
fascicle_volumes_dep_network_sorted_by_overlap <- fascicle_volumes_dep

#set NAs to zero
fascicle_volumes_dep_network_sorted_by_overlap$non_zero_voxels_in_dep_map[is.na(fascicle_volumes_dep_network_sorted_by_overlap$non_zero_voxels_in_dep_map)] = 0

#sort based on overlap with depression depression map
fascicle_volumes_dep_network_sorted_by_overlap$fascicle <- factor(fascicle_volumes_dep_network_sorted_by_overlap$fascicle, levels = fascicle_volumes_dep_network_sorted_by_overlap$fascicle[order(fascicle_volumes_dep_network_sorted_by_overlap$non_zero_voxels_in_dep_map)])

#remove fascicles with cranial nerves
fascicle_volumes_dep_network_no_cranial_nerves <- fascicle_volumes_dep_network_sorted_by_overlap %>% filter(fascicle %in% fascicle_names_no_cranial_nerves)

plot_all_fascicle_volumes_dep_network_no_cranial_nerves <-ggplot(data = fascicle_volumes_dep_network_no_cranial_nerves, aes(x = fascicle, y=non_zero_voxels_in_dep_map))+
  ggtitle("Volume Overlap per Fascicle 3_09") + 
  geom_bar(stat="identity", fill="006300") +
  xlab("Fascicle") +
  ylab("Overlap with Depression Mask") +
  ylim(0,40000) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=14),
        axis.title.x = element_text(size=14),
        axis.title.y = element_text(size=14),
        axis.line = element_line(size=1),
        panel.background = element_rect(colour = "white", fill = "white"))
print(plot_all_fascicle_volumes_dep_network_no_cranial_nerves)


#figure out how many fascicles that is, then 
quartile <- round((dim(fascicle_volumes_dep_network_no_cranial_nerves)[1] / 4),0)

#sort all the fascicles by %overlap, in decreasing order (so highest overlap at the top), and then take the top 1-quartile
dep_network_names_top_quartile_no_cranial_nerves<- (fascicle_volumes_dep_network_no_cranial_nerves[order(fascicle_volumes_dep_network_no_cranial_nerves$non_zero_voxels_in_dep_map, decreasing = TRUE),])$fascicle[1:quartile] #n=19

dep_network_total_volume_top_quartile_no_cranial_nerves <-
sum(fascicle_volumes_dep_network_no_cranial_nerves$num_voxels_total[which(fascicle_volumes_dep_network_no_cranial_nerves$fascicle %in% dep_network_names_top_quartile_no_cranial_nerves_by_vol)])



#get a network that includes all of the fascicles NOT in dep 25% network
dep_network_names_bottom_3_quartiles_no_cranial_nerves_by_vol <- fascicle_volumes_dep_no_cranial_nerves$fascicle[!(fascicle_volumes_dep_no_cranial_nerves$fascicle %in% dep_network_names_top_quartile_no_cranial_nerves_by_vol)] #n=68

bottom_75_total_volume_no_cranial_nerves <-
sum(fascicle_volumes_dep_network_no_cranial_nerves$num_voxels_total[which(fascicle_volumes_dep_network_no_cranial_nerves$fascicle %in% dep_network_names_bottom_3_quartiles_no_cranial_nerves_by_vol)])

#### Calculate total volume in all non-cranial_nerve_network
total_volume_all_full_fascicles <- dep_network_total_volume_top_quartile_no_cranial_nerves + bottom_75_total_volume_no_cranial_nerves
#plot volumes within the depression network, and volumes outside of it

fascicles_dep_25_percent_for_plot_no_cranial_nerves <- fascicle_volumes_dep_sorted_by_overlap[(fascicle_volumes_dep_sorted_by_overlap$fascicle %in% dep_network_names_top_quartile_no_cranial_nerves_by_vol),]

plot_all_fascicles_r_and_l_sep_top_quartile_no_cranial_nerves <-ggplot(data = fascicles_dep_25_percent_for_plot_no_cranial_nerves, aes(x = fascicle, y=non_zero_voxels_in_dep_map)) + 
  geom_bar(stat="identity", fill="violet") +
  ggtitle("Volume per Fascicle Affected Dep net 3_09, top quartile") + 
  ylab("Volume in Depression Mask") +
  ylim(0,40000) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=14),
        axis.title.x = element_text(size=14),
        axis.title.y = element_text(size=14),
        axis.line = element_line(size=1),
        panel.background = element_rect(colour = "white", fill = "white"))
print(plot_all_fascicles_r_and_l_sep_top_quartile_no_cranial_nerves)

#bottom 3 quartiles
fascicles_dep_bottom_3_quartiles_for_plot_no_cranial_nerves<- fascicle_volumes_dep_sorted_by_overlap[(fascicle_volumes_dep_sorted_by_overlap$fascicle %in% dep_network_names_bottom_3_quartiles_no_cranial_nerves_by_vol),]

plot_all_fascicles_r_and_l_sep_bottom_3_quartiles_no_cranial_nerves <-ggplot(data = fascicles_dep_bottom_3_quartiles_for_plot_no_cranial_nerves, aes(x = fascicle, y=non_zero_voxels_in_dep_map)) + 
  geom_bar(stat="identity", fill="darkgreen") +
  ylab("Volume in Depression Mask") +
  ylim(0,40000) +
  ggtitle("Volume per Fascicle Affected Dep net 3_09, bottom three quartiles") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5),
        axis.line = element_line(size=1),
        panel.background = element_rect(colour = "white", fill = "white"))
print(plot_all_fascicles_r_and_l_sep_bottom_3_quartiles_no_cranial_nerves) #n=58, which is total 68 - 10 CNs



```


