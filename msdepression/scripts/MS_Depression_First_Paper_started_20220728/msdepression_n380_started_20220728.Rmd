---
title: "MS Depression Paper"
author: "Erica Baller"
date: '2022-07-28'
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(visreg)
library(lme4)
library(lmerTest)
library(ggplot2)
library(reshape2)
library(pwr)
library(mgcv)
library(boot)
#functions
source("~/BBL/msdepression/scripts/msdepression_functions.R")
```

## MS Depression

Welcome to the MS Depression Data, installment 1 analysis markdown! This project was designed to ask a relatively simple question - are patients with MS who are depressed more likely to have lesions in fascicles that connect areas previously associated with depression. The literature are sparse in this domain. It is very clear that depression occurs in up to 50% of patients with MS, and some studies have suggested that it relates to lesion burden. But to my knowledge there are no papers that evaluate how lesions disrupt white matter tracts that serve as the backbone for functional networks. Over the course of the next few chunks, I'll walk through our analysis. It combines imaging data from research grade scans acquired at 3T as part of a clinical protocol (T1 and T2 Flair), and clinical data from the electronic medical record.  

## R Markdown

Part 1: 
The first chunk here is reading in appropriate data frames and preprocessing. Two big data frames are read in. The first is the demographic, drug, lab info for the MS patients (from the DAC pull). The second is the data frame of fascicle proportion affected for people with good mimosa (# volume affected/total volume of fascicle). The most important preprocessing occurs in a series of mutate commands. These essentially add new columns to the data frame that can later be used. The thrust of these mutate commands is to define who has depression and who does not.

Of note, in prior iterations of this analysis, we did not consider psychiatric medications in determining group inclusion/exclusion. Turns out it makes a difference, as a lot of people on psychotropic medications were counted as "controls/healthy" in previous analyses. For these preliminary analysis, our inclusion/exclusion are more stringent. Of note, the graph below is irrespective of whether they had good/bad MIMoSA. As such, the MIMoSA subset is smaller. 

<img width="70%" src="/Users/eballer/BBL/msdepression/data/drugs_data/MS_Patient_Depression_Categorizations.png"/>

Inclusion criteria below:

Inclusion MS Criteria (dataframe read in here has already been filtered down using the exclusions below previously)
  1) Scanned under MS protocol (42K)
  2) MS Diagnosis (17K)
  3) Seen by MS doctor (16K)
  
Inclusion criteria for Depressed Group
  1) Have an ICD10 F3* code (in our sample, people have F32 (depressive episode), F33 (major depressive disorder), and F34 (Persistent mood [affective] disorders)) 
        - there are NO participants with bipolar disorder, manic episode, or unspecified mood/affective disorder)
        - while participants may have been diagnosed with F06.3 (Depressive disorder due to known physiological condition, with depressive features), they must ALSO have had an F3(2-4) condition
  2) Screened positive for depression on PHQ2 or PHQ9 at any point
  3) Prescribed antidepressant medications per NAMI website
        - https://www.nami.org/About-Mental-Illness/Treatments/Mental-Health-Medications
        
Inclusion criteria for Healthy Group
  1) No F* diagnoses
  2) At least 1 PHQ2 or PHQ9 with a documented 0
  3) Free of psychiatric medications per NAMI website

Exclusions
  If you received the MS protocol or had a diagnosis of MS but never actually saw an MS provider, we cannot be sure that the diagnosis of MS is truly valid, as it is hard to diagnose anyway.
  If you did not have a diagnosis of depression and never completed a PHQ2 or 9, and had no history of medications, we could not safely confirm nor deny the presence of depression. These subjects were excluded from future analyses. We could consider adding these to the healthy group maybe, but not too inclined to do that right now. 

Imaging exclusion
  We are currently only using people who had good MIMOSA (75 or 100). That severely limits our numbers, but that is okay! When we re-QC, we will probably get a lot more into this group.

Final N demographics 
  Depressed: 859 (232 unique)
  Super clean healthy: 604 (148 unique)
  
(unique, with good MIMoSA):

                         Healthy          Depressed             p      test
  n                                148            232                     
  Race (%)         Caucasian       108 ( 73.0)    173 ( 74.6)   0.821     
                   Non-caucasian    40 ( 27.0)     59 ( 25.4)             
  Sex (%)          Female          117 ( 79.1)    199 ( 85.8)   0.117     
                   Male             31 ( 20.9)     33 ( 14.2)             
  Age (mean (SD))                46.57 (12.66)  48.75 (11.75)   0.089     
  Depression (%)   1               148 (100.0)      0 (  0.0)  <0.001     
                   2                 0 (  0.0)    232 (100.0)             
  PHQ2 (mean (SD))                0.00 (0.00)    0.58 (1.53)   <0.001     
  PHQ9 (mean (SD))                0.00 (NA)     10.43 (9.02)       NA 
 

  
Networks

  A note on the "depression network." This network was made by Shan Siddiqi in Michael Fox's group by doing a conglomeration of TMS datasets, stroke datasets, Nature Human Behavior 2021 (https://www.nature.com/articles/s41562-021-01161-1). It is an unthresholded mask (he initially sent one where the unit is r, but then sent us one where unit is T). 
  Per Siddiqi's article: The location of each lesion or brain stimulation site (Fig. 2a–c, top panels) was mapped to an underlying brain circuit using a large normative connectome database (n=1000) and previously validated methods (Fig. 2a–c, bottom panels)5. The normative connectome was used to estimate connectivity of each lesion or stimulation site to every voxel in the brain. At each voxel, a Pearson r-value was computed for the correlation between depression score and lesion or stimulation site connectivity to that voxel (Fig. 2a–c, right panels), yielding a population-derived “circuit map” for each of the 14 datasets (Supplementary Figure 1). We generated a combined depression circuit map by taking the mean of all 14 circuit maps, weighted by the sample size of each dataset (Fig. 5a). Of note, lesions are expected to positively correlate with symptoms, whereas the inverse of tms sites and was (so connectivity in these areas was inverted)
  
  To use it, I thresholded the clusters (3.09), binarized it and then used it as an ROI and calculated, per fascicle, the proportion of the volume occupied by the fascicle that intersected with the depression mask to the whole volume of the fascicle. Most fascicles were either entirely overlapping or entirely outside the depression mask, though the range of overlap was anywhere from 1-30%. This required us to make some choices. We considered an option where the "depression mask" was anywhere that ever overlapped, and non-depression were areas where there was no overlap. We also looked at quartiles, and settled on the top 25% (top quartile), i.e. the top 25% of fascicles with the highest proportion of network overlap were considered in the depression network. Everything outside of that was considered "non_depression" network, or nondep_net. Cranial nerves are too small to reliably be assess with our method, and so they were removed from the analysis.In total, 77 fascicles were evaluated.
  
Depression top quartile, r&l separated
 [1] "SLF3_R"  "AF_R"    "AF_L"    "SLF2_R"  "CBT_R"   "FAT_R"   "CS_P_R"  "C_PHP_R" "MdLF_L"  "FAT_L"   "SLF2_L"  "MdLF_R"  "CBT_L"   "TR_P_L"  "TR_S_R" 
[16] "CPT_O_R" "TR_P_R"  "PAT_L"   "PAT_R"   "EMC_R"   "TR_S_L"  "CC"  

Notebook Overview

Analyses
  There are two main types of analyses I performed, t.tests (for example, to compare inside versus outside depression network) and linear models (for example, looking at the relationship of depression to each individual fascicle). With respect to T-tests, I assume unequal variance for all. For linear models, I look only at the first scan. The general pattern is to look at the total proportion of volume lost across fascicles, then within depression network, and within non depression network. Lastly, I look at overall mean lesion burden irrespective of location by counting the number of nonzero voxels in each individual's mimosa mask.

  
Results
  Depression group: 232 with depression, 148 healthy

```{r read_in_df_and_subset}
homedir <- "/Users/eballer/BBL/msdepression/"

data <- read.csv(paste0(homedir, "/data/drugs_data/parsable_msdepression.csv"), sep = ",", header = TRUE) #n=16830, only has people with MS ICD10 code G35 and seen by MS provider

columns_to_make_integer <- c("ACCESSION_NUM", "PAT_AGE_AT_EXAM","MRI_ENC_AGE","CURRENT_AGE","hemoglobin", "WBC","RBC","B12","FOLATE", "TSH", "RPR","CSFAPPEAR1","CSFAPPEAR4","CSFCOLOR1",       "CSFCOLOR4","CSFTUBE","CSFTUBE4","VitD","PHQ.2","PHQ.9")

##########################
### some preprocessing ###
##########################
#we need to keep scans from people seen by an MS provider (n = 17067) who have an MS diagnostic code (n=16,830)
#we make a bunch of columns from character to integer, binarize sex and race, and put date into a nice format YYYYMMDD, the %m%d%y indicates what it started out as

#goal is to keep people who were seen by 
 data_empi_acc_f_phq <- data %>% 
   mutate(across(.cols = columns_to_make_integer, .fns = as.integer)) %>%
   mutate(sex_binarized = ifelse(SEX == "MALE", 1, 2)) %>%
   mutate(osex = ordered(sex_binarized,levels = c(1,2), labels = c("Male","Female"))) %>%
   mutate(race_binarized = ifelse(RACE == "WHITE", 1, 2)) %>%
   mutate(orace = ordered(race_binarized,levels = c(1,2), labels = c("White","Non-white"))) %>%
   mutate(EXAM_DATE = as.Date(BEGIN_EXAM_DTTM, format = "%m/%d/%y")) %>% 
   mutate(EXAM_DATE = gsub(EXAM_DATE, pattern = "-", replacement = "")) %>%
   mutate(EMPI = as.factor(EMPI)) %>%
   mutate(On.Psych.Meds = ifelse(On.Psych.Meds == "True", 1, 0)) %>%
   mutate(On.Antidepressants = ifelse(On.Antidepressants == "True", 1, 0)) %>%
   mutate(Has.PHQ2 = ifelse(Has.PHQ2 == "True", 1, 0)) %>%
   mutate(Has.PHQ9 = ifelse(Has.PHQ9 == "True", 1, 0)) %>%
   mutate(Has.depdx = ifelse(grepl("F3", ICD10), 1, 0)) %>%
   mutate(PHQ.2_modsev_dep_sxs = ifelse((!is.na(PHQ.2) & PHQ.2 >= 3), 1, 0)) %>%
   mutate(PHQ.9_modsev_dep_sxs = ifelse((!is.na(PHQ.9) & PHQ.9 >= 10), 1, 0)) %>%
   mutate(PHQ.2_mild_dep_sxs = ifelse((!is.na(PHQ.2) & PHQ.2 > 0 & PHQ.2 < 3), 1, 0)) %>%
   mutate(PHQ.9_mild_dep_sxs = ifelse((!is.na(PHQ.9) & PHQ.9 > 0 & PHQ.9 < 10), 1, 0)) %>%
   mutate(PHQ.2_zero = ifelse((!is.na(PHQ.2) & PHQ.2 == 0), 1, 0)) %>%
   mutate(PHQ.9_zero = ifelse((!is.na(PHQ.9) & PHQ.9 == 0), 1, 0)) %>%
   mutate(dep_by_dx_phq = ifelse((Has.depdx | PHQ.2_modsev_dep_sxs | PHQ.9_modsev_dep_sxs),1,0)) %>%
   mutate(dep_by_dx_phq_antidep = ifelse((Has.depdx | On.Antidepressants | PHQ.2_modsev_dep_sxs | PHQ.9_modsev_dep_sxs),1,0)) %>%
   mutate(true_healthy = ifelse((!Has.depdx & !On.Psych.Meds & (PHQ.2_zero | PHQ.9_zero)), 1, 0)) %>%
   mutate(dep_by_dx_phq_meds_healthy_phq0_no_psych_meds = ifelse(dep_by_dx_phq_antidep | true_healthy, 1, 0)) %>%
   rowwise(ACCESSION_NUM) %>%
   mutate(depGroupVar =
            sum(c(dep_by_dx_phq_meds_healthy_phq0_no_psych_meds,dep_by_dx_phq_antidep))) %>%#you get an extra point if you are in the depression group, so the end result is dep = 2, healthy = 1, 0 for exclude
   ungroup()


##########################################################
#             Read in Fascicle info             #
##########################################################

fascicle_proportions <- read.csv(paste0(homedir, "/results/fascicle_volumes_all_subjects_roi_n2336.csv"), header = T, sep = ",") #n = 2336

#fascicle names are contained in all but the first 2 columns of the fascicle_proportions df
fascicle_names <- names(fascicle_proportions[3:dim(fascicle_proportions)[2]])
fascicle_names_no_cranial_nerves <- fascicle_names[grep("CN", fascicle_names, invert = TRUE)] #n=77
#write.table(fascicle_names,"/Users/eballer/BBL/msdepression/templates/dti/HCP_YA1065_tractography/fascicle_names.csv", row.names = F, quote = F, col.names = F)


########
#fascicle volumes in depression network
########

fascicle_volumes_dep <- read.csv(paste0(homedir, "results/streamline_volume_within_dep_network_3_09.csv"), header = T, sep = ",")

#add column to indicate whether does not meet criteria for inclusion in dep mask (0), any overlapping voxels (1), or >10% overlapping voxels (2)
fascicle_volumes_dep_network <- fascicle_volumes_dep %>%
  replace(is.na(.), 0) %>%
  mutate(inDepMask=case_when(prop_in_mask == 0 ~ 0, (prop_in_mask > 0 & prop_in_mask < 0.1) ~ 1, prop_in_mask >= 0.1 ~ 2))


#Write out the new network groupings to a file, will be used later
fascicle_names_dep_network_grouping <- paste0(homedir,  "/templates/dti/HCP_YA1065_tractography/fascicle_names_dep_network_grouping_3_09.csv")
write.table(fascicle_volumes_dep_network, file=fascicle_names_dep_network_grouping, sep = ",", col.names=T)#, row.names = F, quote = F, col.names = T)

#fascicle_names_nondep_network<- fascicle_volumes_dep_network$fascicle[which(fascicle_volumes_dep_network$inDepMask == 0)]


#fascicle_names_dep_network_all <- fascicle_volumes_dep_network$fascicle[which(fascicle_volumes_dep_network$inDepMask > 0)]
#fascicle_names_dep_network_all_no_cranial_nerves <- fascicle_names_dep_network_all[grep("CN", fascicle_names_dep_network_all, invert = TRUE)] 

#fascicle_names_dep_network_all <- fascicle_volumes_dep_network$fascicle[which(fascicle_volumes_dep_network$inDepMask == 1)]
#write.table(fascicle_names_dep_network_all,"/Users/eballer/BBL/msdepression/templates/dti/HCP_YA1065_tractography/fascicle_names_dep_network_all_3_09.csv", row.names = F, quote = F, col.names = F)


#fascicle_names_dep_network_10_percent <- fascicle_volumes_dep_network$fascicle[which(fascicle_volumes_dep_network$inDepMask == 2)] #n=15
#write.table(fascicle_names_dep_network_10_percent,"/Users/eballer/BBL/msdepression/templates/dti/HCP_YA1065_tractography/fascicle_names_dep_network_10_percent_3_09.csv", row.names = F, quote = F, col.names = F)
 
#fascicle_names_dep_network_5_percent <- fascicle_volumes_dep_network$fascicle[which(fascicle_volumes_dep_network$prop_in_mask >= 0.05)] #n=24

#fascicle_names_dep_network_15_percent <- fascicle_volumes_dep_network$fascicle[which(fascicle_volumes_dep_network$prop_in_mask >= 0.15)] #n=13

#fascicle_mapping, returns numerical mapping as well as names of tracts, and whether any overlap with depression network (anything above 1 is overlap), as well as whether the fascicle overlaps, and the proportion of overlap with yeo networks
fascicle_bundle_mapping <- get_fascicle_bundle_mapping_generic_dep_mask(dep_network_grouping_file = fascicle_names_dep_network_grouping)

##########################################################
#             Read in Lesion Volumes                     #
##########################################################

# contains the volume of lesioned voxels, i.e. a sum of all the areas of each individual's binary mask that are 1

lesion_volumes <- read.csv(paste0(homedir, "results/mimosa_binary_masks_hcp_space_20211026_n2336_volumes"), sep = ",", header = TRUE)

##########################################################
#             Merge with data_empi              #
##########################################################
df_demo_and_fascicles <- merge(data_empi_acc_f_phq, fascicle_proportions, by = c("EMPI", "EXAM_DATE")) #n = 2962
df_demo_and_fascicles <- merge(df_demo_and_fascicles, lesion_volumes, by = c("EMPI", "EXAM_DATE")) #n = 2962
```

```{r demographics}

#this will display a demographics table comparing age, race, sex between healthy and depressed groups, using the first presentation to treatment

make_demographics_table_ms(data_frame = data_empi_acc_f_phq)

df_unique_empi <- data_empi_acc_f_phq %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup() 

make_demographics_table_ms(data_frame = df_unique_empi)

df_just_healthy_and_depressed <- df_unique_empi %>% filter(depGroupVar != 0)

make_demographics_table_ms(data_frame = df_just_healthy_and_depressed)


#just people with good mimosa
df_good_mimosa <- df_demo_and_fascicles %>% filter(depGroupVar != 0)
make_demographics_table_ms(data_frame = df_good_mimosa)

df_good_mimosa_unique <- df_demo_and_fascicles %>% 
  filter(depGroupVar != 0) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup() 
make_demographics_table_ms(data_frame = df_good_mimosa_unique)
```
```{r compare_overall_volume_of_lesions_dep_vs_non_dep}

#separate out only people in depression group, and take first instance
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>% 
  filter(depGroupVar != 0)  %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()

dep_vs_healthy_t_test_lesion_volume <-  t.test(dep_and_healthy_groups_for_ICD_analysis$volume_of_mimosa_lesions[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$volume_of_mimosa_lesions[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #p=0.07

Diagnosis <- c("MS w/Depression", "MS No Depression")
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$volume_of_mimosa_lesions[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]),
           mean(dep_and_healthy_groups_for_ICD_analysis$volume_of_mimosa_lesions[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1]))

sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$volume_of_mimosa_lesions[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==2))),
           (sd(dep_and_healthy_groups_for_ICD_analysis$volume_of_mimosa_lesions[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==1))))

data <- data.frame(Diagnosis,value, sem)
#data$Fascicle <- pretty_names

# Grouped
barplot_lesion_volume <- ggplot(data, aes(x=reorder(Diagnosis, -value),fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", colour="black", width=0.8, size=1.5) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9), size=1.5) +
  scale_fill_manual(values = c("#cdcdcd", "#FFFFFF")) + #comment out if you want colored graph
  ggtitle(paste0("Volume of Mimosa Lesions by Diagnosis, p=", round(dep_vs_healthy_t_test_lesion_volume$p.value,3))) +
  ylab("Volume of Lesion") +
  theme(title = element_text(size=14),
        axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
        axis.title.y = element_text(size=20),
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        panel.background = element_rect(colour = "white", fill = "white"))# + #comment out if you want pretty 
#  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.52)) #comment out if you want colored graph
print(barplot_lesion_volume)

```

```{r visualize_depression_network}
##########################################################
#                 Histos                        #
##########################################################


######## Histograms for depression network
#sort based on overlap
fascicle_values_dep_sorted_by_overlap <- fascicle_volumes_dep
fascicle_values_dep_sorted_by_overlap$prop_in_mask[is.na(fascicle_values_dep_sorted_by_overlap$prop_in_mask)] = 0
fascicle_values_dep_sorted_by_overlap$fascicle <- factor(fascicle_values_dep_sorted_by_overlap$fascicle, levels = fascicle_values_dep_sorted_by_overlap$fascicle[order(fascicle_values_dep_sorted_by_overlap$prop_in_mask)])

#remove fascicles with cranial nerves
fascicles_r_and_l_sep_no_cranial_nerves <- fascicle_values_dep_sorted_by_overlap %>% filter(fascicle %in% fascicle_names_no_cranial_nerves)

plot_all_fascicles_r_and_l_sep_no_cranial_nerves <-ggplot(data = fascicles_r_and_l_sep_no_cranial_nerves, aes(x = fascicle, y=prop_in_mask))+
  ggtitle("Proportion of Volume Overlap per Fascicle 3_09") + 
  geom_bar(stat="identity") +
  xlab("Fascicle") +
  ylab("Overlap with Depression Mask") +
  ylim(0,0.4) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=14),
        axis.title.x = element_text(size=14),
        axis.title.y = element_text(size=14))
print(plot_all_fascicles_r_and_l_sep_no_cranial_nerves)


### remove all rows with cranial nerves in them
# of note, we do not have all cranial nerves represented, we only have, CNII (optic), III(oculomotor), V (trigeminal), VII(facial), VIII(vestibulocochlear)
fascicle_values_dep_no_cranial_nerves = fascicle_values_dep_sorted_by_overlap[(grep(pattern = "CN", x = fascicle_values_dep_sorted_by_overlap$fascicle, invert = TRUE)),]

#figure out how many fascicles that is, then 
quartile <- round((dim(fascicle_values_dep_no_cranial_nerves)[1] / 4),0)

#sort all the fascicles by %overlap, in decreasing order (so highest overlap at the top), and then take the top 1-quartile
dep_network_names_top_quartile_no_cranial_nerves<- (fascicle_values_dep_no_cranial_nerves[order(fascicle_values_dep_no_cranial_nerves$prop_in_mask, decreasing = TRUE),])$fascicle[1:quartile] #n=19

#get a network that includes all of the fascicles NOT in dep 25% network
dep_network_names_bottom_3_quartiles_no_cranial_nerves <- fascicle_values_dep_no_cranial_nerves$fascicle[!(fascicle_values_dep_no_cranial_nerves$fascicle %in% dep_network_names_top_quartile_no_cranial_nerves)] #n=68


#plot values within the depression network, and values outside of it

fascicles_dep_25_percent_for_plot_no_cranial_nerves <- fascicle_values_dep_sorted_by_overlap[(fascicle_values_dep_sorted_by_overlap$fascicle %in% dep_network_names_top_quartile_no_cranial_nerves),]

plot_all_fascicles_r_and_l_sep_top_quartile_no_cranial_nerves <-ggplot(data = fascicles_dep_25_percent_for_plot_no_cranial_nerves, aes(x = fascicle, y=prop_in_mask)) + 
  geom_bar(stat="identity") +
  ggtitle("Proportion of Volume per Fascicle Affected Dep net 3_09, top quartile") + 
  ylim(0,0.4) +
  ylab("Proportion in Depression Mask") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=14),
        axis.title.x = element_text(size=14),
        axis.title.y = element_text(size=14))
print(plot_all_fascicles_r_and_l_sep_top_quartile_no_cranial_nerves)

#bottom 3 quartiles
fascicles_dep_bottom_3_quartiles_for_plot_no_cranial_nerves <- fascicle_values_dep_sorted_by_overlap[(fascicle_values_dep_sorted_by_overlap$fascicle %in% dep_network_names_bottom_3_quartiles_no_cranial_nerves),]

plot_all_fascicles_r_and_l_sep_bottom_3_quartiles_no_cranial_nerves <-ggplot(data = fascicles_dep_bottom_3_quartiles_for_plot_no_cranial_nerves, aes(x = fascicle, y=prop_in_mask)) + 
  geom_bar(stat="identity") +
  ylab("Proportion in Depression Mask") +
  ggtitle("Proportion of Volume per Fascicle Affected Dep net 3_09, bottom three quartiles") + 
  ylim(0,0.4) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5))
print(plot_all_fascicles_r_and_l_sep_bottom_3_quartiles_no_cranial_nerves) #n=58, which is total 68 - 10 CNs


```

```{r proof_of_concept}

#this section creates histograms looking at the proportion of volume lost in each fascicle across subjects
#we recapitulate earlier work and show that higher volume loss with our method reflects regions previously known to have higher volume loss
#These findings suggest that the streamline filtering approach could be a reasonable approach for this analysis

data_empi_acc_f_phq_unique <- data_empi_acc_f_phq %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup() 

#have to pull out just the pieces I'm interested in
just_dep_and_empi <- subset(data_empi_acc_f_phq, select = c("EMPI", "depGroupVar"))
added_dep_to_fascicles <- unique(merge(just_dep_and_empi, fascicle_proportions, by = c("EMPI")))

melted_df <- melt(added_dep_to_fascicles, id.vars = c("EMPI", "EXAM_DATE", "depGroupVar"))

#exclude regions where there was no lesion at all
lesioned <- subset(melted_df, value > 0)

#only include people in healthy or depressed group
lesioned_dx <- subset(lesioned, depGroupVar != 0)

#separate out healthy and depressed
healthy <- subset(lesioned, depGroupVar == 1)
depressed <- subset(lesioned, depGroupVar == 2)

q<-ggplot(lesioned, aes(x=value, fill=depGroupVar)) + geom_histogram() + facet_wrap(~variable)
r<-ggplot(lesioned_dx, aes(x=value, fill=depGroupVar)) + geom_histogram() + facet_wrap(~variable)
r_color<-ggplot(lesioned_dx, aes(x=value, color=factor(depGroupVar))) + geom_histogram() + facet_wrap(~variable)
x<-ggplot(lesioned, aes(x=value)) + geom_histogram() + facet_wrap(~variable)
y<-ggplot(healthy, aes(x=value)) + geom_histogram() + facet_wrap(~variable)
z<-ggplot(depressed, aes(x=value)) + geom_histogram() + facet_wrap(~variable)

#print(q)
#print(r)
print(r_color)
#print(x)
#print(y)
#print(z)

###########################################################################################################
##### Looking at distribution of disease across fascicles across group and within healthy and depressed ###
###########################################################################################################

#### look at mean fascicle volume across participants and transpose
# drop exam date and empi, and transpose
fascicles_alone_df <- t(added_dep_to_fascicles[,!(colnames(added_dep_to_fascicles) %in% c("EMPI", "EXAM_DATE", "depGroupVar"))])
fascicle_names <- rownames(fascicles_alone_df)

#take row means
fascicles_alone_rowMeans <- data.frame(fascicle_names, rowMeans(fascicles_alone_df))
names(fascicles_alone_rowMeans) <- c("fascicle", "value")

#GET RID OF CRANIAL NERVES
fascicles_alone_rowMeans <- fascicles_alone_rowMeans %>% filter(fascicle %in% fascicle_names_no_cranial_nerves)

#sort based on overlap
fascicle_values_sorted_by_overlap <- fascicles_alone_rowMeans

#make this separate in case I want to use this distribution for ranking depressed and healthy networks. 
order_of_mean_values_overall <- fascicle_values_sorted_by_overlap$fascicle[order(fascicle_values_sorted_by_overlap$value)]

fascicle_values_sorted_by_overlap$fascicle <- factor(fascicle_values_sorted_by_overlap$fascicle, levels = fascicle_values_sorted_by_overlap$fascicle[order(fascicle_values_sorted_by_overlap$value)])


######## Histograms/bargraphs
#this histogram helps contextualize the number of streamlines with varying degrees of proportions affected
hist(x=fascicle_values_dep_sorted_by_overlap$prop_in_mask, main = "Histogram Affected Streamlines", xlab = "Proportion Volume per Fascicle Affected", breaks = 20)

sorted_ggplot<-ggplot(data = fascicle_values_sorted_by_overlap, aes(x = fascicle, y=value))+
  ggtitle("Proportion of Volume per Fascicle Affected") + 
  ylab("Proportion") + 
  geom_bar(stat="identity") +
  ylim(0,0.8) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=14),
        axis.title.x = element_text(size=14),
        axis.title.y = element_text(size=14))
print(sorted_ggplot)

######### 
#############
#### look at mean fascicle volume across healthy participants and transpose
#############

# drop exam date and empi, and transpose
healthy_group_fascicles <- added_dep_to_fascicles[(added_dep_to_fascicles$depGroupVar == 1),]
fascicles_alone_df <- t(healthy_group_fascicles[,!(colnames(healthy_group_fascicles) %in% c("EMPI", "EXAM_DATE", "depGroupVar"))])
fascicle_names <- rownames(fascicles_alone_df)

#take row means
fascicles_alone_rowMeans <- data.frame(fascicle_names, rowMeans(fascicles_alone_df))
names(fascicles_alone_rowMeans) <- c("fascicle", "value")

#GET RID OF CRANIAL NERVES
fascicles_alone_rowMeans <- fascicles_alone_rowMeans %>% filter(fascicle %in% fascicle_names_no_cranial_nerves)

#sort based on overlap
fascicle_values_sorted_by_overlap <- fascicles_alone_rowMeans

fascicle_values_sorted_by_overlap$fascicle <- factor(fascicle_values_sorted_by_overlap$fascicle, levels = fascicle_values_sorted_by_overlap$fascicle[order(fascicle_values_sorted_by_overlap$value)])



######## Histograms/bargraphs

# ordered by mean value overall
fascicle_values_sorted_by_overlap$fascicle <- factor(fascicle_values_sorted_by_overlap$fascicle, levels = order_of_mean_values_overall)
sorted_ggplot_healthy_ordered<-ggplot(data = fascicle_values_sorted_by_overlap, aes(x = fascicle, y=value))+
  ggtitle("Proportion of Volume per Fascicle Affected Ordered by mean values NonDepressed") + 
  geom_bar(stat="identity") +
  ylab("Proportion") +
  ylim(0,0.8) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=14),
        axis.title.x = element_text(size=14),
        axis.title.y = element_text(size=14))
print(sorted_ggplot_healthy_ordered)

###########
#### look at mean fascicle volume across depressed participants and transpose
###########
# drop exam date and empi, and transpose
depressed_group_fascicles <- added_dep_to_fascicles[(added_dep_to_fascicles$depGroupVar == 2),]
fascicles_alone_df <- t(depressed_group_fascicles[,!(colnames(depressed_group_fascicles) %in% c("EMPI", "EXAM_DATE", "depGroupVar"))])
fascicle_names <- rownames(fascicles_alone_df)

#take row means
fascicles_alone_rowMeans <- data.frame(fascicle_names, rowMeans(fascicles_alone_df))
names(fascicles_alone_rowMeans) <- c("fascicle", "value")

#GET RID OF CRANIAL NERVES
fascicles_alone_rowMeans <- fascicles_alone_rowMeans %>% filter(fascicle %in% fascicle_names_no_cranial_nerves)

#sort based on overlap
fascicle_values_sorted_by_overlap <- fascicles_alone_rowMeans

fascicle_values_sorted_by_overlap$fascicle <- factor(fascicle_values_sorted_by_overlap$fascicle, levels = fascicle_values_sorted_by_overlap$fascicle[order(fascicle_values_sorted_by_overlap$value)])



######## Histograms/bargraphs

# ordered by mean value overall
fascicle_values_sorted_by_overlap$fascicle <- factor(fascicle_values_sorted_by_overlap$fascicle, levels = order_of_mean_values_overall)
sorted_ggplot_depressed_ordered<-ggplot(data = fascicle_values_sorted_by_overlap, aes(x = fascicle, y=value))+
  ggtitle("Proportion of Volume per Fascicle Affected Ordered by mean values Depressed") + 
  ylab("Proportion Affected") +
  geom_bar(stat="identity") +
  ylim(0,0.8) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=14),
        axis.title.x = element_text(size=14),
        axis.title.y = element_text(size=14))
print(sorted_ggplot_depressed_ordered)

##### look at mean fascicles affected in dep vs non dep network
######
#plot values within the depression network, and values outside of it

fascicles_dep_25_percent_for_plot <- fascicle_values_sorted_by_overlap[(fascicle_values_sorted_by_overlap$fascicle %in% dep_network_names_top_quartile_no_cranial_nerves),]

plot_all_fascicles_r_and_l_sep_top_quartile <-ggplot(data = fascicles_dep_25_percent_for_plot, aes(x = fascicle, y=value))+
  ggtitle("Proportion of Volume per Fascicle Affected Dep net, top quartile") + 
  geom_bar(stat="identity") +
  ylab("Proportion") +
  ylim(0,0.8) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=14),
        axis.title.x = element_text(size=14),
        axis.title.y = element_text(size=14))
print(plot_all_fascicles_r_and_l_sep_top_quartile)

#bottom 3 quartiles
fascicles_dep_bottom_3_quartiles_for_plot <- fascicle_values_sorted_by_overlap[(fascicle_values_sorted_by_overlap$fascicle %in% dep_network_names_bottom_3_quartiles_no_cranial_nerves),]

plot_all_fascicles_r_and_l_sep_bottom_3_quartiles <-ggplot(data = fascicles_dep_bottom_3_quartiles_for_plot, aes(x = fascicle, y=value))+
  ggtitle("Proportion of Volume per Fascicle Affected, bottom three quartiles") + 
  ylab("Proportion") +
  geom_bar(stat="identity") +
  ylim(0,0.8) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        plot.title = element_text(hjust = 0.5, size=14),
        axis.title.x = element_text(size=14),
        axis.title.y = element_text(size=14))
print(plot_all_fascicles_r_and_l_sep_bottom_3_quartiles)


```

```{r depression_vs_healthy_overall_proportion_of_fascicles_affected}

#goal of this segment is to look at overall lesion burden between depression and controls, outside of fascicles
#I'll read in the volume of each fascicle, and multiply it by the proportion of volume loss in each subject, thereby returing the volume of the fascicle affected


#isolate out only the depressed group and healthy group, make a column that sums up the total volume loss, only pay attention to places without cranial nerves
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>% 
  filter(depGroupVar != 0)  %>% 
  mutate(total_fascicle_prop_lost = rowMeans(across(fascicle_names_no_cranial_nerves))) %>%
  mutate(total_fascicle_prop_lost_indepnet_top_quartile = 
           rowMeans(across(dep_network_names_top_quartile_no_cranial_nerves))) %>%
  mutate(total_fascicle_prop_lost_nondep_bottom_3_quartiles = 
           rowMeans(across(dep_network_names_bottom_3_quartiles_no_cranial_nerves))) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()

#test whether proportion lost overall different between depressed and healthy- No, p = 0.050, Dep = 31%, Non dep = 27%
total_prop_lost_dep_vs_healthy_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 33%, mean non_dep = 28%, p = 0.054

#look at within depression network using top quartiles, yes p = 0.047, Dep = 32%, non dep = 26%
total_prop_lost_dep_vs_healthy_unique_in_dep_network_top_quartile <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) 


#look at bottom 75%, no p = 0.057, dep = 30%, non dep = 27%
total_prop_lost_dep_vs_healthy_unique_in_bottom_3_quartiles <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_bottom_3_quartiles[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_bottom_3_quartiles[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 30%, mean non_dep = 27%, p = 0.057


############
#bar plot
############

#over all fascicles
Diagnosis <- c("MS w/Depression", "MS No Depression")
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]),
           mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1]))

sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==2))),
           (sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==1))))

data <- data.frame(Diagnosis,value, sem)
barplot_overall <- ggplot(data, aes(x=reorder(Diagnosis, -value),fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", colour="black", width=0.8, size=1.5) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9), size=1.5) +
  scale_fill_manual(values = c("#cdcdcd", "#FFFFFF")) + #comment out if you want colored graph
  ylab("Mean Proportion of Fascicles Affected") +
  ggtitle(paste0("Total Proportion Affected by dx, p=", round(total_prop_lost_dep_vs_healthy_unique$p.value,3))) + 
  theme(axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
        axis.title.y = element_text(size=20),
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        plot.title = element_text(hjust=0.5, size = 14), 
        panel.background = element_rect(colour = "white", fill = "white")) + #comment out if you want pretty 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.52)) #comment out if you want colored graph

print(barplot_overall)



#in top quartile

Diagnosis <- c("MS w/Depression", "MS No Depression")
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]),
           mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1]))

sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==2))),
           (sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==1))))

data <- data.frame(Diagnosis,value, sem)

# Grouped

barplot_top_quartile <- ggplot(data, aes(x=reorder(Diagnosis, -value),fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", colour="black", width=0.8, size=1.5) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9), size=1.5) +
  scale_fill_manual(values = c("#cdcdcd", "#FFFFFF")) + #comment out if you want colored graph
  ylab("Mean proportion of Fascicles Affected") +
    ggtitle(paste0("Total Propotion Affected by dx in Dep 25%, p=", round(total_prop_lost_dep_vs_healthy_unique_in_dep_network_top_quartile$p.value,3))) + 
  theme(axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
        axis.title.y = element_text(size=20),
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        plot.title = element_text(hjust=0.5, size = 14), 
        panel.background = element_rect(colour = "white", fill = "white")) + #comment out if you want pretty 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.52)) 
print(barplot_top_quartile)

#in bottom 3 quartiles
Diagnosis <- c("MS w/Depression", "MS No Depression")
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_bottom_3_quartiles[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]),
           mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_bottom_3_quartiles[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1]))

sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_bottom_3_quartiles[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==2))),
           (sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_prop_lost_nondep_bottom_3_quartiles[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==1))))

data <- data.frame(Diagnosis,value, sem)

# Grouped

barplot_bottom_3_quartiles <- ggplot(data, aes(x=reorder(Diagnosis, -value),fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", colour="black", width=0.8, size=1.5) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9), size=1.5) +
  scale_fill_manual(values = c("#cdcdcd", "#FFFFFF")) + #comment out if you want colored graph
  ylab("Mean Proportion of Fascicles Affected") +
    ggtitle(paste0("Total Proportion Affected by dx, Bottom 75% p=", round(total_prop_lost_dep_vs_healthy_unique_in_bottom_3_quartiles$p.value,3))) + 
  theme(axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
        axis.title.y = element_text(size=20),
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        plot.title = element_text(hjust=0.5, size = 14), 
        panel.background = element_rect(colour = "white", fill = "white")) + #comment out if you want pretty 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 0.52)) 

print(barplot_bottom_3_quartiles)

```

```{r depression_vs_healthy_overall_volume_of_fascicles_affected}

#goal of this segment is to look at overall lesion burden between depression and controls, outside of fascicles
#I'll read in the volume of each fascicle, and multiply it by the proportion of volume loss in each subject, thereby returing the volume of the fascicle affected

#read in fiber volume values
fiber_volume_values <- read.csv(paste0(homedir, "templates/dti/HCP_YA1065_tractography/fiber_volume_values.csv"), sep=",", header = T)

#extract data frame that only includes the fascicle proportion lost
df_fascicles_only <- df_demo_and_fascicles[ , (names(df_demo_and_fascicles) %in% fascicle_names)]
df_everything_else <- df_demo_and_fascicles[ , !(names(df_demo_and_fascicles) %in% fascicle_names)]

#multiply each row by the vector of total volumes
df_fascicle_volumes <- sweep(x = df_fascicles_only, MARGIN = 2,                        # Sweep with Complex STATS
                  STATS = fiber_volume_values$volume_full, FUN = "*")

#combine back with data_fram
df_demo_and_fascicle_volumes_full <- cbind(df_everything_else, df_fascicle_volumes)

#isolate out only the depressed group and healthy group, make a column that sums up the total volume loss, only pay attention to places without cranial nerves
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicle_volumes_full %>% 
  filter(depGroupVar != 0)  %>% 
  mutate(total_fascicle_vol_lost = rowMeans(across(fascicle_names_no_cranial_nerves))) %>%
  mutate(total_fascicle_vol_lost_indepnet_top_quartile = 
           rowMeans(across(dep_network_names_top_quartile_no_cranial_nerves))) %>%
  mutate(total_fascicle_vol_lost_nondep_bottom_3_quartiles = 
           rowMeans(across(dep_network_names_bottom_3_quartiles_no_cranial_nerves))) %>%
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()

#test whether volortion lost overall different between depressed and healthy- Yes, p = 0.045, Dep = 9382, Non dep = 8260
total_volume_lost_dep_vs_healthy_unique <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 33%, mean non_dep = 28%, p = 0.054

#look at within depression network using top quartiles, yes p = 0.034, Dep = 4829, non dep = 3914
total_volume_lost_dep_vs_healthy_unique_in_dep_network_top_quartile <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) 


#look at bottom 75%, no p = 0.054, dep = 8826, non dep = 7886
total_volume_lost_dep_vs_healthy_unique_in_bottom_3_quartiles <- t.test(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_nondep_bottom_3_quartiles[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_nondep_bottom_3_quartiles[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], var.equal = F) #mean dep = 30%, mean non_dep = 27%, p = 0.057


############
#bar plot
############

#over all fascicles
Diagnosis <- c("MS w/Depression", "MS No Depression")
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]),
           mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1]))

sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==2))),
           (sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==1))))

data <- data.frame(Diagnosis,value, sem)
barplot_overall <- ggplot(data, aes(x=reorder(Diagnosis, -value),fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", colour="black", width=0.8, size=1.5) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9), size=1.5) +
  scale_fill_manual(values = c("#cdcdcd", "#FFFFFF")) + #comment out if you want colored graph
  ylab("Mean volume of Fascicles Affected") +
  ggtitle(paste0("Total Volume Affected by dx, p=", round(total_volume_lost_dep_vs_healthy_unique$p.value,3))) + 
  theme(axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
        axis.title.y = element_text(size=20),
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        plot.title = element_text(hjust=0.5, size = 14), 
        panel.background = element_rect(colour = "white", fill = "white")) + #comment out if you want pretty 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 10000)) #comment out if you want colored graph

print(barplot_overall)



#in top quartile

Diagnosis <- c("MS w/Depression", "MS No Depression")
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]),
           mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1]))

sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==2))),
           (sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_indepnet_top_quartile[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==1))))

data <- data.frame(Diagnosis,value, sem)

# Grouped

barplot_top_quartile <- ggplot(data, aes(x=reorder(Diagnosis, -value),fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", colour="black", width=0.8, size=1.5) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9), size=1.5) +
  scale_fill_manual(values = c("#cdcdcd", "#FFFFFF")) + #comment out if you want colored graph
  ylab("Mean volume of Fascicles Affected") +
    ggtitle(paste0("Total Volume Affected by dx in Dep 25%, p=", round(total_volume_lost_dep_vs_healthy_unique_in_dep_network_top_quartile$p.value,3))) + 
  theme(axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
        axis.title.y = element_text(size=20),
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        plot.title = element_text(hjust=0.5, size = 14), 
        panel.background = element_rect(colour = "white", fill = "white")) + #comment out if you want pretty 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 10000)) 
print(barplot_top_quartile)

#in bottom 3 quartiles
Diagnosis <- c("MS w/Depression", "MS No Depression")
value <- c(mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_nondep_bottom_3_quartiles[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2]),
           mean(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_nondep_bottom_3_quartiles[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1]))

sem <- c((sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_nondep_bottom_3_quartiles[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==2))),
           (sd(dep_and_healthy_groups_for_ICD_analysis$total_fascicle_vol_lost_nondep_bottom_3_quartiles[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1])/sqrt(sum(dep_and_healthy_groups_for_ICD_analysis$depGroupVar ==1))))

data <- data.frame(Diagnosis,value, sem)

# Grouped

barplot_bottom_3_quartiles <- ggplot(data, aes(x=reorder(Diagnosis, -value),fill=Diagnosis, y=value)) + 
  geom_bar(stat="identity", colour="black", width=0.8, size=1.5) + 
    geom_errorbar(aes(ymin=value-sem, ymax=value+sem), width=.1, position=position_dodge(0.9), size=1.5) +
  scale_fill_manual(values = c("#cdcdcd", "#FFFFFF")) + #comment out if you want colored graph
  ylab("Mean volume of Fascicles Affected") +
    ggtitle(paste0("Total Volume Affected by dx, Bottom 75% p=", round(total_volume_lost_dep_vs_healthy_unique_in_bottom_3_quartiles$p.value,3))) + 
  theme(axis.text = element_text(size = 14, colour = "black"), axis.title.x = element_blank(), 
        axis.title.y = element_text(size=20),
        axis.line = element_line(size = 1.5, colour = "black", linetype=1),
        plot.title = element_text(hjust=0.5, size = 14), 
        panel.background = element_rect(colour = "white", fill = "white")) + #comment out if you want pretty 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 10000)) 

print(barplot_bottom_3_quartiles)

```

```{r comparing_depression_map_overlap_with_dx_diff_no_cranial_nerves_prop}
# the purpose of this chunk is to plot the relationship of the degree of overlap of a depression network with the diagnostic difference between groups

##############################
## FASCICLES TO BE INCLUDED ##
##############################

#define the depression network (all areas that intersect with depression network, no cranial nerves)
fascicle_proportions <- read.csv(paste0(homedir, "/results/fascicle_volumes_all_subjects_roi_n2336.csv"), header = T, sep = ",") #n = 2336

#fascicle names are contained in all but the first 2 columns of the fascicle_proportions df
fascicle_names <- names(fascicle_proportions[3:dim(fascicle_proportions)[2]])
fascicle_names_no_cranial_nerves <- fascicle_names[grep("CN", fascicle_names, invert = TRUE)] #n=77

#######################
### depression map  ###
#######################

### define depression map
fascicle_volumes_and_props_dep <- read.csv(paste0(homedir, "results/streamline_volume_within_dep_network_3_09.csv"), header = T, sep = ",")

#filter to exclude fascicles w/cranial nerves
fascicle_volumes_dep_network_no_cranial_nerves <- fascicle_volumes_and_props_dep %>%
  replace(is.na(.), 0) %>%
  filter(fascicle%in% fascicle_names_no_cranial_nerves)

#make data frame that includes each fascicle in 1 column, and each proportion of overlap with depression network in second column

df_fascicle_and_prop_in_mask <- subset(x = fascicle_volumes_dep_network_no_cranial_nerves, select = c("fascicle", "prop_in_mask"))

#######################
### real data x dx  ###
#######################

#then, make the data frame
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicles %>% 
  filter(depGroupVar != 0)  %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()


# lapply to get results of t-test in each fascicle
#ldepGroup 2 is depressed group, Dep group 1 is healthy group. Positive Ts are places where depressed people have more disease than controls
fascicle_dep_vs_healthy_t <- lapply(fascicle_names_no_cranial_nerves, function(x) 
{
  t_test_command <- paste0("t.test(dep_and_healthy_groups_for_ICD_analysis$", x, "[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], dep_and_healthy_groups_for_ICD_analysis$", x, "[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], var.equal=F)")
  eval(parse(text=t_test_command))
})
names(fascicle_dep_vs_healthy_t) <- fascicle_names_no_cranial_nerves

#pull t-statistic
dep_vs_healthy_t_values <- sapply(fascicle_dep_vs_healthy_t, function(x) x$statistic)

#convert to data frame
df_t_values <- as.data.frame(dep_vs_healthy_t_values) 
row.names(df_t_values) <- fascicle_names_no_cranial_nerves
  
#pull p-values
dep_vs_healthy_p_values <- sapply(fascicle_dep_vs_healthy_t, function(x) x$p.value)

#convert to data frame
df_dep_vs_healthy_p_values <- as.data.frame(dep_vs_healthy_p_values)
row.names(df_dep_vs_healthy_p_values) <- fascicle_names_no_cranial_nerves

#FDR correct p-values
dep_vs_healthy_pfdr <- p.adjust(dep_vs_healthy_p_values,method="fdr")
  
#Convert to data frame
df_dep_vs_healthy_pfdr <- as.data.frame(dep_vs_healthy_pfdr)
row.names(df_dep_vs_healthy_pfdr) <- fascicle_names_no_cranial_nerves

#######################
### plot differences ##
#######################

#combine data frames, column 1 has names of fascicles, column 2 has proportion of overlap with depression network, column 3 has t-test value of dep vs healthy unc, 4th dep vs healthy fdr corrected within that fascicle

df_fascicle_dep_mask_overlap_t_value <- data.frame(df_fascicle_and_prop_in_mask$fascicle, df_fascicle_and_prop_in_mask$prop_in_mask, df_t_values$dep_vs_healthy_t_values)
names(df_fascicle_dep_mask_overlap_t_value) <- c("fascicle", "depression_mask_overlap", "dep_vs_healthy_t")

#make copy to sort
df_fascicle_dep_mask_overlap_t_value_sorted_by_prop_overlap_depression_mask <- df_fascicle_dep_mask_overlap_t_value

df_fascicle_dep_mask_overlap_t_value_sorted_by_prop_overlap_depression_mask$fascicle  <- factor(df_fascicle_dep_mask_overlap_t_value_sorted_by_prop_overlap_depression_mask$fascicle, levels = df_fascicle_dep_mask_overlap_t_value_sorted_by_prop_overlap_depression_mask$fascicle[order(df_fascicle_dep_mask_overlap_t_value_sorted_by_prop_overlap_depression_mask$depression_mask_overlap)])


# bar graph of T-values of fascicles, sorted by depression overlap
plot_fascicle_by_t_sorted_by_dep_overlap <-ggplot(data = df_fascicle_dep_mask_overlap_t_value_sorted_by_prop_overlap_depression_mask, aes(x = fascicle, y=dep_vs_healthy_t), main = "Dep vs Healthy T value, Fascicles ordered by overlap with dep network") + 
  geom_bar(stat="identity") +
  ylim(0,5) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
print(plot_fascicle_by_t_sorted_by_dep_overlap)


# plot fascicle overlap x t value
#statistic, p = 0.010
dep_overlap_x_dep_vs_healthy_t <- lm(dep_vs_healthy_t ~ depression_mask_overlap, data=df_fascicle_dep_mask_overlap_t_value)
print(summary(dep_overlap_x_dep_vs_healthy_t))

scatter_t_val_by_dep_net_overlap <- ggplot(data=df_fascicle_dep_mask_overlap_t_value, aes(x=depression_mask_overlap, y=dep_vs_healthy_t)) +
  geom_point(size=1) + 
  geom_smooth(method=lm)+
  xlab("Proportion of Fascicle in Depression Network") + 
  ylab("Effect of diagnosis calculated in proportions (T)") + 
  ggtitle(paste0("Fascicle/depression mask Proportion overlap by dx T, p = ", round(summary(dep_overlap_x_dep_vs_healthy_t)$coefficients[2,4],3))) + 
  theme(plot.title=element_text(hjust=0.5))
print(scatter_t_val_by_dep_net_overlap)

```


```{r comparing_depression_map_overlap_with_dx_diff_no_cranial_nerves_volume}

#define the depression network (all areas that intersect with depression network, no cranial nerves)
fascicle_proportions <- read.csv(paste0(homedir, "/results/fascicle_volumes_all_subjects_roi_n2336.csv"), header = T, sep = ",") #n = 2336

#fascicle names are contained in all but the first 2 columns of the fascicle_proportions df
fascicle_names <- names(fascicle_proportions[3:dim(fascicle_proportions)[2]])
fascicle_names_no_cranial_nerves <- fascicle_names[grep("CN", fascicle_names, invert = TRUE)] #n=77

#######################
### depression map  ###
#######################

### define depression map
fascicle_volumes_and_props_dep <- read.csv(paste0(homedir, "results/streamline_volume_within_dep_network_3_09.csv"), header = T, sep = ",")

#filter to exclude fascicles w/cranial nerves
fascicle_volumes_dep_network_no_cranial_nerves <- fascicle_volumes_and_props_dep %>%
  replace(is.na(.), 0) %>%
  filter(fascicle%in% fascicle_names_no_cranial_nerves)

df_fascicle_and_volume_in_mask <- subset(x = fascicle_volumes_dep_network_no_cranial_nerves, select = c("fascicle", "non_zero_voxels_in_dep_map"))

########################
## Get Volume Values ###
########################

#read in fiber volume values
fiber_volume_values <- read.csv(paste0(homedir, "templates/dti/HCP_YA1065_tractography/fiber_volume_values.csv"), sep=",", header = T)

#extract data frame that only includes the fascicle proportion lost
df_fascicles_only <- df_demo_and_fascicles[ , (names(df_demo_and_fascicles) %in% fascicle_names)]
df_everything_else <- df_demo_and_fascicles[ , !(names(df_demo_and_fascicles) %in% fascicle_names)]

#multiply each row by the vector of total volumes
df_fascicle_volumes <- sweep(x = df_fascicles_only, MARGIN = 2,                        # Sweep with Complex STATS
                  STATS = fiber_volume_values$volume_full, FUN = "*")

#combine back with data_fram
df_demo_and_fascicle_volumes_full <- cbind(df_everything_else, df_fascicle_volumes)

#isolate out only the depressed group and healthy group, fascicles should be in volumes rather than proportions
dep_and_healthy_groups_for_ICD_analysis <- df_demo_and_fascicle_volumes_full %>% 
  filter(depGroupVar != 0)  %>% 
  group_by(EMPI) %>% 
  arrange(EXAM_DATE) %>% 
  slice(1) %>% 
  ungroup()

# lapply to get results of t-test in each fascicle
#ldepGroup 2 is depressed group, Dep group 1 is healthy group. Positive Ts are places where depressed people have more disease than controls
fascicle_dep_vs_healthy_t <- lapply(fascicle_names_no_cranial_nerves, function(x) 
{
  t_test_command <- paste0("t.test(dep_and_healthy_groups_for_ICD_analysis$", x, "[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 2], dep_and_healthy_groups_for_ICD_analysis$", x, "[dep_and_healthy_groups_for_ICD_analysis$depGroupVar == 1], var.equal=F)")
  eval(parse(text=t_test_command))
})
names(fascicle_dep_vs_healthy_t) <- fascicle_names_no_cranial_nerves

#pull t-statistic
dep_vs_healthy_t_values <- sapply(fascicle_dep_vs_healthy_t, function(x) x$statistic)

#convert to data frame
df_t_values <- as.data.frame(dep_vs_healthy_t_values) 
row.names(df_t_values) <- fascicle_names_no_cranial_nerves
  
#pull p-values
dep_vs_healthy_p_values <- sapply(fascicle_dep_vs_healthy_t, function(x) x$p.value)

#convert to data frame
df_dep_vs_healthy_p_values <- as.data.frame(dep_vs_healthy_p_values)
row.names(df_dep_vs_healthy_p_values) <- fascicle_names_no_cranial_nerves

#FDR correct p-values
dep_vs_healthy_pfdr <- p.adjust(dep_vs_healthy_p_values,method="fdr")
  
#Convert to data frame
df_dep_vs_healthy_pfdr <- as.data.frame(dep_vs_healthy_pfdr)
row.names(df_dep_vs_healthy_pfdr) <- fascicle_names_no_cranial_nerves

#######################
### plot differences ##
#######################

#combine data frames, column 1 has names of fascicles, column 2 has proportion of overlap with depression network, column 3 has t-test value of dep vs healthy unc, 4th dep vs healthy fdr corrected within that fascicle

df_fascicle_dep_mask_volume_t_value <- data.frame(df_fascicle_and_prop_in_mask$fascicle, df_t_values$dep_vs_healthy_t_values, df_fascicle_and_volume_in_mask$non_zero_voxels_in_dep_map)
names(df_fascicle_dep_mask_volume_t_value) <- c("fascicle", "dep_vs_healthy_t", "volume_in_dep_mask")

df_fascicle_dep_mask_overlap_t_value_sorted_by_vol_in_depression_mask <- df_fascicle_dep_mask_volume_t_value

#order by volume in depression mask
df_fascicle_dep_mask_overlap_t_value_sorted_by_vol_in_depression_mask$fascicle  <- factor(df_fascicle_dep_mask_overlap_t_value_sorted_by_vol_in_depression_mask$fascicle, levels = df_fascicle_dep_mask_overlap_t_value_sorted_by_vol_in_depression_mask$fascicle[order(df_fascicle_dep_mask_overlap_t_value_sorted_by_vol_in_depression_mask$volume_in_dep_mask)])


# bar graph of T-values of fascicles, sorted by depression overlap
plot_fascicle_by_t_sorted_by_dep_overlap <-ggplot(data = df_fascicle_dep_mask_overlap_t_value_sorted_by_vol_in_depression_mask, aes(x = fascicle, y=dep_vs_healthy_t), main = "Dep vs Healthy T value, Fascicles ordered by volume of dep network") + 
  geom_bar(stat="identity") +
  ylim(0,5) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
print(plot_fascicle_by_t_sorted_by_dep_overlap)


#statistic volume, p = 0.031
dep_overlap_x_dep_vs_healthy_t <- lm(dep_vs_healthy_t ~ volume_in_dep_mask, data=df_fascicle_dep_mask_volume_t_value)
print(summary(dep_overlap_x_dep_vs_healthy_t))

scatter_t_val_by_dep_net_overlap <- ggplot(data=df_fascicle_dep_mask_volume_t_value, aes(x=volume_in_dep_mask, y=dep_vs_healthy_t)) +
  geom_point(size=1) + 
  geom_smooth(method=lm)+
  xlab("Volume of Fascicle in Depression Network") + 
  ylab("Effect of diagnosis (T)") + 
  ggtitle(paste0("Fascicle/depression mask volume by dx T, p = ", round(summary(dep_overlap_x_dep_vs_healthy_t)$coefficients[2,4],3))) + 
  theme(plot.title=element_text(hjust=0.5))
print(scatter_t_val_by_dep_net_overlap)

```

```{r bootstrapping_proportion_and_volume_x_dep_t_analyses}

##### proportion
# 95% confidence intervals for the correlation
set.seed(1)
tval <- function(formula, data, indices) {
  d <- data[indices,] # allows boot to select sample
  fit <- lm(formula, data=d)
  return(summary(fit)$coefficients[2,3])
}

data_frame_dep_v_nondep_t_x_prop_dep_mask_overlap <- subset(df_fascicle_dep_mask_overlap_t_value, select = c("depression_mask_overlap","dep_vs_healthy_t"))
results_prop <- boot(data=data_frame_dep_v_nondep_t_x_prop_dep_mask_overlap, statistic=tval,
   R=10000, formula=dep_vs_healthy_t~depression_mask_overlap)
print(results_prop) #actual 2.62, CI 0.701, 4.553)
plot(results_prop)
boot_results_prop.ci <- boot.ci(results_prop, conf=0.95, type="bca", index=1)
print(boot_results_prop.ci)

#manually calculating P from CI, from interwebs
est=results_prop$t0
l=boot_results_prop.ci$bca[4]
u=boot_results_prop.ci$bca[5]

#1) SE=(u-l)/2*1.96
se=((u-l)/(2*1.96))
#2) z=Est/SE
z=est/se
#3) p=exp(-0.717*z - 0.416*z^2)
p=exp((-0.717*z) - (0.416*(z*z)))
print(p)

##### volume
# 95% confidence intervals for the correlation
set.seed(1)
data_frame_dep_v_nondep_t_x_vol_dep_mask <- subset(df_fascicle_dep_mask_volume_t_value, select = c("dep_vs_healthy_t", "volume_in_dep_mask"))

results_vol <- boot(data=data_frame_dep_v_nondep_t_x_vol_dep_mask, statistic=tval,
   R=10000, formula=dep_vs_healthy_t~volume_in_dep_mask)
print(results_vol)
plot(results_vol)
boot_results_vol.ci <- boot.ci(results_vol, conf=0.95, type="bca", index=1)
print(boot_results_vol.ci)

#get p from CI
#manually calculating P from CI, from interwebs
est=results_vol$t0
l=boot_results_vol.ci$bca[4]
u=boot_results_vol.ci$bca[5]

#1) SE=(u-l)/2*1.96
se=((u-l)/(2*1.96))
#2) z=Est/SE
z=est/se
#3) p=exp(-0.717*z - 0.416*z^2)
p=exp((-0.717*z) - (0.416*(z*z)))
print(p)

```


